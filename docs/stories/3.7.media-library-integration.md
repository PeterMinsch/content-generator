# Story 3.7: Integrate with WordPress Media Library

## Status

Draft

## Story

**As a** content manager,
**I want** to select images from the WordPress Media Library for image fields,
**so that** I can assign images to blocks without leaving the page

## Acceptance Criteria

1. Image fields display:
   - "Select Image" button when no image selected
   - Image preview thumbnail when image selected
   - "Change Image" and "Remove Image" buttons when image selected
2. Clicking "Select Image" opens WordPress Media Library modal
3. User can select existing image or upload new image
4. Selected image saves to ACF field (image ID)
5. Image preview shows after selection
6. "Remove Image" clears the field
7. Integration works for all image fields: hero_image, step_image, size_chart_image

## Tasks / Subtasks

- [ ] Task 1: Create MediaPicker component (AC: 1, 2, 5, 6)
  - [ ] Create `assets/js/src/components/common/MediaPicker.js`
  - [ ] Accept props: value (image ID), onChange, label
  - [ ] Manage local state for selected image data (ID, URL)
  - [ ] Render "Select Image" button when no image
  - [ ] Render image preview when image selected
  - [ ] Render "Change Image" and "Remove Image" buttons when selected
  - [ ] Implement onClick handler for Select/Change button

- [ ] Task 2: Integrate wp.media JavaScript API (AC: 2, 3)
  - [ ] Ensure wp.media is enqueued (it's part of WordPress media-upload script)
  - [ ] Create media frame using `wp.media()`
  - [ ] Configure frame options: title, button text, multiple: false
  - [ ] Listen for 'select' event on media frame
  - [ ] Extract selected image data (ID, URL, thumbnail)
  - [ ] Update component state with selected image

- [ ] Task 3: Fetch image data from Media Library (AC: 4, 5)
  - [ ] Create `fetchImageData(imageId)` function in api.js
  - [ ] Use `apiFetch` to get image data from WordPress REST API
  - [ ] Endpoint: `/wp/v2/media/{imageId}`
  - [ ] Extract thumbnail URL from response (media_details.sizes.thumbnail.source_url)
  - [ ] Return image object: { id, url, thumbnailUrl }

- [ ] Task 4: Load initial image data on component mount (AC: 5)
  - [ ] Use useEffect to fetch image data when component mounts
  - [ ] Only fetch if value (image ID) is provided
  - [ ] Display loading state while fetching
  - [ ] Update state with fetched image data
  - [ ] Handle error if image not found

- [ ] Task 5: Implement Remove Image functionality (AC: 6)
  - [ ] Add onClick handler for Remove button
  - [ ] Clear component state (set to null)
  - [ ] Call onChange(null) to update parent state
  - [ ] Return to "Select Image" button state

- [ ] Task 6: Update HeroBlock to use MediaPicker (AC: 7)
  - [ ] Import MediaPicker component
  - [ ] Replace placeholder image picker with MediaPicker
  - [ ] Pass hero_image value and onChange handler
  - [ ] Set label: "Hero Image"

- [ ] Task 7: Update ProcessBlock to use MediaPicker (AC: 7)
  - [ ] Add MediaPicker to process_steps repeater
  - [ ] Each step item should have step_image MediaPicker
  - [ ] Pass step_image value and onChange handler
  - [ ] Set label: "Step Image"

- [ ] Task 8: Update SizeFitBlock to use MediaPicker (AC: 7)
  - [ ] Import MediaPicker component
  - [ ] Replace placeholder for size_chart_image
  - [ ] Pass size_chart_image value and onChange handler
  - [ ] Set label: "Size Chart Image"

- [ ] Task 9: Enqueue WordPress media scripts (AC: 2)
  - [ ] Update `includes/Admin/PageEditor.php`
  - [ ] Call `wp_enqueue_media()` in enqueueScripts method
  - [ ] Ensure media scripts load before React app
  - [ ] Verify wp.media is available in window object

- [ ] Task 10: Style MediaPicker component (AC: 1, 5)
  - [ ] Update `assets/css/admin-blocks.css`
  - [ ] Style Select Image button (WordPress button styles)
  - [ ] Style image preview container
  - [ ] Style image thumbnail (max-width, max-height, border)
  - [ ] Style Change/Remove button group
  - [ ] Add hover states for buttons

- [ ] Task 11: Add loading state for image fetch (AC: 5)
  - [ ] Show loading spinner while fetching initial image data
  - [ ] Use WordPress Spinner component or custom spinner
  - [ ] Display placeholder while loading

- [ ] Task 12: Handle edge cases (AC: 4, 5, 6)
  - [ ] Handle invalid image ID (image deleted from library)
  - [ ] Handle network errors during image fetch
  - [ ] Show fallback message if image cannot be loaded
  - [ ] Prevent multiple simultaneous media library opens
  - [ ] Handle case where user closes media library without selecting

- [ ] Task 13: Add accessibility features
  - [ ] Add alt text to image preview
  - [ ] Add aria-label to buttons
  - [ ] Ensure keyboard navigation works
  - [ ] Add screen reader announcements for image selection/removal

## Dev Notes

### Relevant Architecture Context

**Tech Stack:**
- **Frontend Framework:** React 18.x with functional components and hooks
- **Asset Management:** WordPress Media Library built-in
- **WordPress Components:** @wordpress/components for UI elements
[Source: architecture.md#tech-stack]

**WordPress Media Library JavaScript API:**
WordPress provides `wp.media` API for opening the media library modal:
```javascript
// Open media library
const mediaFrame = wp.media({
  title: 'Select Image',
  button: {
    text: 'Use this image'
  },
  multiple: false  // Only allow single selection
});

// Listen for image selection
mediaFrame.on('select', function() {
  const attachment = mediaFrame.state().get('selection').first().toJSON();
  console.log('Selected image:', attachment);
  // attachment.id - Image ID to save to ACF
  // attachment.url - Full image URL
  // attachment.sizes.thumbnail.url - Thumbnail URL
});

// Open the modal
mediaFrame.open();
```
[Source: WordPress Media Library documentation and epic-3-admin-ui.md#story-3.7-technical-requirements]

**Enqueue Media Scripts (PHP):**
```php
// In includes/Admin/PageEditor.php
public function enqueueScripts($hook) {
    // ... existing code ...

    // Enqueue WordPress media library
    wp_enqueue_media();

    // ... rest of enqueue code ...
}
```
[Source: epic-3-admin-ui.md#story-3.7-technical-requirements]

**Image Fields in Content Structure:**
1. hero_image - Hero Section block
2. step_image - Process block (repeater field, up to 4)
3. size_chart_image - Size & Fit block
[Source: PRD prd.md#content-structure]

**ACF Image Field Storage:**
ACF stores image fields as attachment IDs (integers), not URLs. The component should:
- Store image ID in state
- Pass image ID to onChange handler
- Fetch image URL for display using REST API
[Source: PRD prd.md#content-structure and WordPress ACF documentation]

**Fetch Image Data via REST API:**
```javascript
// services/api.js
export const fetchImageData = async (imageId) => {
  const response = await apiFetch({
    path: `/wp/v2/media/${imageId}`,
  });

  return {
    id: response.id,
    url: response.source_url,
    thumbnailUrl: response.media_details?.sizes?.thumbnail?.source_url || response.source_url,
    alt: response.alt_text
  };
};
```
[Source: WordPress REST API documentation]

**MediaPicker Component Pattern:**
```javascript
import { useState, useEffect } from '@wordpress/element';
import { Button, Spinner } from '@wordpress/components';

const MediaPicker = ({ value, onChange, label = 'Select Image' }) => {
  const [image, setImage] = useState(null);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    if (value) {
      setIsLoading(true);
      fetchImageData(value)
        .then(imageData => {
          setImage(imageData);
          setIsLoading(false);
        })
        .catch(() => {
          setIsLoading(false);
        });
    }
  }, [value]);

  const openMediaLibrary = () => {
    const mediaFrame = wp.media({
      title: label,
      button: { text: 'Select Image' },
      multiple: false
    });

    mediaFrame.on('select', function() {
      const attachment = mediaFrame.state().get('selection').first().toJSON();
      setImage({
        id: attachment.id,
        url: attachment.url,
        thumbnailUrl: attachment.sizes?.thumbnail?.url || attachment.url,
        alt: attachment.alt
      });
      onChange(attachment.id);
    });

    mediaFrame.open();
  };

  const removeImage = () => {
    setImage(null);
    onChange(null);
  };

  if (isLoading) {
    return <Spinner />;
  }

  if (image) {
    return (
      <div className="media-picker">
        <img src={image.thumbnailUrl} alt={image.alt} />
        <div className="media-picker-buttons">
          <Button onClick={openMediaLibrary}>Change Image</Button>
          <Button isDestructive onClick={removeImage}>Remove Image</Button>
        </div>
      </div>
    );
  }

  return (
    <Button isPrimary onClick={openMediaLibrary}>
      {label}
    </Button>
  );
};
```
[Source: epic-3-admin-ui.md#story-3.7-technical-requirements]

**CSS Styling:**
```css
.media-picker {
  margin: 10px 0;
}

.media-picker img {
  max-width: 300px;
  max-height: 300px;
  border: 1px solid #ddd;
  border-radius: 4px;
  display: block;
  margin-bottom: 10px;
}

.media-picker-buttons {
  display: flex;
  gap: 10px;
}
```
[Source: epic-3-admin-ui.md#story-3.7-technical-requirements]

**WordPress Media Sizes:**
WordPress automatically generates multiple image sizes:
- thumbnail: 150x150
- medium: 300x300
- large: 1024x1024
- full: original size
Use thumbnail for preview, store ID for full image
[Source: WordPress Media Library documentation]

**Error Handling:**
- Image ID exists but image deleted: Show "Image not found" message
- Network error: Show "Unable to load image" message
- User closes modal without selecting: No action needed (current state preserved)
[Source: Architecture error handling patterns]

**Integration with Repeater Fields:**
For process_steps repeater, each step has its own MediaPicker:
```javascript
<RepeaterField>
  {steps.map((step, index) => (
    <div key={index}>
      <TextControl label="Step Title" ... />
      <TextareaControl label="Step Text" ... />
      <MediaPicker
        label="Step Image"
        value={step.step_image}
        onChange={(imageId) => updateStep(index, 'step_image', imageId)}
      />
    </div>
  ))}
</RepeaterField>
```
[Source: PRD process block structure]

**WordPress Media Library Modal Features:**
The wp.media modal automatically supports:
- Upload new images via drag-and-drop
- Browse existing Media Library
- Filter by date, search
- View image details
- Select from uploaded images
No additional code needed - it's all built into WordPress!
[Source: WordPress Media Library features]

### Testing

**Test File Location:**
- `tests/js/components/common/MediaPicker.test.js`

**Testing Framework:**
- Jest 29.x + React Testing Library 14.x
- Mock wp.media API for testing
[Source: architecture.md#tech-stack]

**Test Coverage Requirements:**
- Verify "Select Image" button renders when no image
- Verify image preview renders when image ID provided
- Verify "Change Image" and "Remove Image" buttons render with image
- Verify onClick handler calls wp.media
- Verify Remove button clears image and calls onChange(null)
- Mock wp.media API to test selection flow
- Test loading state during image fetch
- Test error handling for invalid image ID

**Mocking wp.media:**
```javascript
// In test file
global.wp = {
  media: jest.fn(() => ({
    on: jest.fn(),
    open: jest.fn(),
    state: jest.fn(() => ({
      get: jest.fn(() => ({
        first: jest.fn(() => ({
          toJSON: () => ({ id: 123, url: 'http://example.com/image.jpg' })
        }))
      }))
    }))
  }))
};
```

**Coding Standards:**
- Use WordPress ESLint configuration
- Handle all edge cases (missing image, network errors)
- Provide accessible button labels and image alt text
- Use controlled component pattern
[Source: architecture.md#code-quality-js]

**Manual Testing Checklist:**
- [ ] Navigate to Hero Section block
- [ ] Click "Select Image" button
- [ ] Verify WordPress Media Library modal opens
- [ ] Select an existing image from library
- [ ] Verify modal closes and image preview appears
- [ ] Verify "Change Image" and "Remove Image" buttons appear
- [ ] Click "Change Image" and select different image
- [ ] Verify new image preview updates
- [ ] Click "Remove Image"
- [ ] Verify image clears and "Select Image" button returns
- [ ] Upload new image via Media Library
- [ ] Verify newly uploaded image can be selected
- [ ] Test in Process block repeater (multiple step images)
- [ ] Test in Size & Fit block (size chart image)
- [ ] Save page and reload - verify images persist
- [ ] Test with image deleted from Media Library
- [ ] Verify keyboard accessibility (Tab navigation)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*
