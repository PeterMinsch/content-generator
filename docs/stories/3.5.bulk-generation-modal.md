# Story 3.5: Build Bulk Generation Progress Modal

## Status

Ready for Review

## Story

**As a** content manager,
**I want** a progress modal during "Generate All Blocks" operation,
**so that** I can see real-time progress and estimated completion time

## Acceptance Criteria

1. "Generate All Blocks" button displayed above block list
2. Clicking button opens modal overlay with:
   - Title: "Generating Content..."
   - Current progress: "Block 4 of 12"
   - Progress bar showing percentage complete
   - List of all blocks with status icons
   - Estimated time remaining
   - Cancel button
3. Modal updates in real-time as each block completes:
   - Progress bar advances
   - Block status icon changes
   - Time remaining recalculates
4. Completion summary shown when finished:
   - Total blocks generated
   - Total cost
   - Any failed blocks listed
   - "Close" button
5. Cancel button stops generation after current block
6. Modal cannot be dismissed by clicking overlay during generation

## Tasks / Subtasks

- [ ] Task 1: Create BulkGenerationModal component (AC: 2, 3, 4, 6)
  - [ ] Create `assets/js/src/components/generation/BulkGenerationModal.js`
  - [ ] Import Modal component from `@wordpress/components`
  - [ ] Accept props: isOpen, onClose, blocks, onGenerate
  - [ ] Set up component state: currentBlockIndex, completedBlocks, failedBlocks, totalCost
  - [ ] Configure modal with `isDismissible={false}` during generation
  - [ ] Render modal title "Generating Content..."

- [ ] Task 2: Create ProgressBar component (AC: 2, 3)
  - [ ] Create `assets/js/src/components/common/ProgressBar.js`
  - [ ] Accept props: current, total
  - [ ] Calculate percentage: (current / total) * 100
  - [ ] Render progress bar with CSS width animation
  - [ ] Display "Block X of Y" text
  - [ ] Style with WordPress admin colors

- [ ] Task 3: Create BlockProgressList component (AC: 2, 3)
  - [ ] Create `assets/js/src/components/generation/BlockProgressList.js`
  - [ ] Accept props: blocks, statuses
  - [ ] Render list of all 12 blocks with names
  - [ ] Display status icon for each block (using StatusIndicator)
  - [ ] Show generation time for completed blocks
  - [ ] Highlight currently generating block

- [ ] Task 4: Implement sequential block generation logic (AC: 3, 5)
  - [ ] Create useBulkGeneration hook: `assets/js/src/hooks/useBulkGeneration.js`
  - [ ] Accept props: postId, blocks, onProgress, onComplete
  - [ ] Implement async loop to generate blocks sequentially (not parallel)
  - [ ] Track start time for each block
  - [ ] Update progress after each block completes
  - [ ] Handle individual block failures (continue to next block)
  - [ ] Implement cancel functionality (set flag, check before each block)
  - [ ] Return: { startGeneration, cancelGeneration, progress }

- [ ] Task 5: Calculate estimated time remaining (AC: 2, 3)
  - [ ] Track generation time for each completed block
  - [ ] Calculate average time per block
  - [ ] Estimate time for remaining blocks: avgTime * blocksRemaining
  - [ ] Display in human-readable format (e.g., "2m 15s")
  - [ ] Update estimate after each block completion

- [ ] Task 6: Create completion summary view (AC: 4)
  - [ ] Create CompletionSummary component
  - [ ] Display total blocks generated (successful count)
  - [ ] Display total cost (sum of all generation costs)
  - [ ] List failed blocks (if any) with error messages
  - [ ] Show "Close" button to dismiss modal
  - [ ] Add success/warning styling based on results

- [ ] Task 7: Integrate modal with GenerationControls (AC: 1)
  - [ ] Update GenerationControls component
  - [ ] Add "Generate All Blocks" button
  - [ ] Add state to control modal open/close
  - [ ] Pass onGenerate handler to modal
  - [ ] Disable button during active generation

- [ ] Task 8: Implement cancel functionality (AC: 5)
  - [ ] Add "Cancel" button to modal
  - [ ] Set cancellation flag in useBulkGeneration hook
  - [ ] Check flag before starting each new block
  - [ ] Stop generation loop if cancelled
  - [ ] Show partial results in completion summary
  - [ ] Update modal title to "Generation Cancelled"

- [ ] Task 9: Track and display cost accumulation (AC: 4)
  - [ ] Extract cost from each generation API response
  - [ ] Accumulate total cost as blocks complete
  - [ ] Display running total in modal
  - [ ] Format cost as currency (e.g., "$0.25")
  - [ ] Show cost per block in progress list

- [ ] Task 10: Add real-time progress updates (AC: 3)
  - [ ] Use callback to update parent state after each block
  - [ ] Update progress bar percentage
  - [ ] Update block status in list
  - [ ] Recalculate time estimate
  - [ ] Force component re-render with state changes

- [ ] Task 11: Handle generation errors gracefully (AC: 3, 4)
  - [ ] Catch errors for individual block generation
  - [ ] Mark block as "failed" in progress list
  - [ ] Continue to next block (don't stop entire process)
  - [ ] Collect error messages for summary
  - [ ] Display failed blocks in completion summary

- [ ] Task 12: Style the modal and components (AC: 2, 3, 4)
  - [ ] Update `assets/css/admin-blocks.css`
  - [ ] Style modal container (min-width, padding)
  - [ ] Style progress bar (background, fill, animation)
  - [ ] Style block progress list (spacing, icons, alignment)
  - [ ] Style completion summary (success/error states)
  - [ ] Add loading animations for smooth transitions

- [ ] Task 13: Add accessibility features
  - [ ] Add aria-label to progress bar
  - [ ] Add aria-live region for progress updates
  - [ ] Ensure modal is keyboard accessible (Tab, Esc)
  - [ ] Add screen reader announcements for progress
  - [ ] Focus management when modal opens/closes

## Dev Notes

### Relevant Architecture Context

**Tech Stack:**
- **Frontend Framework:** React 18.x with functional components and hooks
- **WordPress Components:** @wordpress/components - Modal component already accessible
- **Frontend State:** React Context API + Hooks for state management
[Source: architecture.md#tech-stack]

**WordPress Modal Component:**
```javascript
import { Modal, Button } from '@wordpress/components';

<Modal
  title="Generating Content..."
  isDismissible={false}  // Prevent closing during generation
  onRequestClose={onClose}
  className="bulk-generation-modal"
>
  {/* Modal content */}
</Modal>
```
[Source: epic-3-admin-ui.md#story-3.5-technical-requirements]

**Sequential Generation Flow:**
The bulk generation must happen sequentially, NOT in parallel:
1. Loop through 12 blocks in order
2. Call single block generation API for each
3. Wait for completion before starting next
4. Update UI after each block completes
This prevents overwhelming the OpenAI API and ensures predictable timing.
[Source: PRD prd.md#openai-integration-generation-flow]

**Progress Modal UI Structure (from PRD):**
```
Generating Content...
Progress: Block 4 of 12

[████████░░░░░░░░░░░░] 33%

✓ Hero Section (3 seconds)
✓ SERP Answer (5 seconds)
✓ Product Criteria (4 seconds)
⏳ Materials Explained (generating...)
○ Process (waiting)
○ Comparison (waiting)
...

Estimated time remaining: 2m 15s

[Cancel]
```
[Source: PRD prd.md#admin-interface-progress-modal]

**Completion Summary Structure:**
```
Generation Complete!

✓ 11 blocks generated successfully
✗ 1 block failed

Total cost: $2.35

Failed blocks:
- Materials Explained: "API timeout - please try again"

[Retry Failed]  [Close]
```
[Source: epic-3-admin-ui.md#story-3.5-acceptance-criteria]

**useBulkGeneration Hook Pattern:**
```javascript
const useBulkGeneration = (postId) => {
  const [progress, setProgress] = useState({
    current: 0,
    total: 12,
    statuses: {},
    costs: [],
    startTimes: {},
    cancelled: false
  });

  const startGeneration = async (blocks, onComplete) => {
    for (let i = 0; i < blocks.length; i++) {
      if (progress.cancelled) break;

      const block = blocks[i];
      const startTime = Date.now();

      try {
        const result = await generateBlock(postId, block.type);
        const endTime = Date.now();
        const duration = (endTime - startTime) / 1000;

        setProgress(prev => ({
          ...prev,
          current: i + 1,
          statuses: { ...prev.statuses, [block.type]: 'generated' },
          costs: [...prev.costs, result.cost],
          startTimes: { ...prev.startTimes, [block.type]: duration }
        }));
      } catch (error) {
        setProgress(prev => ({
          ...prev,
          statuses: { ...prev.statuses, [block.type]: 'failed' }
        }));
      }
    }

    onComplete();
  };

  const cancelGeneration = () => {
    setProgress(prev => ({ ...prev, cancelled: true }));
  };

  return { progress, startGeneration, cancelGeneration };
};
```
[Source: epic-3-admin-ui.md#story-3.5-technical-requirements]

**Estimated Time Calculation:**
```javascript
const calculateTimeRemaining = (completedBlocks, totalBlocks, completedTimes) => {
  if (completedBlocks === 0) return null;

  const avgTime = completedTimes.reduce((a, b) => a + b, 0) / completedBlocks;
  const remainingBlocks = totalBlocks - completedBlocks;
  const estimatedSeconds = avgTime * remainingBlocks;

  const minutes = Math.floor(estimatedSeconds / 60);
  const seconds = Math.floor(estimatedSeconds % 60);

  return `${minutes}m ${seconds}s`;
};
```
[Source: epic-3-admin-ui.md#story-3.5-acceptance-criteria]

**Progress Bar CSS Animation:**
```css
.progress-bar {
  width: 100%;
  height: 20px;
  background-color: #f0f0f0;
  border-radius: 10px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background-color: #0073aa;
  transition: width 0.3s ease-in-out;
}
```
[Source: epic-3-admin-ui.md#story-3.5-technical-requirements]

**API Response for Cost Tracking:**
Each generation API call returns cost information:
```javascript
{
  success: true,
  data: {
    content: { /* field values */ },
    tokens: { prompt: 500, completion: 300, total: 800 },
    cost: 0.025,  // Extract this value
    model: 'gpt-4-turbo-preview'
  }
}
```
[Source: architecture.md#api-specification]

**Modal Cannot Be Dismissed During Generation:**
- Set `isDismissible={false}` on Modal component
- This prevents clicking overlay to close
- This prevents Esc key from closing
- Only allow close after completion or cancellation
[Source: epic-3-admin-ui.md#story-3.5-acceptance-criteria]

**12 Blocks Order:**
1. Hero Section
2. SERP Answer
3. Product Criteria
4. Materials Explained
5. Process
6. Comparison
7. Product Showcase
8. Size & Fit
9. Care & Warranty
10. Ethics & Origin
11. FAQs
12. CTA
[Source: PRD prd.md#content-structure]

### Testing

**Test File Location:**
- `tests/js/components/generation/BulkGenerationModal.test.js`
- `tests/js/components/generation/BlockProgressList.test.js`
- `tests/js/components/common/ProgressBar.test.js`
- `tests/js/hooks/useBulkGeneration.test.js`

**Testing Framework:**
- Jest 29.x + React Testing Library 14.x
- Mock API calls with jest.mock()
- Use fake timers for async testing
[Source: architecture.md#tech-stack]

**Test Coverage Requirements:**
- Verify modal opens when Generate All is clicked
- Verify modal is not dismissible during generation
- Verify progress bar updates as blocks complete
- Verify estimated time calculation is accurate
- Verify cancel stops generation after current block
- Verify completion summary displays correct data
- Verify error handling for failed blocks
- Mock sequential API calls and verify order

**Coding Standards:**
- Use WordPress ESLint configuration
- Handle all async operations with try/catch
- Provide meaningful error messages to users
- Use accessible modal patterns
[Source: architecture.md#code-quality-js]

**Manual Testing Checklist:**
- [ ] Click "Generate All Blocks" button
- [ ] Verify modal opens with progress UI
- [ ] Verify clicking outside modal does NOT close it
- [ ] Verify pressing Esc does NOT close modal during generation
- [ ] Watch progress bar advance as blocks complete
- [ ] Verify each block status icon updates in real-time
- [ ] Verify time remaining updates and counts down
- [ ] Verify "Block X of 12" text updates
- [ ] Click Cancel button mid-generation
- [ ] Verify generation stops after current block completes
- [ ] Verify completion summary shows correct counts
- [ ] Verify total cost is displayed and accurate
- [ ] Test with one failed block - verify it shows in summary
- [ ] Verify "Close" button works in completion state
- [ ] Verify modal is dismissible after completion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*
