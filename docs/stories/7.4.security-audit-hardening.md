# Story 7.4: Conduct Security Audit and Hardening

## Status

Draft

## Story

**As a** site administrator,
**I want** the plugin to be secure,
**so that** my site is not vulnerable to attacks

## Acceptance Criteria

1. Security checklist completed:
   - ✓ All user input sanitized
   - ✓ All output escaped
   - ✓ Nonce verification on all forms and AJAX requests
   - ✓ Capability checks on all admin actions
   - ✓ API key encrypted at rest (AES-256-CBC)
   - ✓ API key never exposed in frontend JavaScript
   - ✓ SQL queries use prepared statements
   - ✓ File uploads validated for type and size
   - ✓ Rate limiting prevents abuse
   - ✓ No direct file execution (ABSPATH guards)
2. Code scanned with security tools (PHPCS with WordPress-Security ruleset, WPScan)
3. All critical issues fixed before release
4. Security best practices documented

## Tasks / Subtasks

- [ ] Task 1: Input sanitization audit (AC: 1)
  - [ ] Review all POST/GET/REQUEST usage
  - [ ] Ensure sanitize_text_field(), sanitize_textarea_field(), esc_url_raw() used
  - [ ] Check ACF field sanitization
  - [ ] Verify CSV import sanitization
  - [ ] Create sanitization checklist

- [ ] Task 2: Output escaping audit (AC: 1)
  - [ ] Review all echo/print statements
  - [ ] Ensure esc_html(), esc_url(), esc_attr() used appropriately
  - [ ] Check template files for proper escaping
  - [ ] Review JavaScript data output (wp_localize_script)
  - [ ] Create escaping checklist

- [ ] Task 3: Nonce and capability verification (AC: 1)
  - [ ] Audit all forms for wp_nonce_field()
  - [ ] Audit all AJAX for check_ajax_referer()
  - [ ] Verify current_user_can() on all admin actions
  - [ ] Check REST API permission_callback
  - [ ] Document capability requirements

- [ ] Task 4: API key security review (AC: 1)
  - [ ] Verify API key encrypted in database (AES-256-CBC)
  - [ ] Ensure decrypt only server-side
  - [ ] Check JavaScript doesn't expose key
  - [ ] Review key transmission (HTTPS only)
  - [ ] Test key retrieval methods

- [ ] Task 5: Database query security (AC: 1)
  - [ ] Audit all $wpdb usage
  - [ ] Ensure $wpdb->prepare() for all dynamic queries
  - [ ] Check for SQL injection vulnerabilities
  - [ ] Review custom table queries
  - [ ] Test with malicious input

- [ ] Task 6: File upload security (AC: 1)
  - [ ] Verify wp_check_filetype() validation
  - [ ] Check file size limits enforced
  - [ ] Ensure upload_max_filesize respected
  - [ ] Test CSV and image uploads with malicious files
  - [ ] Document upload restrictions

- [ ] Task 7: Rate limiting verification (AC: 1)
  - [ ] Test generation rate limits (50/hour, 3 concurrent)
  - [ ] Verify transient-based limiting works
  - [ ] Test with rapid requests
  - [ ] Check budget limit enforcement
  - [ ] Document rate limit behavior

- [ ] Task 8: ABSPATH guards (AC: 1)
  - [ ] Add defined('ABSPATH') || exit; to all PHP files
  - [ ] Verify no direct file access possible
  - [ ] Test accessing files directly via URL
  - [ ] Automate check in CI

- [ ] Task 9: Security scanning (AC: 2)
  - [ ] Run PHPCS with WordPress-Security ruleset
  - [ ] Run WPScan plugin vulnerability check
  - [ ] Review scan results
  - [ ] Fix critical and high priority issues
  - [ ] Document scan results

- [ ] Task 10: Documentation (AC: 4)
  - [ ] Create SECURITY.md with security best practices
  - [ ] Document API key encryption method
  - [ ] List all capability requirements
  - [ ] Provide security update policy
  - [ ] Add security contact information

## Dev Notes

### Security Requirements from PRD

**Input Sanitization:**
```php
// Text
sanitize_text_field($value)

// Textarea
sanitize_textarea_field($value)

// URLs
esc_url_raw($value)

// HTML (if needed)
wp_kses_post($value)
```
[Source: PRD prd.md#input-sanitization]

**Output Escaping:**
```php
// Text
esc_html($value)

// URLs
esc_url($value)

// Attributes
esc_attr($value)
```
[Source: PRD prd.md#output-escaping]

**Nonce Verification:**
```php
// AJAX
check_ajax_referer('seo_generator_nonce');

// Forms
wp_verify_nonce($_POST['nonce_field'], 'action_name');
```
[Source: PRD prd.md#nonce-verification]

**Capability Checks:**
```php
if (!current_user_can('edit_posts')) {
    wp_die('Unauthorized');
}
```
[Source: PRD prd.md#capability-checks]

**API Key Encryption:**
```php
function encrypt_api_key($value) {
    $key = wp_salt('auth');
    return openssl_encrypt($value, 'AES-256-CBC', $key, 0, substr($key, 0, 16));
}

function decrypt_api_key($encrypted) {
    $key = wp_salt('auth');
    return openssl_decrypt($encrypted, 'AES-256-CBC', $key, 0, substr($key, 0, 16));
}
```
[Source: PRD prd.md#api-key-storage]

**Rate Limiting:**
```php
$user_id = get_current_user_id();
$transient_key = 'seo_gen_rate_' . $user_id;
$count = (int) get_transient($transient_key);

if ($count >= 50) {
    wp_send_json_error(['message' => 'Rate limit exceeded']);
}

set_transient($transient_key, $count + 1, HOUR_IN_SECONDS);
```
[Source: PRD prd.md#rate-limiting]

**Security Scanning Tools:**
- PHP_CodeSniffer with WordPress-Security ruleset
- WPScan for known vulnerabilities
- Manual penetration testing
[Source: architecture.md#code-quality-php]

### Testing

**Test Approach:**
- Security audit checklist
- Automated scanning
- Manual penetration testing
- Code review

**Test Scenarios:**
1. Attempt SQL injection in all inputs
2. Attempt XSS in all text fields
3. Try accessing admin pages without authentication
4. Attempt CSRF on forms without nonces
5. Try uploading malicious files
6. Attempt to exceed rate limits
7. Try accessing files directly (should fail)
8. Verify API key never exposed in HTML/JavaScript

**Tools:**
- PHPCS: `composer run phpcs -- --standard=WordPress-Security`
- WPScan: `wpscan --url http://example.com --enumerate vp`
- Manual testing with malicious payloads
[Source: architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by QA Agent after story completion*
