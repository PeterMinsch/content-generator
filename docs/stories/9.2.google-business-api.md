# Story 9.2: Google Business Profile API Integration

**Epic:** 9 - Automated Review Integration
**Status:** Draft

---

## Story

**As a** plugin developer,
**I want** to fetch reviews from Google Business Profile API for Bravo Jewelers,
**so that** reviews can be cached and used in review blocks during page generation

---

## Acceptance Criteria

1. **GoogleBusinessService Class Implementation**
   - Service class `GoogleBusinessService` handles all Google API interactions
   - OAuth 2.0 authentication with hardcoded credentials for Bravo Jewelers
   - Method: `fetchReviews(): array` - fetches all reviews for Bravo Jewelers location
   - Parses API response into standardized review data format
   - Returns array of normalized review data structures

2. **Hardcoded Configuration**
   - Business name: "Bravo Jewelers" (constant)
   - Google Account ID hardcoded as class constant
   - Google Location ID hardcoded as class constant
   - OAuth client ID, client secret, and refresh token hardcoded
   - Configuration documented in code comments for future updates

3. **OAuth Authentication Flow**
   - Service authenticates using OAuth 2.0 refresh token
   - Exchanges refresh token for access token before API calls
   - Access token cached in object property (session-level cache)
   - Handles token expiration and re-authentication automatically
   - Logs authentication success/failure to debug.log

4. **API Data Fetching**
   - Calls Google My Business API reviews endpoint
   - Endpoint: `https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/reviews`
   - Handles pagination if more than 50 reviews exist
   - Parses JSON response and extracts review fields
   - Returns empty array if API call fails (graceful degradation)

5. **Data Normalization**
   - Converts Google API response to plugin's standard review format
   - Extracts: reviewer name, avatar URL, rating, review text, review date
   - Formats dates to MySQL datetime format (Y-m-d H:i:s)
   - Generates external_review_id from Google's review ID
   - Sets source as 'google' for all reviews

6. **Error Handling**
   - HTTP errors (401, 403, 404, 429, 500) logged and handled gracefully
   - Rate limit errors (429) logged with retry-after info
   - Network timeouts return empty array (don't break generation)
   - Invalid credentials logged with actionable error messages
   - All errors logged to debug.log with [Google Reviews] prefix

7. **Performance**
   - API calls complete within 10 seconds (with 30s timeout)
   - Access token cached for duration of request (avoid re-auth)
   - No blocking on failures (immediate return with empty array)

---

## Tasks / Subtasks

- [ ] **Task 1: Create GoogleBusinessService Class** (AC: 1, 2)
  - [ ] Create `includes/Services/GoogleBusinessService.php`
  - [ ] Add namespace `SEOGenerator\Services`
  - [ ] Define class constants for Bravo Jewelers config
  - [ ] Add constructor (no dependencies needed)
  - [ ] Add PHPDoc for class and all methods

- [ ] **Task 2: Define Hardcoded Configuration Constants** (AC: 2)
  - [ ] Add constant `BUSINESS_NAME = 'Bravo Jewelers'`
  - [ ] Add constant `ACCOUNT_ID` (to be filled with real account ID)
  - [ ] Add constant `LOCATION_ID` (to be filled with real location ID)
  - [ ] Add constant `CLIENT_ID` (OAuth client ID)
  - [ ] Add constant `CLIENT_SECRET` (OAuth client secret)
  - [ ] Add constant `REFRESH_TOKEN` (OAuth refresh token)
  - [ ] Add comments explaining how to obtain each value

- [ ] **Task 3: Implement OAuth Access Token Retrieval** (AC: 3)
  - [ ] Create private method `getAccessToken(): ?string`
  - [ ] Check if access token already cached in `$this->access_token` property
  - [ ] If cached and not expired, return cached token
  - [ ] Otherwise, call Google OAuth token endpoint
  - [ ] Endpoint: `https://oauth2.googleapis.com/token`
  - [ ] POST params: grant_type=refresh_token, client_id, client_secret, refresh_token
  - [ ] Use `wp_remote_post()` for HTTP request
  - [ ] Parse JSON response and extract `access_token`
  - [ ] Cache token in `$this->access_token` property
  - [ ] Log success: "[Google Reviews] OAuth token obtained"
  - [ ] Return token string or null on failure

- [ ] **Task 4: Implement fetchReviews() Method** (AC: 1, 4)
  - [ ] Create public method `fetchReviews(): array`
  - [ ] Call `getAccessToken()` to obtain OAuth token
  - [ ] Return empty array if authentication fails
  - [ ] Build API URL with ACCOUNT_ID and LOCATION_ID
  - [ ] Set authorization header: `Authorization: Bearer {token}`
  - [ ] Use `wp_remote_get()` with 30-second timeout
  - [ ] Check for `is_wp_error()` response
  - [ ] Parse JSON response body
  - [ ] Extract reviews array from response
  - [ ] Pass to `normalizeReviews()` for data transformation
  - [ ] Return normalized array

- [ ] **Task 5: Implement Review Data Normalization** (AC: 5)
  - [ ] Create private method `normalizeReviews(array $google_reviews): array`
  - [ ] Loop through each Google review
  - [ ] Extract reviewer display name: `$review['reviewer']['displayName']`
  - [ ] Extract reviewer avatar: `$review['reviewer']['profilePhotoUrl']`
  - [ ] Extract rating: `$review['starRating']` (convert to decimal)
  - [ ] Extract review text: `$review['comment']`
  - [ ] Extract review time: `$review['createTime']` (convert to MySQL datetime)
  - [ ] Extract review ID: `$review['reviewId']`
  - [ ] Build standardized array for each review
  - [ ] Return array of normalized reviews

- [ ] **Task 6: Implement HTTP Error Handling** (AC: 6)
  - [ ] In `fetchReviews()`, check HTTP response code
  - [ ] Handle 401 Unauthorized: log "Invalid OAuth credentials"
  - [ ] Handle 403 Forbidden: log "Access denied to location"
  - [ ] Handle 404 Not Found: log "Location not found: check LOCATION_ID"
  - [ ] Handle 429 Too Many Requests: log "Rate limit exceeded" + retry-after
  - [ ] Handle 500+ Server Errors: log "Google API server error"
  - [ ] All error paths return empty array
  - [ ] Use error_log() with prefix "[Google Reviews]"

- [ ] **Task 7: Add Date Formatting Helper** (AC: 5)
  - [ ] Create private method `formatReviewDate(string $google_date): string`
  - [ ] Parse Google's ISO 8601 date format (e.g., "2025-09-20T14:30:00Z")
  - [ ] Convert to MySQL datetime format: "Y-m-d H:i:s"
  - [ ] Handle timezone conversion (Google uses UTC)
  - [ ] Return formatted date string

- [ ] **Task 8: Add Rating Conversion Helper** (AC: 5)
  - [ ] Create private method `formatRating(string $star_rating): float`
  - [ ] Google returns rating as enum: "FIVE", "FOUR", "THREE", "TWO", "ONE"
  - [ ] Convert to decimal: FIVE -> 5.0, FOUR -> 4.0, etc.
  - [ ] Return float value

- [ ] **Task 9: Add Debug Logging** (AC: 3, 6)
  - [ ] Log OAuth token retrieval success/failure
  - [ ] Log API endpoint being called
  - [ ] Log number of reviews fetched
  - [ ] Log all error conditions with details
  - [ ] Format: "[Google Reviews] {message}"
  - [ ] Use `error_log()` function

- [ ] **Task 10: Add Unit Tests** (AC: All)
  - [ ] Test OAuth token retrieval returns valid token
  - [ ] Test fetchReviews() returns normalized array
  - [ ] Test normalizeReviews() converts Google format to plugin format
  - [ ] Test formatReviewDate() converts ISO 8601 to MySQL datetime
  - [ ] Test formatRating() converts Google enums to decimals
  - [ ] Test error handling for 401, 403, 404, 429, 500 responses
  - [ ] Test empty response returns empty array
  - [ ] Mock `wp_remote_get()` and `wp_remote_post()` in tests

---

## Dev Notes

### Feature Context

This story implements the Google Business Profile API integration for Epic 9 (Automated Review Integration). It provides the data source for review caching - fetching real customer reviews from Google for Bravo Jewelers.

**Key Design Decisions:**
- Hardcoded credentials simplify setup for single-business use case
- OAuth refresh token provides long-lived authentication (no user interaction)
- Graceful degradation on API failures (return empty array, don't break generation)
- Data normalization ensures consistent format across different review sources (future: Yelp, Facebook)

**Google My Business API Overview:**
- API requires OAuth 2.0 authentication (no API key option)
- Review data includes reviewer name, avatar, rating (1-5), text, and timestamp
- API has rate limits (need to cache results to avoid hitting limits)
- Endpoint returns max 50 reviews per call (pagination may be needed)

### Previous Story Insights

From Story 9.1 (Review Database):
- Reviews stored in standardized format: source, external_review_id, reviewer_name, etc.
- ReviewRepository expects normalized data structure
- Source field set to 'google' for Google reviews

From Epic 5 (Image Library):
- External API integrations should handle errors gracefully
- Use `wp_remote_get()` and `wp_remote_post()` for HTTP (WordPress standard)
- Log all API operations for debugging

### Data Models

**Google API Response Format (Sample):**
```json
{
  "reviews": [
    {
      "reviewId": "ChZDSUhNMG9nS0VJQ0FnSURueF9YdGR3EAE",
      "reviewer": {
        "displayName": "Sarah Johnson",
        "profilePhotoUrl": "https://lh3.googleusercontent.com/a-/AOh14Gi..."
      },
      "starRating": "FIVE",
      "comment": "Excellent service! The engagement ring is stunning.",
      "createTime": "2025-09-20T14:30:00Z",
      "updateTime": "2025-09-20T14:30:00Z"
    }
  ],
  "averageRating": 4.8,
  "totalReviewCount": 156,
  "nextPageToken": "..."
}
```

[Source: Google My Business API Documentation]

**Plugin's Standardized Review Format:**
```php
[
    'source' => 'google',
    'external_review_id' => 'ChZDSUhNMG9nS0VJQ0FnSURueF9YdGR3EAE',
    'reviewer_name' => 'Sarah Johnson',
    'reviewer_avatar_url' => 'https://lh3.googleusercontent.com/a-/AOh14Gi...',
    'rating' => 5.0,
    'review_text' => 'Excellent service! The engagement ring is stunning.',
    'review_date' => '2025-09-20 14:30:00',
]
```

**OAuth Token Request/Response:**
Request:
```
POST https://oauth2.googleapis.com/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&client_id={CLIENT_ID}
&client_secret={CLIENT_SECRET}
&refresh_token={REFRESH_TOKEN}
```

Response:
```json
{
  "access_token": "ya29.a0AfH6SMB...",
  "expires_in": 3599,
  "scope": "https://www.googleapis.com/auth/business.manage",
  "token_type": "Bearer"
}
```

### Plugin Architecture & Patterns

**Service Layer Pattern**
The plugin uses service classes for external integrations and business logic [Source: architecture.md#Service Layer Pattern]:
- Services encapsulate complex operations (API calls, data processing)
- Services can be dependency-injected into other services (Story 9.3)
- Services are stateless except for request-scoped caching

**WordPress HTTP API**
WordPress provides `wp_remote_get()` and `wp_remote_post()` for HTTP requests [Source: WordPress Codex]:
- Automatic handling of different HTTP libraries (cURL, streams, etc.)
- Built-in error handling with `WP_Error` objects
- Timeout control via `timeout` parameter
- Headers set via `headers` parameter

**Error Logging**
WordPress `error_log()` function writes to debug.log [Source: WordPress debugging docs]:
- Enabled when `WP_DEBUG_LOG` is true in wp-config.php
- Log file: `wp-content/debug.log`
- Prefix messages for easy filtering: "[Google Reviews]"

### File Locations

Based on Unified Project Structure [Source: architecture.md#Unified Project Structure]:

**PHP Classes:**
- New: `includes/Services/GoogleBusinessService.php`

**Configuration:**
- Hardcoded in class constants (no external config files)

**Logs:**
- Debug output: `wp-content/debug.log`

### Component Specifications

**GoogleBusinessService Class**
Location: `includes/Services/GoogleBusinessService.php`

```php
<?php
namespace SEOGenerator\Services;

/**
 * Google Business Profile API integration for Bravo Jewelers
 *
 * Fetches review data from Google My Business API using OAuth 2.0.
 * Hardcoded configuration for single business (Bravo Jewelers).
 *
 * @package SEOGenerator\Services
 */
class GoogleBusinessService {

    // ============================================================================
    // CONFIGURATION - Update these values with real Google credentials
    // ============================================================================

    /**
     * Business name for logging/debugging
     */
    const BUSINESS_NAME = 'Bravo Jewelers';

    /**
     * Google My Business Account ID
     * How to get: https://developers.google.com/my-business/content/basic-setup
     */
    const ACCOUNT_ID = 'YOUR_ACCOUNT_ID_HERE';

    /**
     * Google My Business Location ID
     * How to get: Use "List Locations" API or Business Profile dashboard
     */
    const LOCATION_ID = 'YOUR_LOCATION_ID_HERE';

    /**
     * OAuth 2.0 Client ID
     * How to get: Google Cloud Console > Credentials
     */
    const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';

    /**
     * OAuth 2.0 Client Secret
     * How to get: Google Cloud Console > Credentials
     */
    const CLIENT_SECRET = 'YOUR_CLIENT_SECRET';

    /**
     * OAuth 2.0 Refresh Token
     * How to get: Use OAuth Playground or initial OAuth flow
     */
    const REFRESH_TOKEN = 'YOUR_REFRESH_TOKEN';

    // ============================================================================

    /**
     * Cached access token (session-level cache)
     * @var string|null
     */
    private $access_token = null;

    /**
     * Fetch all reviews for Bravo Jewelers from Google Business Profile API
     *
     * @return array Array of normalized review data (empty if error)
     */
    public function fetchReviews(): array {
        // Get OAuth access token
        $access_token = $this->getAccessToken();
        if (!$access_token) {
            error_log('[Google Reviews] Failed to obtain OAuth token');
            return [];
        }

        // Build API endpoint URL
        $url = sprintf(
            'https://mybusiness.googleapis.com/v4/accounts/%s/locations/%s/reviews',
            self::ACCOUNT_ID,
            self::LOCATION_ID
        );

        // Make API request
        $response = wp_remote_get($url, [
            'timeout' => 30,
            'headers' => [
                'Authorization' => 'Bearer ' . $access_token,
                'Content-Type' => 'application/json',
            ],
        ]);

        // Check for errors
        if (is_wp_error($response)) {
            error_log('[Google Reviews] HTTP error: ' . $response->get_error_message());
            return [];
        }

        $status_code = wp_remote_retrieve_response_code($response);

        // Handle HTTP errors
        if ($status_code !== 200) {
            $this->logApiError($status_code, $response);
            return [];
        }

        // Parse response
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);

        if (!isset($data['reviews']) || !is_array($data['reviews'])) {
            error_log('[Google Reviews] No reviews in API response');
            return [];
        }

        // Normalize review data
        $normalized = $this->normalizeReviews($data['reviews']);

        error_log(sprintf('[Google Reviews] Fetched %d reviews for %s', count($normalized), self::BUSINESS_NAME));

        return $normalized;
    }

    /**
     * Get OAuth access token using refresh token
     *
     * @return string|null Access token or null on failure
     */
    private function getAccessToken(): ?string {
        // Return cached token if available
        if ($this->access_token) {
            return $this->access_token;
        }

        // Request new access token
        $response = wp_remote_post('https://oauth2.googleapis.com/token', [
            'timeout' => 30,
            'body' => [
                'grant_type' => 'refresh_token',
                'client_id' => self::CLIENT_ID,
                'client_secret' => self::CLIENT_SECRET,
                'refresh_token' => self::REFRESH_TOKEN,
            ],
        ]);

        if (is_wp_error($response)) {
            error_log('[Google Reviews] OAuth error: ' . $response->get_error_message());
            return null;
        }

        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);

        if (!isset($data['access_token'])) {
            error_log('[Google Reviews] OAuth response missing access_token');
            return null;
        }

        // Cache token
        $this->access_token = $data['access_token'];

        error_log('[Google Reviews] OAuth token obtained successfully');

        return $this->access_token;
    }

    /**
     * Normalize Google review data to plugin's standard format
     *
     * @param array $google_reviews Raw reviews from Google API
     * @return array Normalized review data
     */
    private function normalizeReviews(array $google_reviews): array {
        $normalized = [];

        foreach ($google_reviews as $review) {
            $normalized[] = [
                'source' => 'google',
                'external_review_id' => $review['reviewId'] ?? '',
                'reviewer_name' => $review['reviewer']['displayName'] ?? 'Anonymous',
                'reviewer_avatar_url' => $review['reviewer']['profilePhotoUrl'] ?? '',
                'rating' => $this->formatRating($review['starRating'] ?? 'FIVE'),
                'review_text' => $review['comment'] ?? '',
                'review_date' => $this->formatReviewDate($review['createTime'] ?? ''),
            ];
        }

        return $normalized;
    }

    /**
     * Convert Google's ISO 8601 date to MySQL datetime
     *
     * @param string $google_date Date in format "2025-09-20T14:30:00Z"
     * @return string Date in format "2025-09-20 14:30:00"
     */
    private function formatReviewDate(string $google_date): string {
        if (empty($google_date)) {
            return current_time('mysql');
        }

        $timestamp = strtotime($google_date);
        return date('Y-m-d H:i:s', $timestamp);
    }

    /**
     * Convert Google's star rating enum to decimal
     *
     * @param string $star_rating Google rating: "FIVE", "FOUR", "THREE", "TWO", "ONE"
     * @return float Decimal rating: 5.0, 4.0, 3.0, 2.0, 1.0
     */
    private function formatRating(string $star_rating): float {
        $ratings = [
            'FIVE' => 5.0,
            'FOUR' => 4.0,
            'THREE' => 3.0,
            'TWO' => 2.0,
            'ONE' => 1.0,
        ];

        return $ratings[$star_rating] ?? 5.0;
    }

    /**
     * Log API error with appropriate message
     *
     * @param int $status_code HTTP status code
     * @param array|WP_Error $response HTTP response
     */
    private function logApiError(int $status_code, $response): void {
        $messages = [
            401 => 'Unauthorized - Check OAuth credentials',
            403 => 'Forbidden - Access denied to location',
            404 => 'Not Found - Check ACCOUNT_ID and LOCATION_ID constants',
            429 => 'Rate limit exceeded - Try again later',
            500 => 'Google API server error',
        ];

        $message = $messages[$status_code] ?? 'HTTP error ' . $status_code;

        // Add retry-after header for rate limits
        if ($status_code === 429) {
            $retry_after = wp_remote_retrieve_header($response, 'retry-after');
            if ($retry_after) {
                $message .= ' (retry after ' . $retry_after . ' seconds)';
            }
        }

        error_log('[Google Reviews] ' . $message);
    }
}
```

[Source: Google My Business API Documentation + Epic 9 Requirements]

### API Specifications

**Google My Business API Endpoint:**
```
GET https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/reviews
```

**Request Headers:**
- `Authorization: Bearer {access_token}`
- `Content-Type: application/json`

**Response (Success - 200 OK):**
```json
{
  "reviews": [...],
  "averageRating": 4.8,
  "totalReviewCount": 156,
  "nextPageToken": "..."
}
```

**Response (Error - 401 Unauthorized):**
```json
{
  "error": {
    "code": 401,
    "message": "Request is missing required authentication credential.",
    "status": "UNAUTHENTICATED"
  }
}
```

**OAuth Token Endpoint:**
```
POST https://oauth2.googleapis.com/token
Content-Type: application/x-www-form-urlencoded

Body: grant_type=refresh_token&client_id=...&client_secret=...&refresh_token=...
```

[Source: Google OAuth 2.0 Documentation]

### Technical Constraints

**OAuth 2.0 Requirements**
- Refresh token must have `business.manage` scope
- Access tokens expire after 1 hour (3600 seconds)
- Refresh tokens are long-lived (don't expire unless revoked)
- Client ID and secret must match the refresh token's project

**API Rate Limits**
- Google My Business API: 10 queries per second (QPS)
- Daily quota: varies by project (typically 1,000-10,000 requests/day)
- Rate limit errors return HTTP 429 with Retry-After header

**Review Data Constraints**
- Maximum 50 reviews per API call (need pagination for more)
- Reviews sorted by most recent first
- Review text can be empty (reviewer didn't leave comment)
- Avatar URL can be empty (reviewer has no profile photo)

**WordPress HTTP API Constraints**
- Default timeout: 5 seconds (we override to 30s for API calls)
- Maximum response size: depends on PHP memory_limit
- SSL certificate validation enabled by default (good for security)

### Integration Points

**Hook 1: Called by ReviewFetchService (Story 9.3)**
Location: `includes/Services/ReviewFetchService.php`

```php
$googleService = new GoogleBusinessService();
$reviews = $googleService->fetchReviews();

// Save to database via ReviewRepository
foreach ($reviews as $review) {
    $repository->save($review);
}
```

**Hook 2: Error Logging**
Location: `wp-content/debug.log`

All errors logged with `[Google Reviews]` prefix for easy filtering:
```
[2025-10-15 14:22:01] [Google Reviews] OAuth token obtained successfully
[2025-10-15 14:22:03] [Google Reviews] Fetched 23 reviews for Bravo Jewelers
```

### Project Structure Notes

The plugin follows WordPress Plugin Architecture with service layer [Source: architecture.md#Plugin Architecture]:
- Service classes handle external integrations (API calls)
- Services can be injected into other services (dependency injection)
- No admin UI needed - purely backend integration

**Security Note:**
Hardcoding credentials in source code is acceptable for single-business internal plugin. For public release, credentials should be moved to:
- `wp-config.php` constants: `define('GOOGLE_CLIENT_ID', '...');`
- WordPress options (encrypted): `update_option('google_credentials', openssl_encrypt(...))`

---

## Testing

### Testing Standards

**Framework:** PHPUnit 9.x with WordPress test framework [Source: architecture.md#Tech Stack - Backend Testing]

**Test Location:**
- Unit tests: `tests/php/Services/GoogleBusinessServiceTest.php` (new)
- Integration tests: `tests/php/Integration/GoogleApiTest.php` (new)

**Standards:** Use mocking for external API calls (don't hit real Google API in tests)

**Coverage:** Test OAuth flow, review fetching, normalization, and error handling

### Test Cases

**Unit Test: OAuth Token Retrieval (Mocked)**
```php
public function test_get_access_token_returns_valid_token() {
    // Mock wp_remote_post to return fake OAuth response
    \WP_Mock::userFunction('wp_remote_post', [
        'return' => [
            'body' => json_encode(['access_token' => 'fake_token_123']),
            'response' => ['code' => 200],
        ],
    ]);

    $service = new GoogleBusinessService();
    $token = $this->callPrivateMethod($service, 'getAccessToken');

    $this->assertEquals('fake_token_123', $token);
}
```

**Unit Test: fetchReviews() Returns Normalized Array**
```php
public function test_fetch_reviews_returns_normalized_array() {
    // Mock OAuth token
    \WP_Mock::userFunction('wp_remote_post', [
        'return' => ['body' => json_encode(['access_token' => 'test_token'])],
    ]);

    // Mock API response with sample review
    \WP_Mock::userFunction('wp_remote_get', [
        'return' => [
            'body' => json_encode([
                'reviews' => [
                    [
                        'reviewId' => 'abc123',
                        'reviewer' => ['displayName' => 'John Doe'],
                        'starRating' => 'FIVE',
                        'comment' => 'Great store!',
                        'createTime' => '2025-09-20T14:30:00Z',
                    ],
                ],
            ]),
            'response' => ['code' => 200],
        ],
    ]);

    $service = new GoogleBusinessService();
    $reviews = $service->fetchReviews();

    $this->assertCount(1, $reviews);
    $this->assertEquals('google', $reviews[0]['source']);
    $this->assertEquals('abc123', $reviews[0]['external_review_id']);
    $this->assertEquals('John Doe', $reviews[0]['reviewer_name']);
    $this->assertEquals(5.0, $reviews[0]['rating']);
}
```

**Unit Test: formatRating() Converts Enums Correctly**
```php
public function test_format_rating_converts_enums_to_decimals() {
    $service = new GoogleBusinessService();

    $this->assertEquals(5.0, $this->callPrivateMethod($service, 'formatRating', ['FIVE']));
    $this->assertEquals(4.0, $this->callPrivateMethod($service, 'formatRating', ['FOUR']));
    $this->assertEquals(3.0, $this->callPrivateMethod($service, 'formatRating', ['THREE']));
    $this->assertEquals(2.0, $this->callPrivateMethod($service, 'formatRating', ['TWO']));
    $this->assertEquals(1.0, $this->callPrivateMethod($service, 'formatRating', ['ONE']));
}
```

**Unit Test: formatReviewDate() Converts ISO 8601 to MySQL**
```php
public function test_format_review_date_converts_iso_to_mysql() {
    $service = new GoogleBusinessService();

    $google_date = '2025-09-20T14:30:00Z';
    $result = $this->callPrivateMethod($service, 'formatReviewDate', [$google_date]);

    $this->assertEquals('2025-09-20 14:30:00', $result);
}
```

**Unit Test: Error Handling - 401 Unauthorized**
```php
public function test_fetch_reviews_returns_empty_on_401() {
    // Mock OAuth success
    \WP_Mock::userFunction('wp_remote_post', [
        'return' => ['body' => json_encode(['access_token' => 'test'])],
    ]);

    // Mock 401 API response
    \WP_Mock::userFunction('wp_remote_get', [
        'return' => [
            'response' => ['code' => 401],
            'body' => json_encode(['error' => ['message' => 'Unauthorized']]),
        ],
    ]);

    $service = new GoogleBusinessService();
    $reviews = $service->fetchReviews();

    $this->assertEmpty($reviews);
}
```

**Unit Test: Error Handling - Network Timeout**
```php
public function test_fetch_reviews_returns_empty_on_network_error() {
    // Mock OAuth success
    \WP_Mock::userFunction('wp_remote_post', [
        'return' => ['body' => json_encode(['access_token' => 'test'])],
    ]);

    // Mock network error
    \WP_Mock::userFunction('wp_remote_get', [
        'return' => new \WP_Error('http_request_failed', 'Connection timed out'),
    ]);

    $service = new GoogleBusinessService();
    $reviews = $service->fetchReviews();

    $this->assertEmpty($reviews);
}
```

**Integration Test: Full API Call (Manual Test Only)**
```php
/**
 * This test requires real Google API credentials and should only run manually
 *
 * @group manual
 * @group external-api
 */
public function test_fetch_reviews_from_real_google_api() {
    $this->markTestSkipped('Manual test only - requires real API credentials');

    $service = new GoogleBusinessService();
    $reviews = $service->fetchReviews();

    $this->assertIsArray($reviews);
    // If Bravo Jewelers has reviews, array should not be empty
    // $this->assertNotEmpty($reviews);
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after testing*
