# Story 5.5: Integrate Auto-Assignment with Generation

## Status

Ready for Review

## Story

**As a** content manager,
**I want** images automatically assigned during content generation,
**So that** I don't have to manually select images

## Acceptance Criteria

1. Auto-assignment setting in Settings > Image Library tab:
   - Checkbox: "Auto-assign images during generation" (default: enabled)
   - Help text explaining the feature
2. During generation, if auto-assign enabled:
   - After generating hero block, run image matching algorithm
   - Assign selected image to `hero_image` field
   - If process block generated, assign images to step_image fields
3. Auto-assigned images can be changed manually after generation
4. Generation log includes note if image was auto-assigned
5. If no match and no default image, field left empty (no error)

## Tasks / Subtasks

- [x] Task 1: Add auto-assignment settings (AC: 1)
  - [x] Update SettingsPage with Image Library tab
  - [x] Add checkbox: "Enable auto-assignment"
  - [x] Add help text
  - [x] Save to options: `seo_generator_settings`
  - [x] Default value: enabled (true)

- [x] Task 2: Inject ImageMatchingService into ContentGenerationService (AC: 2)
  - [x] Update ContentGenerationService constructor
  - [x] Add ImageMatchingService parameter
  - [x] Update Plugin.php to pass ImageMatchingService
  - [x] Store as class property

- [x] Task 3: Auto-assign to hero block (AC: 2, 4)
  - [x] Check if auto-assignment enabled in settings
  - [x] After hero block generation, extract context
  - [x] Call ImageMatchingService->findMatchingImage($context)
  - [x] If image found, update hero_image ACF field
  - [x] Log auto-assignment action
  - [x] Handle null result gracefully

- [x] Task 4: Auto-assign to process block steps (AC: 2, 4)
  - [x] After process block generation, loop through steps
  - [x] Extract context for each step
  - [x] Call ImageMatchingService for each step
  - [x] Update step_image field in repeater
  - [x] Log auto-assignment per step
  - [x] Handle null results gracefully

- [x] Task 5: Build context from generated content (AC: 2)
  - [x] Extract focus_keyword from post meta or settings
  - [x] Extract topic from generation context
  - [x] Extract category from post taxonomy
  - [x] Pass context array to ImageMatchingService

- [x] Task 6: Add auto-assignment logging (AC: 4)
  - [x] Log when auto-assignment starts
  - [x] Log context used for matching
  - [x] Log selected image ID
  - [x] Log when no image found
  - [x] Use consistent format with generation logs

- [x] Task 7: Write integration tests (AC: 1-5)
  - [x] Test auto-assignment enabled/disabled
  - [x] Test hero image assignment
  - [x] Test process step image assignment
  - [x] Test graceful handling of no matches
  - [x] Test context extraction
  - [x] Test settings page stores value

- [x] Task 8: Update story documentation
  - [x] Mark all tasks complete
  - [x] Add completion notes
  - [x] List created/modified files
  - [x] Update status to "Ready for Review"

## Dev Notes

### Relevant Architecture Context

**Settings Structure:**
```php
$settings = get_option('seo_generator_settings', [
    'enable_auto_assignment' => true,
    'openai_api_key' => '...',
    'model' => 'gpt-4-turbo-preview',
    // ... other settings
]);
```

**ContentGenerationService Integration:**
```php
class ContentGenerationService {
    private ImageMatchingService $image_matching;

    public function __construct(
        OpenAIService $openai,
        PromptTemplateEngine $prompt_engine,
        BlockContentParser $parser,
        CostTrackingService $cost_tracking,
        ImageMatchingService $image_matching
    ) {
        $this->image_matching = $image_matching;
    }

    public function generateSingleBlock($post_id, $block_type, $context) {
        // Generate content...
        // Update ACF fields...

        // Auto-assign image if enabled
        $this->autoAssignImages($post_id, $block_type, $context, $parsed_content);
    }
}
```

**ACF Field Updates:**
```php
// Hero image
update_field('hero_image', $image_id, $post_id);

// Process step images
update_sub_field(['process_steps', $index + 1, 'step_image'], $image_id, $post_id);
```

**Context Building:**
```php
private function buildImageContext($post_id, $context) {
    $image_context = [];

    // Get focus keyword from context
    if (!empty($context['focus_keyword'])) {
        $image_context['focus_keyword'] = $context['focus_keyword'];
    }

    // Get topic from context
    if (!empty($context['topic'])) {
        $image_context['topic'] = $context['topic'];
    }

    // Get category from post terms
    $categories = get_the_terms($post_id, 'category');
    if ($categories && !is_wp_error($categories)) {
        $image_context['category'] = $categories[0]->name;
    }

    return $image_context;
}
```

**Logging Format:**
```php
error_log(sprintf(
    '[SEO Generator - Auto-Assignment] Post: %d | Block: %s | Image: %s | Context: %s',
    $post_id,
    $block_type,
    $image_id ?? 'none',
    json_encode($context)
));
```

### Testing

**Test Approach:**
- Integration tests focusing on settings and context building
- Cannot fully test OpenAI generation without mocking
- Tests verify ImageMatchingService integration works correctly

**Test File Location:**
- `tests/php/Integration/AutoAssignmentIntegrationTest.php` (new)

**Key Test Scenarios:**
1. Auto-assignment enabled by default ✓
2. Settings page stores auto-assignment value ✓
3. Hero image assigned when enabled ✓
4. No assignment when disabled ✓
5. Context built from post data ✓
6. Process step images assigned ✓
7. Graceful handling when no match ✓
8. Multiple context fields improve matching ✓

**Coding Standards:**
- Follow WordPress coding standards ✓
- Type hint parameters and return values ✓
- Document all methods with PHPDoc ✓
- Use dependency injection ✓
- ABSPATH guard in PHP files ✓
[Source: architecture.md#code-quality-php]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation from Epic 5 | James (Dev Agent) |
| 2025-10-08 | 2.0 | Story completed and ready for review | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (claude-sonnet-4-5-20250929)

### Debug Log References

Story 5.5 Implementation:
- Settings page updated with auto-assignment checkbox
- ContentGenerationService integrated with ImageMatchingService
- Auto-assignment logic added for hero and process blocks
- Integration tests created

### Completion Notes

**Implementation Summary:**

All 8 tasks completed successfully. The auto-assignment integration connects the image library system with content generation:

1. **Settings Page** (includes/Admin/SettingsPage.php):
   - Added Image Library section with auto-assignment checkbox
   - Default value: enabled (true)
   - Help text explaining the feature
   - Sanitization handles checkbox value correctly
   - Stored in `seo_generator_settings` option

2. **ContentGenerationService Integration** (includes/Services/ContentGenerationService.php):
   - Added ImageMatchingService as constructor dependency
   - New method: `autoAssignImages()` - Routes to block-specific handlers
   - New method: `assignHeroImage()` - Assigns image to hero_image field
   - New method: `assignProcessImages()` - Assigns images to each process step
   - New method: `buildImageContext()` - Extracts context from post data
   - New method: `isAutoAssignmentEnabled()` - Checks setting

3. **Hero Block Auto-Assignment**:
   - After hero content generated and ACF fields updated
   - Builds context from focus_keyword, topic, category
   - Calls ImageMatchingService->findMatchingImage()
   - Updates hero_image ACF field if image found
   - Logs assignment with context

4. **Process Block Auto-Assignment**:
   - Loops through all process_steps in parsed content
   - For each step, adds step_title to context for better matching
   - Calls ImageMatchingService for each step
   - Updates step_image field in ACF repeater
   - Logs each assignment

5. **Context Building**:
   - Extracts `focus_keyword` from generation context
   - Extracts `topic` from generation context
   - Extracts `category` from post taxonomy terms
   - For process steps, adds step_title to topic
   - Returns array compatible with ImageMatchingService

6. **Logging**:
   - Format: `[SEO Generator - Auto-Assignment] Post: {id} | Block: {type} | Image: {id} | Context: {json}`
   - Logs successful assignments with image ID
   - Logs when no image found (Image: none)
   - Includes full context JSON for debugging

7. **Dependency Injection** (includes/Plugin.php):
   - Updated ContentGenerationService instantiation
   - Passes ImageMatchingService as 5th parameter
   - Maintains proper dependency chain

8. **Integration Tests** (tests/php/Integration/AutoAssignmentIntegrationTest.php - 240+ lines):
   - 8 test methods covering key scenarios
   - Tests settings storage and retrieval
   - Tests image matching with various contexts
   - Tests context building from post data
   - Tests graceful handling when no match
   - Cannot fully test OpenAI generation (requires mocking)

**Key Technical Decisions:**

- Settings stored in same option as API settings (`seo_generator_settings`)
- Auto-assignment happens AFTER ACF fields updated (ensures content exists)
- Process steps get individual context (allows different images per step)
- Graceful degradation: If ImageMatchingService returns null, field left empty (no error)
- Logging uses same format as ImageMatchingService for consistency
- update_sub_field() used for ACF repeater fields (correct ACF API)
- For process steps, index is 1-based (ACF repeater convention)

**Integration Flow Example:**

```php
// User generates hero block for "Platinum Mens Wedding Rings"

1. ContentGenerationService->generateSingleBlock(123, 'hero', [...])
   ↓
2. OpenAI generates hero content
   ↓
3. Content parsed and ACF fields updated
   ↓
4. autoAssignImages() called
   ↓
5. isAutoAssignmentEnabled() → true
   ↓
6. assignHeroImage() called
   ↓
7. buildImageContext() extracts:
   - focus_keyword: "platinum mens wedding rings"
   - topic: "wedding bands"
   - category: "Jewelry"
   ↓
8. ImageMatchingService->findMatchingImage([...])
   - Extracts tags: ['platinum', 'mens', 'wedding', 'rings', 'bands', 'jewelry']
   - Attempts matching with fallback
   - Returns image ID 456
   ↓
9. update_field('hero_image', 456, 123)
   ↓
10. Logs: [SEO Generator - Auto-Assignment] Post: 123 | Block: hero | Image: 456 | Context: {...}
```

**Known Limitations:**

- Only hero and process blocks get auto-assignment (others don't have image fields)
- Process steps all use base context + step_title (could enhance with step description)
- Cannot override auto-assigned image during generation (must edit after)
- No UI feedback during generation that images were auto-assigned
- Category limited to first term only (could enhance to use multiple)

**Future Enhancements (Not in MVP):**

- Add auto-assignment for other block types as image fields added
- Show preview of selected image during generation
- Allow manual image selection override in generation UI
- Track image usage statistics
- Prevent same image from being assigned to all steps

**Validation Steps:**

To validate the implementation:
1. Go to Settings > SEO Generator > Image Library tab
2. Verify "Auto-assign images" checkbox is present and checked
3. Upload images to library with tags matching your content
4. Generate hero block content
5. Verify hero_image field is populated after generation
6. Check debug.log for auto-assignment logging (if WP_DEBUG enabled)
7. Generate process block
8. Verify each step has different step_image assigned
9. Uncheck auto-assignment setting
10. Generate new content, verify no images assigned
11. Run tests: `vendor/bin/phpunit tests/php/Integration/AutoAssignmentIntegrationTest.php`

### File List

**Created:**
- `tests/php/Integration/AutoAssignmentIntegrationTest.php` (240+ lines)
- `docs/stories/5.5.integrate-auto-assignment-with-generation.md` (this file)

**Modified:**
- `includes/Admin/SettingsPage.php` (added Image Library section, auto-assignment field, sanitization)
- `includes/Services/ContentGenerationService.php` (added ImageMatchingService dependency, auto-assignment methods)
- `includes/Plugin.php` (updated ContentGenerationService instantiation)

## QA Results

*This section will be populated by QA Agent after story completion*
