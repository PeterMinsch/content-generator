
# Story 6.1: Create CSV Import Admin Page

**Epic:** 6 - CSV Import & Bulk Processing
**Story:** 6.1
**Estimated Effort:** 2-3 hours

---

## Status

Ready for Review

---

## Story

**As a** site administrator
**I want** an admin page to import keywords from CSV
**so that** I can create multiple pages at once from SEO research

---

## Acceptance Criteria

1. Admin page created: "Content Generator > Import Keywords"
2. Page layout includes:
   - File upload field (accepts .csv files only)
   - "Upload & Map" button
   - Instructions/help text explaining CSV format
3. After upload, page displays:
   - Column mapping interface (see Story 6.2)
   - Preview of first 3 rows
   - Import options
   - "Import" button
4. Progress indicator shown during import
5. Completion summary after import:
   - Total rows processed
   - Pages created successfully
   - Any errors encountered

---

## Tasks / Subtasks

- [x] **Task 1: Add Import Menu Item to AdminMenu** (AC: 1)
  - [x] Open `includes/Admin/AdminMenu.php`
  - [x] Add import page property: `private $import_page;`
  - [x] Update constructor to accept `ImportPage $import_page` parameter
  - [x] Add submenu in `addMenuItems()` method after Image Library:
    ```php
    add_submenu_page(
        self::MENU_SLUG,
        __( 'Import Keywords', 'seo-generator' ),
        __( 'Import Keywords', 'seo-generator' ),
        'edit_posts',
        'seo-import-keywords',
        array( $this, 'renderImportPage' )
    );
    ```
  - [x] Add render method: `public function renderImportPage(): void { $this->import_page->render(); }`
  - [x] Update Plugin.php to instantiate ImportPage and pass to AdminMenu constructor

- [x] **Task 2: Create ImportPage Class** (AC: 1, 2)
  - [x] Create file `includes/Admin/ImportPage.php`
  - [x] Add namespace `SEOGenerator\Admin;`
  - [x] Add ABSPATH check: `defined( 'ABSPATH' ) || exit;`
  - [x] Create class `ImportPage` with PHPDoc header
  - [x] Add public method `render(): void`
  - [x] Implement capability check: `if ( ! current_user_can( 'edit_posts' ) ) { wp_die(...); }`
  - [x] Load template file at `templates/admin/import.php` using same pattern as ImageLibraryPage

- [x] **Task 3: Create Import Page Template** (AC: 2, 3)
  - [x] Create file `templates/admin/import.php`
  - [x] Add ABSPATH check
  - [x] Enqueue admin CSS for consistent styling with other admin pages
  - [x] Create `.wrap` div container
  - [x] Add page title `<h1>Import Keywords</h1>`
  - [x] Add instructions section explaining CSV format requirements:
    - Expected columns: keyword, intent, search_volume, etc.
    - Supported formats: .csv only
    - Max file size limit (from `wp_max_upload_size()`)
  - [x] Create upload form with:
    - `enctype="multipart/form-data"`
    - Hidden field: `<input type="hidden" name="action" value="seo_upload_csv">`
    - Nonce field: `wp_nonce_field( 'seo_csv_upload', 'seo_csv_nonce' )`
    - File input: `<input type="file" name="csv_file" accept=".csv" required>`
    - Submit button: "Upload & Map"
  - [x] Add placeholder divs for column mapping (Story 6.2), preview (Story 6.2), and results (Story 6.4)

- [x] **Task 4: Implement CSV Upload Handler** (AC: 2, 4)
  - [x] In `ImportPage.php`, add method `handleUpload(): array`
  - [x] Check nonce: `check_admin_referer( 'seo_csv_upload', 'seo_csv_nonce' )`
  - [x] Verify file was uploaded: `isset( $_FILES['csv_file'] )`
  - [x] Check for upload errors: `$_FILES['csv_file']['error'] === UPLOAD_ERR_OK`
  - [x] Validate file extension is `.csv` using `pathinfo()`
  - [x] Check file size against `wp_max_upload_size()`
  - [x] Move uploaded file to WordPress uploads directory:
    ```php
    $upload_dir = wp_upload_dir();
    $temp_file = $upload_dir['path'] . '/' . 'import_' . time() . '.csv';
    move_uploaded_file( $_FILES['csv_file']['tmp_name'], $temp_file );
    ```
  - [x] Store temp file path in user meta or transient for later processing
  - [x] Return array with: `['success' => true, 'file_path' => $temp_file, 'message' => '...']`
  - [x] On error, return: `['success' => false, 'error' => '...']`

- [x] **Task 5: Add Progress Indicator UI** (AC: 4)
  - [x] In template, add hidden progress div:
    ```html
    <div id="import-progress" style="display:none;">
      <h3>Processing Import...</h3>
      <div class="progress-bar">
        <div class="progress-fill" style="width:0%"></div>
      </div>
      <p class="progress-text">0 of 0 rows processed</p>
    </div>
    ```
  - [x] Add basic CSS for progress bar styling
  - [x] JavaScript will update this in Stories 6.2-6.4

- [x] **Task 6: Add Completion Summary Display** (AC: 5)
  - [x] In template, add hidden results div:
    ```html
    <div id="import-results" style="display:none;">
      <h3>Import Complete</h3>
      <div class="notice notice-success">
        <p><strong id="total-processed">0</strong> rows processed</p>
        <p><strong id="pages-created">0</strong> pages created successfully</p>
      </div>
      <div id="error-list" style="display:none;">
        <h4>Errors Encountered:</h4>
        <ul id="error-items"></ul>
      </div>
      <a href="edit.php?post_type=seo-page" class="button">View Created Pages</a>
    </div>
    ```
  - [x] JavaScript will populate this in Story 6.4

- [x] **Task 7: Add Unit Tests** (Testing)
  - [x] Create test file `tests/php/Admin/ImportPageTest.php`
  - [x] Test capability check denies unauthorized users
  - [x] Test render method loads template file
  - [x] Test handleUpload validates file extension correctly
  - [x] Test handleUpload rejects non-CSV files
  - [x] Test handleUpload checks file size limits
  - [x] Test handleUpload moves file to uploads directory

---

## Dev Notes

### Architecture Context

**Project:** WordPress SEO Content Generator Plugin for Jewelry E-Commerce
[Source: docs/prd.md, docs/architecture.md]

**Purpose of This Story:**
Create the admin page foundation for CSV keyword import functionality. This is the first story in Epic 6 which enables bulk page creation from SEMrush CSV exports. This story focuses ONLY on the admin page structure and file upload - column mapping (6.2) and processing (6.3-6.4) come in subsequent stories.

### Admin Page Pattern

[Source: architecture.md#Plugin Architecture, includes/Admin/ImageLibraryPage.php]

All admin pages in this plugin follow a consistent pattern:

**Class Structure:**
- Location: `includes/Admin/{PageName}Page.php`
- Namespace: `SEOGenerator\Admin`
- Main method: `public function render(): void`
- Capability check at start of render: `if ( ! current_user_can( 'edit_posts' ) ) { wp_die(...); }`
- Load template using absolute path: `plugin_dir_path( dirname( __DIR__ ) ) . 'templates/admin/{template}.php'`

**Template Structure:**
- Location: `templates/admin/{template}.php`
- Always start with `defined( 'ABSPATH' ) || exit;`
- Wrap content in `<div class="wrap">...</div>`
- Use WordPress admin classes for consistency
- Enqueue assets using `wp_enqueue_style()` and `wp_enqueue_script()`

**Menu Integration:**
- Admin pages are registered in `includes/Admin/AdminMenu.php`
- Use dependency injection - page instance passed to AdminMenu constructor
- Menu items added in `addMenuItems()` method using `add_submenu_page()`
- Render methods delegate to page instance's `render()` method

### File Upload Requirements

[Source: docs/prd/epic-6-csv-import.md#Technical Requirements]

**Validation Rules:**
- Extension: Must be `.csv` (check with `pathinfo($filename, PATHINFO_EXTENSION)`)
- File Size: Check against `wp_max_upload_size()` (returns bytes)
- Upload Errors: Check `$_FILES['csv_file']['error'] === UPLOAD_ERR_OK`

**Security:**
- Nonce verification: `check_admin_referer( 'seo_csv_upload', 'seo_csv_nonce' )`
- Capability check: `current_user_can( 'edit_posts' )`
- Sanitize filename: Use WordPress `sanitize_file_name()`
- Validate MIME type: Use `wp_check_filetype()`

**Storage:**
- Store uploaded file in WordPress uploads directory
- Get uploads dir: `$upload_dir = wp_upload_dir();`
- Path: `$upload_dir['path'] . '/' . 'import_' . time() . '.csv'`
- Use unique filename with timestamp to avoid collisions
- Store path in transient for processing: `set_transient( 'import_file_' . get_current_user_id(), $file_path, HOUR_IN_SECONDS )`

### WordPress Functions Reference

[Source: architecture.md#Tech Stack, docs/prd.md#Appendix]

**Admin Pages:**
- `add_submenu_page( $parent, $title, $menu_title, $capability, $slug, $callback )`
- `current_user_can( $capability )` - Check user permissions
- `wp_die( $message )` - Stop execution and show error
- `get_admin_page_title()` - Get current page title
- `admin_url( $path )` - Generate admin URL

**File Handling:**
- `wp_upload_dir()` - Get uploads directory info
- `wp_max_upload_size()` - Get max upload size in bytes
- `sanitize_file_name( $filename )` - Sanitize filename
- `wp_check_filetype( $filename )` - Validate file type
- `move_uploaded_file( $from, $to )` - Move uploaded file

**Security & Sanitization:**
- `wp_nonce_field( $action, $name )` - Create nonce field
- `check_admin_referer( $action, $name )` - Verify nonce
- `sanitize_text_field( $value )` - Sanitize text input
- `esc_html( $value )` - Escape HTML output
- `esc_url( $value )` - Escape URL output
- `esc_attr( $value )` - Escape HTML attribute

**Transients (Temporary Storage):**
- `set_transient( $key, $value, $expiration )` - Store temporary data
- `get_transient( $key )` - Retrieve temporary data
- `delete_transient( $key )` - Delete temporary data

### CSV Format Guidelines for Users

[Source: docs/prd/epic-6-csv-import.md#Import Interface]

The instructions section should explain:

**Required Columns:**
- At least one column that can map to "Page Title" (typically: keyword, title, query)

**Optional Columns:**
- Focus Keyword (keyword, search_query)
- Topic Category (intent, category, topic)
- Search Volume (volume, searches) - can be skipped
- Image URL (image_url, image)

**Example CSV:**
```
keyword,intent,search_volume,image_url
platinum wedding bands,commercial,1000,https://example.com/image.jpg
men's tungsten rings,commercial,800,
```

**File Requirements:**
- Format: .csv only
- Encoding: UTF-8 recommended
- Max rows: 1000 per import (configurable)
- Max file size: Server limit (typically 2-8MB)

### Project Structure Notes

[Source: docs/architecture.md#Unified Project Structure]

**New Files Created:**
```
includes/Admin/ImportPage.php          # Admin page class
templates/admin/import.php             # Page template
tests/php/Admin/ImportPageTest.php     # Unit tests
```

**Modified Files:**
```
includes/Admin/AdminMenu.php           # Add import menu item
includes/Plugin.php                    # Instantiate ImportPage
```

**Dependencies:**
- Epic 1 (Foundation): Uses `seo-page` post type, `seo-topic` taxonomy, ACF fields
- Epic 2 (Core Generation): Optional background generation will use GenerationService (Story 6.5)

### Testing

[Source: docs/architecture.md#Testing Strategy]

**Test Framework:** PHPUnit 9.x with WordPress Test Framework
**Test Location:** `tests/php/Admin/ImportPageTest.php`
**Test File Naming:** `{ClassName}Test.php`

**Required Test Coverage:**
1. **Capability Check Test**
   - Verify unauthorized user receives `wp_die()` error
   - Use WordPress test helper: `$this->setExpectedException('WPDieException')`

2. **Template Loading Test**
   - Mock template file existence
   - Verify correct path construction
   - Test fallback message when template missing

3. **File Upload Validation Tests**
   - Valid .csv file: Should accept and move to uploads directory
   - Invalid extension (.txt, .xlsx): Should reject with error message
   - File size exceeds limit: Should reject with error
   - Missing file: Should return error
   - Upload error (UPLOAD_ERR_*): Should handle gracefully

4. **Security Tests**
   - Invalid nonce: Should fail with security error
   - Missing capability: Should deny access
   - Malicious filename: Should sanitize correctly

**Test Data Setup:**
- Create temporary test CSV files in `tests/fixtures/`
- Clean up uploaded files in `tearDown()` method
- Use WordPress test functions: `set_current_user()`, `grant_cap()`

**Running Tests:**
```bash
composer run test
# Or specific file:
./vendor/bin/phpunit tests/php/Admin/ImportPageTest.php
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation from Epic 6.1 | Bob (Scrum Master) |
| 2025-01-XX | 1.1 | Implementation completed - all tasks finished | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No errors encountered during implementation. All code followed established patterns from ImageLibraryPage.

### Completion Notes List

1. ✅ Successfully created ImportPage class following existing admin page pattern
2. ✅ Added menu integration to AdminMenu with proper dependency injection
3. ✅ Created comprehensive template with:
   - Detailed CSV format instructions for users
   - SEMrush-style column examples
   - Security features (nonce, capability checks, file validation)
   - Placeholder sections for Stories 6.2-6.4 (column mapping, preview, processing)
4. ✅ Implemented handleUpload() method with:
   - Nonce verification
   - File extension validation (.csv only)
   - File size checking against wp_max_upload_size()
   - Secure file storage in WordPress uploads directory
   - Transient storage of file path for later processing
   - Comprehensive error handling
5. ✅ Created admin CSS file for consistent styling
6. ✅ Built 10 comprehensive unit tests covering:
   - Capability checks (unauthorized users denied)
   - Template rendering
   - File upload validation (extension, size, errors)
   - Security (nonce verification, filename sanitization)
   - All tests follow existing test patterns in the project

**Story Scope:** This story focuses ONLY on admin page structure and file upload UI. Column mapping (Story 6.2) and CSV processing (Stories 6.3-6.4) are deferred as planned.

### File List

**Created Files:**
- `includes/Admin/ImportPage.php` - Main admin page class with render() and handleUpload() methods
- `templates/admin/import.php` - Admin page template with upload form, instructions, and placeholders
- `assets/css/admin-import.css` - Styling for import page UI
- `tests/php/Admin/ImportPageTest.php` - Comprehensive unit tests (10 test cases)

**Modified Files:**
- `includes/Admin/AdminMenu.php` - Added import_page property, updated constructor, added submenu and renderImportPage() method
- `includes/Plugin.php` - Instantiated ImportPage and passed to AdminMenu constructor

---

## QA Results

_To be filled by QA agent after implementation review_
