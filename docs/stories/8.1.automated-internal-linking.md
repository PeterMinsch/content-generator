# Story 8.1: Automated Internal Linking System

**Epic:** 8 - Internal Linking & Content Network
**Story Points:** 8
**Priority:** High
**Status:** Draft

---

## User Story

**As a** content manager
**I want** automatically generated internal links between related SEO pages
**So that** I can improve SEO, user navigation, and PageRank distribution without manual link management

---

## Background

Internal linking is critical for SEO success:
- Helps Google discover and understand site structure
- Distributes PageRank equity across pages
- Improves user engagement (reduces bounce rate)
- Builds topical authority through content clusters

**Current state:**
- Pages are generated in isolation with no interconnection
- No internal linking strategy
- Site structure is flat (no content network)
- Missed SEO opportunity

**Desired state:**
- Pages automatically link to related content
- Bidirectional linking (Aâ†’B and Bâ†’A)
- Links stay fresh as new content is added
- Zero manual intervention required

---

## Acceptance Criteria

### AC1: Link Discovery
- **Given** a page with `seo_focus_keyword` = "diamond clarity grades"
- **When** the page generation completes
- **Then** the system finds 3-5 related pages based on keyword similarity and topic taxonomy
- **And** stores related page IDs in post meta `_related_links`

### AC2: Link Rendering
- **Given** a page with stored related links
- **When** a user visits the page on the frontend
- **Then** a "Related Information" section displays at the bottom
- **And** shows 3-5 links to related pages
- **And** uses current page titles (not cached)
- **And** skips deleted or unpublished pages

### AC3: Automatic Refresh
- **Given** the site has published SEO pages
- **When** a weekly cron job runs
- **Then** all pages recalculate their related links
- **And** new pages appear in related link suggestions
- **And** deleted pages are removed from suggestions

### AC4: Manual Refresh
- **Given** an admin editing a page
- **When** they click "Refresh Related Links" button
- **Then** the page's related links are recalculated immediately
- **And** the updated links display on the frontend

### AC5: Performance
- **Given** a site with 1000+ pages
- **When** calculating related links for one page
- **Then** the operation completes in <100ms
- **And** page load time increases by <5ms (after caching)

### AC6: Smart Matching
- **Given** two pages with similar keywords
- **When** calculating similarity scores
- **Then** keyword importance is weighted (e.g., "engagement" > "ring")
- **And** pages in the same `seo-topic` taxonomy rank higher
- **And** generic keywords (ring, band) have lower weight

---

## Technical Specification

### Database Schema

**New post meta key:**
```
_related_links = [
    'generated_at' => 1704067200,  // Unix timestamp
    'version' => 1,                // Schema version
    'pages' => [
        [
            'id' => 125,
            'score' => 85,
            'shared_keywords' => ['diamond', 'clarity', 'quality']
        ],
        [
            'id' => 89,
            'score' => 70,
            'shared_keywords' => ['diamond', 'quality']
        ]
    ]
]
```

**No new database tables required** - uses existing `wp_postmeta`

---

### Architecture

```
Page Generation Complete
    â†“
[InternalLinkingService]
    â”œâ”€â†’ Extract focus keyword from ACF
    â”œâ”€â†’ Get seo-topic taxonomy
    â”œâ”€â†’ Find candidate pages (same topic first)
    â”œâ”€â†’ Score candidates by keyword similarity
    â”œâ”€â†’ Store top 5 in post meta
    â””â”€â†’ Log to debug (optional)

Frontend Page Load
    â†“
Template: single-seo-page.php
    â”œâ”€â†’ Read _related_links post meta
    â”œâ”€â†’ For each page ID:
    â”‚   â”œâ”€â†’ get_post() - current data
    â”‚   â”œâ”€â†’ Check if published
    â”‚   â””â”€â†’ Render link with current title
    â””â”€â†’ Output "Related Information" section

Weekly Cron Job
    â†“
[InternalLinkingService::refreshAllLinks()]
    â”œâ”€â†’ Get all published seo-page posts
    â”œâ”€â†’ For each page:
    â”‚   â”œâ”€â†’ Recalculate related links
    â”‚   â””â”€â†’ Update post meta
    â””â”€â†’ Log completion
```

---

### Key Classes

#### **1. InternalLinkingService**
Location: `includes/Services/InternalLinkingService.php`

```php
class InternalLinkingService {
    /**
     * Find related pages for a given post
     *
     * @param int $post_id Post ID
     * @return array Related page data with scores
     */
    public function findRelatedPages(int $post_id): array;

    /**
     * Store related links in post meta
     *
     * @param int $post_id Post ID
     * @param array $related_pages Related page data
     */
    public function storeRelatedLinks(int $post_id, array $related_pages): void;

    /**
     * Get stored related links for rendering
     *
     * @param int $post_id Post ID
     * @return array|null Related page IDs or null
     */
    public function getRelatedLinks(int $post_id): ?array;

    /**
     * Refresh related links for one page
     *
     * @param int $post_id Post ID
     */
    public function refreshLinks(int $post_id): void;

    /**
     * Refresh related links for all pages
     *
     * @return array Stats (count, time)
     */
    public function refreshAllLinks(): array;
}
```

#### **2. KeywordMatcher**
Location: `includes/Services/KeywordMatcher.php`

```php
class KeywordMatcher {
    /**
     * Calculate similarity score between two pages
     *
     * @param int $page1_id First page ID
     * @param int $page2_id Second page ID
     * @return int Similarity score (0-100)
     */
    public function calculateSimilarity(int $page1_id, int $page2_id): int;

    /**
     * Extract keywords from focus keyword field
     *
     * @param string $focus_keyword SEO focus keyword
     * @return array Weighted keywords
     */
    public function extractKeywords(string $focus_keyword): array;

    /**
     * Score keyword overlap with weighting
     *
     * @param array $keywords1 First keyword set
     * @param array $keywords2 Second keyword set
     * @return int Overlap score
     */
    public function scoreOverlap(array $keywords1, array $keywords2): int;
}
```

---

### Integration Points

#### **Hook 1: After Page Generation**
Location: `includes/Services/GenerationService.php` line ~148

```php
// After Yoast sync
$yoast = new YoastIntegrationService();
if ($yoast->isYoastActive()) {
    $yoast->syncToYoast($post_id);
}

// ADD: Generate internal links
$linking = new InternalLinkingService();
$related = $linking->findRelatedPages($post_id);
$linking->storeRelatedLinks($post_id, $related);
error_log("[Internal Linking] Generated {count($related)} links for post {$post_id}");
```

#### **Hook 2: Weekly Cron**
Location: `includes/Cron/LinkRefresh.php` (new file)

```php
// Register cron job
add_action('wp', 'schedule_link_refresh');
function schedule_link_refresh() {
    if (!wp_next_scheduled('seo_generator_refresh_links')) {
        wp_schedule_event(time(), 'weekly', 'seo_generator_refresh_links');
    }
}

// Execute refresh
add_action('seo_generator_refresh_links', function() {
    $linking = new InternalLinkingService();
    $stats = $linking->refreshAllLinks();
    error_log("[Internal Linking] Refreshed {$stats['count']} pages in {$stats['time']}s");
});
```

#### **Hook 3: Frontend Rendering**
Location: `single-seo-page.php` line ~603 (after CTA block)

```php
// After CTA block
seo_generator_render_block('cta');

// ADD: Related links section
$linking = new InternalLinkingService();
$related = $linking->getRelatedLinks(get_the_ID());

if ($related) {
    get_template_part('template-parts/related-links', null, ['pages' => $related]);
}
```

#### **Template Part**
Location: `template-parts/related-links.php` (new file)

```php
<?php
/**
 * Related Links Section
 *
 * @var array $args['pages'] Array of related page IDs
 */

$pages = $args['pages'] ?? [];

if (empty($pages)) {
    return;
}
?>

<section class="related-information">
    <h3><?php _e('Related Information', 'seo-generator'); ?></h3>
    <ul class="related-links-list">
        <?php foreach ($pages as $page_data) : ?>
            <?php
            $page_id = $page_data['id'];
            $page = get_post($page_id);

            // Skip deleted or unpublished pages
            if (!$page || $page->post_status !== 'publish') {
                continue;
            }
            ?>
            <li>
                <a href="<?php echo esc_url(get_permalink($page_id)); ?>">
                    <?php echo esc_html($page->post_title); ?>
                </a>
            </li>
        <?php endforeach; ?>
    </ul>
</section>
```

---

### Keyword Weighting Logic

**High-value keywords** (weight: 3):
- engagement, wedding, eternity, anniversary
- bridal, proposal, bride, groom

**Medium-value keywords** (weight: 2):
- Metals: platinum, gold, white-gold, rose-gold, silver
- Stones: diamond, sapphire, ruby, emerald, moissanite
- Styles: vintage, modern, classic, art-deco, halo

**Low-value keywords** (weight: 0.5):
- Generic: ring, band, jewelry, necklace, bracelet

**Example calculation:**
```
Page A: "platinum engagement ring" = [platinum:2, engagement:3, ring:0.5]
Page B: "platinum wedding band"    = [platinum:2, wedding:3, band:0.5]

Similarity = (2Ã—2) + (3Ã—3) + (0.5Ã—0.5) = 4 + 9 + 0.25 = 13.25
```

---

### Matching Algorithm

**Step 1: Pre-filter by Topic**
```php
// Only search within same seo-topic first
$candidates = get_posts([
    'post_type' => 'seo-page',
    'post_status' => 'publish',
    'tax_query' => [[
        'taxonomy' => 'seo-topic',
        'terms' => $current_topic->term_id
    ]],
    'exclude' => [$current_post_id]
]);
```

**Step 2: Score Each Candidate**
```php
foreach ($candidates as $candidate) {
    $score = 0;

    // Keyword similarity (0-50 points)
    $keyword_score = $this->scoreKeywordOverlap($current_keywords, $candidate_keywords);
    $score += min(50, $keyword_score);

    // Same topic bonus (20 points)
    if ($same_topic) {
        $score += 20;
    }

    // Title contains focus keyword (15 points)
    if (stripos($candidate->post_title, $focus_keyword) !== false) {
        $score += 15;
    }

    // Meta description match (10 points)
    if (stripos($candidate_meta, $focus_keyword) !== false) {
        $score += 10;
    }

    // Recently published penalty (-10 points if <7 days old)
    $age_days = (time() - strtotime($candidate->post_date)) / DAY_IN_SECONDS;
    if ($age_days < 7) {
        $score -= 10;
    }

    $scored_candidates[] = ['id' => $candidate->ID, 'score' => $score];
}
```

**Step 3: Sort and Return Top 5**
```php
usort($scored_candidates, fn($a, $b) => $b['score'] - $a['score']);
return array_slice($scored_candidates, 0, 5);
```

---

## User Interface

### Admin: Edit Post Screen

**Location:** Below publish button in sidebar

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Publish                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: Draft                   â”‚
â”‚ Visibility: Public              â”‚
â”‚                                 â”‚
â”‚ [Publish]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Related Links                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Last updated: 2 days ago        â”‚
â”‚                                 â”‚
â”‚ â€¢ Diamond Clarity Guide         â”‚
â”‚ â€¢ Understanding Diamond Quality â”‚
â”‚ â€¢ Diamond Buying Guide          â”‚
â”‚                                 â”‚
â”‚ [ğŸ”„ Refresh Links]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Admin: Settings Page

**Location:** Content Generator â†’ Settings â†’ Internal Linking tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internal Linking Settings                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ â˜‘ Enable automatic internal linking            â”‚
â”‚                                                 â”‚
â”‚ Maximum links per page:                         â”‚
â”‚ [5] â–¼                                           â”‚
â”‚ (Shows 3-5 most relevant related pages)         â”‚
â”‚                                                 â”‚
â”‚ Minimum similarity score:                       â”‚
â”‚ [30] â–¼                                          â”‚
â”‚ (Higher = more selective, lower = more links)   â”‚
â”‚                                                 â”‚
â”‚ Refresh schedule:                               â”‚
â”‚ â¦¿ Weekly (recommended)                          â”‚
â”‚ â—‹ Daily                                         â”‚
â”‚ â—‹ Monthly                                       â”‚
â”‚                                                 â”‚
â”‚ Link position:                                  â”‚
â”‚ â¦¿ After CTA block                               â”‚
â”‚ â—‹ After FAQs block                              â”‚
â”‚ â—‹ Custom (use shortcode)                        â”‚
â”‚                                                 â”‚
â”‚ [Save Settings]                                 â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Maintenance                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ Last refresh: January 8, 2024 at 3:00 AM       â”‚
â”‚ Next refresh: January 15, 2024 at 3:00 AM      â”‚
â”‚                                                 â”‚
â”‚ [ğŸ”„ Refresh All Links Now]                     â”‚
â”‚ (May take several minutes for large sites)      â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Frontend: Related Links Section

**Rendered HTML:**
```html
<section class="related-information">
    <h3>Related Information</h3>
    <ul class="related-links-list">
        <li><a href="/diamond-clarity-guide">Diamond Clarity Guide</a></li>
        <li><a href="/diamond-quality">Understanding Diamond Quality</a></li>
        <li><a href="/buying-guide">Complete Diamond Buying Guide</a></li>
    </ul>
</section>
```

**CSS (basic styling):**
```css
.related-information {
    margin-top: 3rem;
    padding: 2rem;
    background: #f9f9f9;
    border-left: 4px solid #0073aa;
}

.related-information h3 {
    margin-top: 0;
    font-size: 1.5rem;
}

.related-links-list {
    list-style: none;
    padding: 0;
}

.related-links-list li {
    margin: 0.5rem 0;
}

.related-links-list a {
    color: #0073aa;
    text-decoration: none;
    font-weight: 500;
}

.related-links-list a:hover {
    text-decoration: underline;
}
```

---

## Testing Strategy

### Unit Tests

**Test: Keyword Extraction**
```php
public function test_extract_keywords_from_focus_keyword() {
    $matcher = new KeywordMatcher();

    $keywords = $matcher->extractKeywords('14k white gold diamond engagement ring');

    $this->assertArrayHasKey('white-gold', $keywords);
    $this->assertArrayHasKey('diamond', $keywords);
    $this->assertArrayHasKey('engagement', $keywords);
    $this->assertEquals(2, $keywords['white-gold']); // Metal weight
    $this->assertEquals(3, $keywords['engagement']); // High-value weight
}
```

**Test: Similarity Scoring**
```php
public function test_calculate_similarity_with_shared_keywords() {
    $matcher = new KeywordMatcher();

    // Create mock posts
    $post1 = $this->factory->post->create(['post_type' => 'seo-page']);
    $post2 = $this->factory->post->create(['post_type' => 'seo-page']);

    update_field('seo_focus_keyword', 'platinum engagement ring', $post1);
    update_field('seo_focus_keyword', 'platinum wedding band', $post2);

    $score = $matcher->calculateSimilarity($post1, $post2);

    $this->assertGreaterThan(0, $score);
}
```

**Test: Link Storage**
```php
public function test_store_and_retrieve_related_links() {
    $linking = new InternalLinkingService();
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);

    $related = [
        ['id' => 123, 'score' => 85],
        ['id' => 456, 'score' => 70]
    ];

    $linking->storeRelatedLinks($post_id, $related);
    $retrieved = $linking->getRelatedLinks($post_id);

    $this->assertEquals(2, count($retrieved));
    $this->assertEquals(123, $retrieved[0]['id']);
}
```

### Integration Tests

**Test: End-to-End Link Generation**
```php
public function test_links_generated_after_page_creation() {
    // Create pages
    $page1 = $this->create_seo_page('Diamond Clarity Guide');
    $page2 = $this->create_seo_page('Diamond Quality Factors');

    // Trigger link generation
    $linking = new InternalLinkingService();
    $linking->refreshLinks($page1);

    // Verify links stored
    $related = $linking->getRelatedLinks($page1);
    $this->assertContains($page2, array_column($related, 'id'));
}
```

**Test: Frontend Rendering**
```php
public function test_related_links_display_on_frontend() {
    $post_id = $this->create_seo_page('Test Page');

    // Store mock links
    update_post_meta($post_id, '_related_links', [
        'pages' => [
            ['id' => 123, 'score' => 85]
        ]
    ]);

    // Get page output
    $this->go_to(get_permalink($post_id));
    $output = get_echo('the_content');

    $this->assertStringContainsString('Related Information', $output);
    $this->assertStringContainsString('related-links-list', $output);
}
```

### Manual QA Checklist

- [ ] Generate 5 pages with similar keywords
- [ ] Verify each page shows 3-5 related links
- [ ] Check that links are bidirectional (Aâ†’B and Bâ†’A)
- [ ] Delete a page, verify broken link doesn't display
- [ ] Edit a page title, verify link text updates on related pages
- [ ] Click "Refresh Links" button, verify links update
- [ ] Wait for weekly cron, verify all links refresh
- [ ] Check performance with 1000+ pages (< 100ms calculation)
- [ ] Verify no duplicate links on same page
- [ ] Test with pages in different topics (lower relevance)

---

## Performance Requirements

### Calculation Performance
- Single page link calculation: < 100ms
- Full site refresh (1000 pages): < 5 minutes
- Frontend rendering overhead: < 5ms per page

### Database Impact
- Storage per page: ~200 bytes (5 links Ã— 40 bytes)
- 1000 pages = 200KB total (negligible)
- No additional tables required

### Caching Strategy
```php
// Cache related links for 1 hour on frontend
$cache_key = 'related_links_' . $post_id;
$related = wp_cache_get($cache_key);

if (false === $related) {
    $related = $linking->getRelatedLinks($post_id);
    wp_cache_set($cache_key, $related, '', HOUR_IN_SECONDS);
}
```

---

## SEO Benefits

### Expected Improvements

1. **Internal Link Equity Distribution**
   - Each page receives 3-5 incoming links
   - No orphan pages (every page is discoverable)
   - PageRank flows through content network

2. **Topical Authority Signals**
   - Pages in same topic link together (content silos)
   - Clear site structure for Google
   - Related content reinforces expertise

3. **User Engagement Metrics**
   - Lower bounce rate (users click related links)
   - Higher pages per session
   - Longer time on site
   - Better engagement = ranking boost

4. **Crawl Efficiency**
   - Googlebot discovers pages faster
   - Full site crawled more frequently
   - New content indexed sooner

### Measurement Metrics

Track in Google Analytics:
- Pages per session (expect +15-30%)
- Bounce rate (expect -10-20%)
- Avg. session duration (expect +20-40%)
- Internal link click-through rate

Track in Google Search Console:
- Index coverage (expect 100% indexing)
- Crawl stats (expect higher crawl frequency)
- Page authority (via 3rd party tools like Ahrefs)

---

## Edge Cases & Error Handling

### Edge Case 1: No Related Pages Found
**Scenario:** Page has unique keywords, no similar pages exist

**Handling:**
```php
$related = $linking->findRelatedPages($post_id);

if (empty($related)) {
    error_log("[Internal Linking] No related pages found for post {$post_id}");
    // Don't display "Related Information" section
    return;
}
```

### Edge Case 2: All Related Pages Deleted
**Scenario:** Links stored, but all target pages later deleted

**Handling:**
```php
foreach ($related as $page_data) {
    $page = get_post($page_data['id']);

    if (!$page || $page->post_status !== 'publish') {
        continue; // Skip silently
    }

    // Render link
}

// If all skipped, section won't display (empty <ul>)
```

### Edge Case 3: Focus Keyword Missing
**Scenario:** Old page generated before `seo_metadata` block existed

**Handling:**
```php
$focus_keyword = get_field('seo_focus_keyword', $post_id);

if (empty($focus_keyword)) {
    // Fallback: extract from title
    $focus_keyword = $post->post_title;
    error_log("[Internal Linking] No focus keyword for post {$post_id}, using title");
}
```

### Edge Case 4: Cron Not Running
**Scenario:** WordPress cron disabled or not firing

**Handling:**
- Add admin notice if last refresh was >14 days ago
- Provide manual "Refresh All" button
- Add to plugin health check dashboard

---

## Migration Strategy

### For Existing Sites

**Step 1: Initial Link Generation**
```php
// One-time script to generate links for all existing pages
public function initial_link_generation() {
    $pages = get_posts([
        'post_type' => 'seo-page',
        'post_status' => 'publish',
        'posts_per_page' => -1,
        'fields' => 'ids'
    ]);

    $linking = new InternalLinkingService();

    foreach ($pages as $page_id) {
        $related = $linking->findRelatedPages($page_id);
        $linking->storeRelatedLinks($page_id, $related);
    }
}
```

**Step 2: Add to Admin UI**
```php
// Settings page button to run migration
add_action('admin_post_run_initial_linking', function() {
    $service = new InternalLinkingService();
    $service->initial_link_generation();

    wp_redirect(admin_url('admin.php?page=seo-generator-settings&tab=linking&notice=migration_complete'));
    exit;
});
```

---

## Documentation

### User Documentation

**Location:** `docs/features/internal-linking.md`

Topics to cover:
- What is internal linking and why it matters
- How the system works (automatic, no manual work)
- How to view related links on pages
- How to manually refresh links
- Settings configuration
- Performance impact
- SEO benefits

### Developer Documentation

**Location:** `docs/technical/internal-linking-api.md`

Topics to cover:
- Architecture overview
- Class structure
- Hook reference
- Filter hooks for customization
- Performance optimization tips
- Testing approach

---

## Future Enhancements (Post-MVP)

### Phase 2 Features

1. **Contextual Link Insertion**
   - Insert links within content blocks (not just bottom)
   - AI determines best placement
   - Natural anchor text generation

2. **Link Analytics**
   - Track which links get clicked
   - A/B test different link strategies
   - Remove low-performing links

3. **Priority Keyword Boosting**
   - Admin can flag "priority" keywords
   - These matches rank higher
   - Target specific content clusters

4. **Synonym Detection**
   - "engagement ring" matches "wedding ring"
   - "platinum" matches "white gold" (similar)
   - OpenAI semantic similarity

5. **Link Network Visualization**
   - Graph view of site structure
   - Identify orphan pages
   - Find over-linked pages
   - Suggest new link opportunities

6. **External Link Suggestions**
   - Suggest outbound links to authority sites
   - Improve content E-A-T
   - Balance internal/external ratio

---

## Success Criteria

**This story is complete when:**

âœ… Related links automatically generate after page creation
âœ… Links display on frontend in "Related Information" section
âœ… Links stay fresh (use current titles, skip deleted pages)
âœ… Weekly cron refreshes all links automatically
âœ… Admin can manually refresh links via button
âœ… Settings page allows configuration
âœ… Performance meets requirements (<100ms calculation)
âœ… Unit tests pass (>80% coverage)
âœ… Integration tests pass
âœ… Manual QA checklist complete
âœ… User documentation written
âœ… No broken links on site after deployment

---

## Dependencies

**Requires:**
- Epic 1: Foundation (SEO page post type) âœ… Complete
- Epic 2: Core Generation (content generation) âœ… Complete
- Story: SEO Metadata Block (focus keyword field) âœ… Complete

**Blocks:**
- None (independent feature)

---

## Risks & Mitigation

### Risk 1: Performance Degradation at Scale
**Impact:** High
**Probability:** Medium

**Mitigation:**
- Topic-based pre-filtering (only search within category)
- Batch processing for full-site refresh
- Lazy loading (refresh on-demand vs all at once)
- Caching strategy

### Risk 2: Poor Link Quality
**Impact:** Medium
**Probability:** Medium

**Mitigation:**
- Keyword weighting (high-value vs generic)
- Minimum similarity threshold
- Admin can disable per-page
- Future: ML-based relevance scoring

### Risk 3: Cron Jobs Not Running
**Impact:** Medium
**Probability:** Low

**Mitigation:**
- Admin notice if refresh overdue
- Manual refresh button
- Health check dashboard
- Documentation on server cron setup

---

## Effort Breakdown

| Task | Hours | Assignee |
|------|-------|----------|
| InternalLinkingService class | 2.5 | Dev |
| KeywordMatcher class | 2.0 | Dev |
| Integration hooks | 1.0 | Dev |
| Frontend template | 0.5 | Dev |
| Admin UI (settings) | 1.5 | Dev |
| Admin UI (refresh button) | 0.5 | Dev |
| Cron job setup | 1.0 | Dev |
| Unit tests | 2.0 | Dev |
| Integration tests | 1.5 | Dev |
| Manual QA | 1.0 | QA |
| Documentation | 1.5 | Dev |
| **Total** | **15 hours** | |

---

## Implementation Checklist

### Development Phase
- [ ] Create `InternalLinkingService.php`
- [ ] Create `KeywordMatcher.php`
- [ ] Create `LinkRefresh.php` (cron handler)
- [ ] Add integration hooks to `GenerationService.php`
- [ ] Create `template-parts/related-links.php`
- [ ] Add settings page tab
- [ ] Add meta box to edit screen
- [ ] Write unit tests
- [ ] Write integration tests

### Testing Phase
- [ ] Run PHPUnit tests
- [ ] Manual QA on staging
- [ ] Performance testing (1000+ pages)
- [ ] Test with various keyword patterns
- [ ] Test link refresh scenarios
- [ ] Verify cron job execution

### Deployment Phase
- [ ] Merge to main branch
- [ ] Deploy to staging
- [ ] Run initial link generation script
- [ ] Verify no errors in logs
- [ ] Deploy to production
- [ ] Monitor for 48 hours
- [ ] Collect initial metrics

### Post-Launch
- [ ] Track SEO metrics (bounce rate, pages/session)
- [ ] Monitor Google Search Console indexing
- [ ] Gather user feedback
- [ ] Identify improvements for Phase 2

---

## Questions for Stakeholder

1. **Link placement:** Prefer bottom of page, or integrate into specific blocks?
2. **Refresh frequency:** Weekly sufficient, or need more frequent updates?
3. **Admin control:** Should users be able to manually pick related links?
4. **Styling:** Use default styling or match existing site theme?
5. **Analytics:** Track link clicks with Google Analytics events?
6. **Priority:** Must-have for v1.0 or can be v1.1?

---

**Story created:** January 2025
**Last updated:** January 2025
**Next review:** After implementation
