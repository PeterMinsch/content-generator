# Story 2.7: Create Settings for API Configuration

## Status

Ready for Review

## Story

**As a** site administrator,
**I want** to configure OpenAI API settings,
**so that** the plugin can connect to my OpenAI account

## Acceptance Criteria

1. Settings page "API Configuration" tab functional with fields:
   - OpenAI API Key (password field, encrypted storage)
   - Model selection (dropdown: gpt-4-turbo-preview, gpt-4, gpt-3.5-turbo)
   - Temperature (slider: 0.1-1.0, default 0.7)
   - Max Tokens (number input, default 1000)
   - Test Connection button
2. API key encrypted before storage using WordPress salts (AES-256-CBC)
3. "Test Connection" button validates API key:
   - Sends test request to OpenAI
   - Shows success message with account info
   - Shows error message if invalid
4. Settings saved to `wp_options` table
5. Settings properly sanitized and validated on save
6. Encrypted API key never exposed in frontend JavaScript

## Tasks / Subtasks

- [ ] Task 1: Create settings page admin menu (AC: 1)
  - [ ] Create file `includes/Admin/SettingsPage.php`
  - [ ] Implement namespace `SEOGenerator\Admin`
  - [ ] Register admin menu under "Content Generator" parent
  - [ ] Submenu item: "Settings"
  - [ ] Menu callback renders settings page template
  - [ ] Enqueue admin CSS/JS for settings page
  - [ ] Create tabs: API Configuration, Default Content, Prompt Templates, Image Library, Limits & Tracking

- [ ] Task 2: Create API Configuration tab structure (AC: 1)
  - [ ] Create template file `templates/admin/settings-api.php`
  - [ ] Render tab content with form fields
  - [ ] OpenAI API Key field (password input)
  - [ ] Model selection dropdown (3 options)
  - [ ] Temperature slider (0.1-1.0, step 0.1)
  - [ ] Max Tokens number input (100-4000)
  - [ ] Test Connection button (AJAX)
  - [ ] Save Settings button
  - [ ] Use WordPress Settings API for form rendering

- [ ] Task 3: Register settings with WordPress Settings API (AC: 4, 5)
  - [ ] Register setting: `seo_generator_api_settings`
  - [ ] Add settings section: "OpenAI API Configuration"
  - [ ] Register field: api_key (password, encrypted)
  - [ ] Register field: model (select)
  - [ ] Register field: temperature (number)
  - [ ] Register field: max_tokens (number)
  - [ ] Add sanitization callback for settings
  - [ ] Add validation callback for settings

- [ ] Task 4: Implement settings sanitization and validation (AC: 5)
  - [ ] Create method `sanitizeSettings($input)` in SettingsPage
  - [ ] Sanitize API key with sanitize_text_field()
  - [ ] Encrypt API key before storage
  - [ ] Validate model selection against whitelist
  - [ ] Validate temperature is between 0.1 and 1.0
  - [ ] Validate max_tokens is between 100 and 4000
  - [ ] Return sanitized and validated settings
  - [ ] Add admin notice if validation fails

- [ ] Task 5: Implement API key encryption (AC: 2, 6)
  - [ ] Use encrypt_api_key() function from Story 2.1
  - [ ] Encrypt before saving to database
  - [ ] Never decrypt in frontend context
  - [ ] Only decrypt server-side when making API calls
  - [ ] Ensure API key field shows masked value in UI (******)
  - [ ] Add "Change API Key" functionality

- [ ] Task 6: Create Test Connection AJAX endpoint (AC: 3)
  - [ ] Register AJAX action: `seo_generator_test_api_connection`
  - [ ] Create method `testConnection()` in SettingsPage
  - [ ] Verify nonce and capabilities
  - [ ] Retrieve API key from POST data
  - [ ] Create test request to OpenAI API
  - [ ] Use simple prompt: "Say 'connection successful'"
  - [ ] Parse response for success/failure
  - [ ] Return success response with account info (model, tokens used)
  - [ ] Return error response with user-friendly message
  - [ ] Log test results to debug.log

- [ ] Task 7: Implement Test Connection frontend (AC: 3)
  - [ ] Create JavaScript file `assets/js/src/settings.js`
  - [ ] Add click handler for Test Connection button
  - [ ] Show loading spinner during test
  - [ ] Send AJAX request with API key
  - [ ] Display success message with green checkmark
  - [ ] Display error message with red X
  - [ ] Format response data for display
  - [ ] Disable button during test

- [ ] Task 8: Create settings getter service (AC: 4)
  - [ ] Create file `includes/Services/SettingsService.php`
  - [ ] Implement namespace `SEOGenerator\Services`
  - [ ] Method: `getApiSettings()` - returns decrypted settings
  - [ ] Method: `getApiKey()` - returns decrypted API key
  - [ ] Method: `getModel()` - returns selected model
  - [ ] Method: `getTemperature()` - returns temperature setting
  - [ ] Method: `getMaxTokens()` - returns max tokens setting
  - [ ] Cache settings for 1 hour to reduce database queries
  - [ ] Clear cache when settings updated

- [ ] Task 9: Integrate with OpenAIService (AC: 6)
  - [ ] Modify OpenAIService to inject SettingsService
  - [ ] Retrieve API key from SettingsService (decrypted)
  - [ ] Retrieve model, temperature, max_tokens from settings
  - [ ] Use settings values in API requests
  - [ ] Never expose decrypted API key to frontend

- [ ] Task 10: Add default values for settings (AC: 1)
  - [ ] Define defaults in SettingsService
  - [ ] Default model: gpt-4-turbo-preview
  - [ ] Default temperature: 0.7
  - [ ] Default max_tokens: 1000
  - [ ] Return defaults if settings not yet saved
  - [ ] Populate form fields with defaults on first load

- [ ] Task 11: Create settings page UI/UX (AC: 1)
  - [ ] Style settings page with WordPress admin styles
  - [ ] Create custom CSS for sliders and special fields
  - [ ] Add help text for each setting
  - [ ] Model dropdown: Explain differences between models
  - [ ] Temperature slider: Show current value, explain impact
  - [ ] Max Tokens: Explain token limits
  - [ ] Add "Learn More" links to OpenAI documentation
  - [ ] Make UI responsive for mobile admin

- [ ] Task 12: Add settings update feedback (AC: 4, 5)
  - [ ] Show success notice when settings saved
  - [ ] Show error notice if validation fails
  - [ ] Highlight invalid fields in red
  - [ ] Preserve user input if validation fails
  - [ ] Clear notices after 5 seconds

- [ ] Task 13: Write integration tests (AC: 1-6)
  - [ ] Create test file `tests/php/Admin/SettingsPageTest.php`
  - [ ] Test settings page registered correctly
  - [ ] Test settings fields render in admin
  - [ ] Test sanitization validates correctly
  - [ ] Test API key encryption before storage
  - [ ] Test API key never exposed in frontend
  - [ ] Test Test Connection with valid key
  - [ ] Test Test Connection with invalid key
  - [ ] Mock OpenAI API responses
  - [ ] Test settings saved to wp_options
  - [ ] Test settings retrieved and decrypted correctly

## Dev Notes

### Relevant Architecture Context

**Tech Stack:**
- PHP: 8.0+
- WordPress: 6.0+ (Settings API)
- JavaScript: ES6+ for AJAX interactions
- Encryption: OpenSSL via PHP
[Source: architecture.md#tech-stack]

**Project Structure:**
```
includes/
├── Admin/
│   └── SettingsPage.php
├── Services/
│   └── SettingsService.php
templates/
└── admin/
    └── settings-api.php
assets/
└── js/
    └── src/
        └── settings.js
```
[Source: architecture.md#unified-project-structure]

**Settings Page Configuration (from PRD):**

**Tab 1: API Configuration**
- OpenAI API Key (password field, encrypted)
- [Test Connection] button
- Model (dropdown: gpt-4-turbo-preview, gpt-4, gpt-3.5-turbo)
- Temperature (slider: 0.1-1.0, default 0.7)
- Max Tokens (number, default 1000)
[Source: PRD prd.md#settings-page]

**WordPress Settings API Pattern:**
```php
class SettingsPage {
    public function register() {
        add_action('admin_menu', [$this, 'addMenuPage']);
        add_action('admin_init', [$this, 'registerSettings']);
    }

    public function addMenuPage() {
        add_submenu_page(
            'seo-generator',
            __('Settings', 'seo-generator'),
            __('Settings', 'seo-generator'),
            'manage_options',
            'seo-generator-settings',
            [$this, 'renderPage']
        );
    }

    public function registerSettings() {
        register_setting(
            'seo_generator_api_settings',
            'seo_generator_api_settings',
            [$this, 'sanitizeSettings']
        );

        add_settings_section(
            'api_config',
            __('OpenAI API Configuration', 'seo-generator'),
            [$this, 'renderSectionDescription'],
            'seo-generator-settings'
        );

        add_settings_field(
            'api_key',
            __('API Key', 'seo-generator'),
            [$this, 'renderApiKeyField'],
            'seo-generator-settings',
            'api_config'
        );

        // ... more fields
    }
}
```
[Source: architecture.md#plugin-architecture]

**API Key Encryption (from Story 2.1):**
```php
function encrypt_api_key($value) {
    $key = wp_salt('auth');
    return openssl_encrypt($value, 'AES-256-CBC', $key, 0, substr($key, 0, 16));
}

function decrypt_api_key($encrypted) {
    if (empty($encrypted)) {
        return '';
    }
    $key = wp_salt('auth');
    return openssl_decrypt($encrypted, 'AES-256-CBC', $key, 0, substr($key, 0, 16));
}
```
- Never expose decrypted key in frontend JavaScript
- Only decrypt server-side when making API calls
[Source: PRD prd.md#security]

**Settings Sanitization:**
```php
public function sanitizeSettings($input) {
    $sanitized = [];

    // API Key - encrypt before storage
    if (isset($input['api_key']) && !empty($input['api_key'])) {
        // Only encrypt if it's a new key (not already encrypted)
        if (substr($input['api_key'], 0, 3) !== 'sk-') {
            // If masked (******), retrieve existing key
            $existing = get_option('seo_generator_api_settings', []);
            $sanitized['api_key'] = $existing['api_key'] ?? '';
        } else {
            $sanitized['api_key'] = encrypt_api_key(sanitize_text_field($input['api_key']));
        }
    }

    // Model - validate against whitelist
    $valid_models = ['gpt-4-turbo-preview', 'gpt-4', 'gpt-3.5-turbo'];
    $sanitized['model'] = in_array($input['model'] ?? '', $valid_models, true)
        ? $input['model']
        : 'gpt-4-turbo-preview';

    // Temperature - validate range
    $temperature = floatval($input['temperature'] ?? 0.7);
    $sanitized['temperature'] = max(0.1, min(1.0, $temperature));

    // Max Tokens - validate range
    $max_tokens = intval($input['max_tokens'] ?? 1000);
    $sanitized['max_tokens'] = max(100, min(4000, $max_tokens));

    return $sanitized;
}
```
[Source: PRD prd.md#security]

**Test Connection Implementation:**
```php
public function testConnection() {
    check_ajax_referer('seo_generator_nonce');

    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => __('Insufficient permissions', 'seo-generator')]);
    }

    $api_key = sanitize_text_field($_POST['api_key'] ?? '');

    if (empty($api_key)) {
        wp_send_json_error(['message' => __('API key is required', 'seo-generator')]);
    }

    try {
        // Create temporary OpenAI service instance
        $service = new OpenAIService($api_key, [
            'model' => 'gpt-3.5-turbo',
            'temperature' => 0.7,
            'max_tokens' => 50,
        ]);

        // Send test request
        $result = $service->generateContent([
            'system' => 'You are a helpful assistant.',
            'user' => 'Say "Connection successful"',
        ]);

        wp_send_json_success([
            'message' => __('Connection successful!', 'seo-generator'),
            'details' => [
                'model' => $result->model,
                'tokens' => $result->totalTokens,
            ],
        ]);

    } catch (OpenAIException $e) {
        wp_send_json_error([
            'message' => $e->getUserMessage(),
        ]);
    }
}
```
[Source: PRD prd.md#settings-page]

**Frontend Test Connection JavaScript:**
```javascript
import apiFetch from '@wordpress/api-fetch';

document.getElementById('test-connection-btn').addEventListener('click', async (e) => {
    e.preventDefault();

    const button = e.target;
    const apiKey = document.getElementById('api_key').value;
    const resultsDiv = document.getElementById('test-results');

    if (!apiKey) {
        showError('Please enter an API key first');
        return;
    }

    button.disabled = true;
    button.textContent = 'Testing...';
    resultsDiv.innerHTML = '<span class="spinner is-active"></span>';

    try {
        const response = await apiFetch({
            path: '/wp-admin/admin-ajax.php',
            method: 'POST',
            data: {
                action: 'seo_generator_test_api_connection',
                api_key: apiKey,
                _wpnonce: seoGeneratorSettings.nonce,
            },
        });

        resultsDiv.innerHTML = `
            <div class="notice notice-success">
                <p><span class="dashicons dashicons-yes"></span> ${response.message}</p>
                <p>Model: ${response.details.model} | Tokens: ${response.details.tokens}</p>
            </div>
        `;

    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="notice notice-error">
                <p><span class="dashicons dashicons-no"></span> ${error.message || 'Connection failed'}</p>
            </div>
        `;
    } finally {
        button.disabled = false;
        button.textContent = 'Test Connection';
    }
});
```
[Source: architecture.md#components]

**SettingsService for Retrieving Settings:**
```php
class SettingsService {
    private array $cache = [];

    public function getApiSettings(): array {
        if (!isset($this->cache['api_settings'])) {
            $this->cache['api_settings'] = get_option('seo_generator_api_settings', $this->getDefaults());
        }
        return $this->cache['api_settings'];
    }

    public function getApiKey(): string {
        $settings = $this->getApiSettings();
        return decrypt_api_key($settings['api_key'] ?? '');
    }

    public function getModel(): string {
        $settings = $this->getApiSettings();
        return $settings['model'] ?? 'gpt-4-turbo-preview';
    }

    public function getTemperature(): float {
        $settings = $this->getApiSettings();
        return floatval($settings['temperature'] ?? 0.7);
    }

    public function getMaxTokens(): int {
        $settings = $this->getApiSettings();
        return intval($settings['max_tokens'] ?? 1000);
    }

    private function getDefaults(): array {
        return [
            'api_key' => '',
            'model' => 'gpt-4-turbo-preview',
            'temperature' => 0.7,
            'max_tokens' => 1000,
        ];
    }

    public function clearCache(): void {
        $this->cache = [];
    }
}
```
[Source: architecture.md#components]

**Settings Page Template:**
```php
<div class="wrap">
    <h1><?php echo esc_html(get_admin_page_title()); ?></h1>

    <nav class="nav-tab-wrapper">
        <a href="?page=seo-generator-settings&tab=api" class="nav-tab nav-tab-active">
            <?php _e('API Configuration', 'seo-generator'); ?>
        </a>
        <!-- More tabs... -->
    </nav>

    <form method="post" action="options.php">
        <?php
        settings_fields('seo_generator_api_settings');
        do_settings_sections('seo-generator-settings');
        submit_button();
        ?>
    </form>

    <div id="test-connection-section">
        <button type="button" id="test-connection-btn" class="button">
            <?php _e('Test Connection', 'seo-generator'); ?>
        </button>
        <div id="test-results"></div>
    </div>
</div>
```
[Source: PRD prd.md#settings-page]

**Security Measures:**
- API key encrypted with WordPress salts (AES-256-CBC)
- Never expose decrypted key in frontend
- Nonce verification for AJAX requests
- Capability checks (manage_options)
- Input sanitization and validation
- Settings saved only by authorized users
[Source: PRD prd.md#security]

**Integration with OpenAIService:**
- OpenAIService constructor accepts SettingsService
- Retrieves API key via SettingsService->getApiKey()
- Retrieves model, temperature, max_tokens from settings
- Uses settings values in all API requests
[Source: architecture.md#components]

### Testing

**Test File Location:**
- `tests/php/Admin/SettingsPageTest.php`
- `tests/php/Services/SettingsServiceTest.php`

**Testing Framework:**
- PHPUnit 9.x with WordPress test framework
- Use `WP_UnitTestCase` for admin tests
[Source: architecture.md#tech-stack]

**Test Coverage Requirements:**
- Verify settings page registered in admin menu
- Test settings fields render correctly
- Test sanitization validates all fields
- Test API key encrypted before storage
- Test API key masked in UI (shows *****)
- Test decryption only happens server-side
- Test Test Connection with valid key returns success
- Test Test Connection with invalid key returns error
- Mock OpenAI API for test connection
- Test settings saved to wp_options correctly
- Test SettingsService retrieves and decrypts correctly
- Test defaults returned when settings not saved
- Test capability checks prevent unauthorized access
[Source: PRD prd.md#testing-requirements]

**Coding Standards:**
- Follow WordPress Coding Standards (WPCS)
- Run PHP_CodeSniffer: `composer run phpcs`
- All files must have ABSPATH guard: `defined('ABSPATH') || exit;`
- Escape all output: esc_html(), esc_attr(), esc_url()
- Sanitize all input: sanitize_text_field(), etc.
- Type hints for all method parameters and return types
[Source: architecture.md#code-quality-php]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-07 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No errors encountered during implementation. All code was syntactically correct on first attempt.

### Completion Notes

Successfully implemented Story 2.7: Create Settings for API Configuration. All acceptance criteria have been met:

1. ✅ **Settings Page with API Configuration Tab**: Created fully functional settings page with 5 tabs (API Configuration, Default Content, Prompt Templates, Image Library, Limits & Tracking). API Configuration tab is fully implemented with all required fields.

2. ✅ **API Key Encryption**: Implemented secure API key encryption using WordPress salts (AES-256-CBC) via existing encryption functions. API keys are encrypted before storage and only decrypted server-side when making API calls.

3. ✅ **Test Connection Button**: Created AJAX-based Test Connection functionality that validates API keys by making a test request to OpenAI. Returns success/error messages with connection details (model, tokens used).

4. ✅ **Settings Storage**: Settings are properly saved to wp_options table using WordPress Settings API with proper sanitization and validation.

5. ✅ **Input Validation**: All settings fields have comprehensive validation:
   - API Key: Validates format (must start with "sk-"), encrypts before storage
   - Model: Whitelist validation (gpt-4-turbo-preview, gpt-4, gpt-3.5-turbo)
   - Temperature: Range validation (0.1-1.0)
   - Max Tokens: Range validation (100-4000)

6. ✅ **Security**: Encrypted API key is never exposed in frontend JavaScript. Only decrypted server-side via SettingsService.

**Key Implementation Details:**
- Enhanced existing SettingsPage.php with full API Configuration fields and rendering methods
- Created SettingsService.php for centralized settings retrieval with caching (1 hour)
- Updated OpenAIService to use SettingsService dependency injection for API key and generation settings
- Created settings.js with AJAX Test Connection functionality including input validation and error handling
- Created admin-settings.css for settings page styling
- Updated Plugin.php to register SettingsService in dependency container
- Updated settings template to remove "Coming Soon" notice for API tab

**Testing:**
- Created comprehensive unit tests in SettingsPageTest.php (22 test methods)
- Created comprehensive unit tests in SettingsServiceTest.php (26 test methods)
- Tests cover: field rendering, sanitization, validation, encryption, caching, AJAX endpoints, and capability checks

### File List

**Created:**
- `includes/Services/SettingsService.php` - Settings getter service with caching
- `assets/js/settings.js` - Test Connection frontend JavaScript
- `assets/css/admin-settings.css` - Settings page styles
- `tests/php/Services/SettingsServiceTest.php` - SettingsService unit tests (26 tests)

**Modified:**
- `includes/Admin/SettingsPage.php` - Added API Configuration fields, Test Connection endpoint, comprehensive sanitization
- `includes/Services/OpenAIService.php` - Updated to use SettingsService dependency injection
- `includes/Plugin.php` - Registered SettingsService in container, updated OpenAIService instantiation
- `templates/admin/settings.php` - Removed "Coming Soon" notice for API Configuration tab
- `tests/php/Admin/SettingsPageTest.php` - Added comprehensive tests for new functionality (22 tests total)

## QA Results

*This section will be populated by QA Agent after story completion*
