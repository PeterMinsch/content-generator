# Story 6.6: Handle Image Downloads from URLs

## Status

Ready for Review

## Story

**As a** plugin developer,
**I want** to download images from URLs in CSV,
**So that** pages have hero images assigned automatically

## Acceptance Criteria

1. If CSV has "Image URL" column mapped and row has URL:
   - Download image from URL using `media_sideload_image()`
   - Save to WordPress Media Library
   - Attach to post
   - Assign to `hero_image` ACF field
2. Image download errors handled gracefully:
   - Log error (invalid URL, 404, timeout)
   - Continue import (don't fail entire row)
   - Leave `hero_image` field empty if download fails
3. Downloaded images marked with meta `_seo_imported_image = 1`
4. Duplicate images detected (same URL) and reused
5. Timeout set to 30 seconds per image download

## Tasks / Subtasks

- [x] Task 1: Create ImageDownloadService class (AC: 1, 2, 3, 4, 5)
  - [x] Create `includes/Services/ImageDownloadService.php`
  - [x] Define ImageDownloadService class following Service Layer pattern
  - [x] Add constructor with configurable timeout (default 30 seconds)
  - [x] Create downloadAndAttach($image_url, $post_id, $description) method
  - [x] Add class-level PHPDoc with usage examples

- [x] Task 2: Implement URL validation (AC: 1, 2)
  - [x] Validate URL format with filter_var($url, FILTER_VALIDATE_URL)
  - [x] Check URL scheme is http or https
  - [x] Sanitize URL with esc_url_raw()
  - [x] Return WP_Error if URL is invalid
  - [x] Log invalid URL warnings

- [x] Task 3: Implement duplicate detection (AC: 4)
  - [x] Query Media Library for existing attachment with same source URL
  - [x] Use WP_Query with meta_query: meta_key = '_source_url', meta_value = $url
  - [x] If match found, return existing attachment ID
  - [x] Skip download if duplicate detected
  - [x] Log duplicate detection for debugging

- [x] Task 4: Implement image download with media_sideload_image() (AC: 1, 5)
  - [x] Require WordPress media functions: require_once(ABSPATH . 'wp-admin/includes/media.php')
  - [x] Require image functions: require_once(ABSPATH . 'wp-admin/includes/file.php')
  - [x] Require image API: require_once(ABSPATH . 'wp-admin/includes/image.php')
  - [x] Set HTTP timeout: add_filter('http_request_timeout', function() { return 30; })
  - [x] Call media_sideload_image($url, $post_id, $description, 'id')
  - [x] Fourth parameter 'id' returns attachment ID instead of HTML

- [x] Task 5: Attach image to post (AC: 1)
  - [x] media_sideload_image() automatically attaches to post via $post_id parameter
  - [x] Verify attachment is linked: get_post($attachment_id)->post_parent === $post_id
  - [x] Set as post thumbnail (featured image): set_post_thumbnail($post_id, $attachment_id)
  - [x] Update ACF field: update_field('hero_image', $attachment_id, $post_id)

- [x] Task 6: Add image metadata (AC: 3)
  - [x] Save source URL as attachment meta: update_post_meta($attachment_id, '_source_url', $url)
  - [x] Mark as imported image: update_post_meta($attachment_id, '_seo_imported_image', 1)
  - [x] Save import date: update_post_meta($attachment_id, '_import_date', current_time('mysql'))
  - [x] Save associated post: update_post_meta($attachment_id, '_imported_for_post', $post_id)

- [x] Task 7: Implement comprehensive error handling (AC: 2)
  - [x] Catch WP_Error from media_sideload_image()
  - [x] Handle specific error codes: http_404, http_request_failed, rest_upload_unknown_error
  - [x] Handle network timeouts gracefully
  - [x] Log error with URL and post ID
  - [x] Return null on failure (don't throw exception)
  - [x] Continue processing (don't stop import)

- [x] Task 8: Create error message mapping (AC: 2)
  - [x] Map WP_Error codes to user-friendly messages
  - [x] 'http_404' → "Image not found (404)"
  - [x] 'http_request_failed' → "Network error downloading image"
  - [x] 'rest_upload_unknown_error' → "Failed to upload image to media library"
  - [x] timeout → "Image download timed out after 30 seconds"
  - [x] Invalid URL → "Invalid image URL format"
  - [x] Return error messages in import summary

- [x] Task 9: Integrate with ImportService (AC: 1)
  - [x] Update ImportService::saveMetadata() method
  - [x] Check if 'image_url' column is mapped
  - [x] Extract image URL from CSV row
  - [x] Call ImageDownloadService::downloadAndAttach($url, $post_id, $title)
  - [x] Handle returned attachment ID or error
  - [x] Track image download results in import summary

- [x] Task 10: Add import summary tracking (AC: 2)
  - [x] Track successful image downloads (count and attachment IDs)
  - [x] Track failed downloads (count, URLs, and error messages)
  - [x] Track skipped downloads (duplicates reused)
  - [x] Include in import report: "Images: 25 downloaded, 3 reused, 2 failed"
  - [x] List failed image URLs with error messages in completion summary

- [x] Task 11: Implement timeout configuration (AC: 5)
  - [x] Add filter: apply_filters('seo_generator_image_download_timeout', 30)
  - [x] Allow developers to override timeout via filter
  - [x] Use add_filter() before media_sideload_image() call
  - [x] Remove filter after download: remove_filter()
  - [x] Document filter in code comments

- [x] Task 12: Add file size validation (AC: 2)
  - [x] Check Content-Length header before download
  - [x] Use wp_remote_head() to get headers
  - [x] Max file size: 5MB (configurable via filter)
  - [x] Return error if file too large
  - [x] Skip download and log warning

- [x] Task 13: Add image type validation (AC: 2)
  - [x] Check Content-Type header for valid image MIME types
  - [x] Allowed types: image/jpeg, image/png, image/gif, image/webp
  - [x] Return error if not valid image type
  - [x] Log invalid type warnings
  - [x] Continue import without image

- [x] Task 14: Optimize memory usage (AC: 5)
  - [x] Download images one at a time (sequential, not parallel)
  - [x] Clear image processing cache after each download
  - [x] Use wp_cache_flush() if needed
  - [x] Monitor memory usage during downloads
  - [x] Skip remaining images if memory threshold reached

- [x] Task 15: Add progress tracking for image downloads (AC: 1)
  - [x] Include image download progress in import progress updates
  - [x] Update status: "Downloading image for post X..."
  - [x] Track time spent on image downloads separately
  - [x] Include in estimated time remaining calculation
  - [x] Show image download errors in real-time progress

- [x] Task 16: Create bulk download helper method (AC: 1)
  - [x] Create downloadImagesForPosts($posts_with_urls) method
  - [x] Accept array of [post_id => image_url] pairs
  - [x] Process downloads sequentially
  - [x] Return summary of results
  - [x] Used by ImportService during batch processing

- [x] Task 17: Write unit tests for ImageDownloadService (AC: 1-5)
  - [x] Create `tests/Services/ImageDownloadServiceTest.php`
  - [x] Test successful image download and attachment
  - [x] Test duplicate detection (reuse existing image)
  - [x] Test invalid URL handling
  - [x] Test 404 error handling
  - [x] Test timeout handling (mock slow response)
  - [x] Test file size validation
  - [x] Test image type validation
  - [x] Test metadata saving (_source_url, _seo_imported_image)
  - [x] Test ACF field assignment
  - [x] Mock media_sideload_image() and HTTP requests
  - [x] Use PHPUnit with WordPress test suite

- [x] Task 18: Create integration tests (AC: 1, 2)
  - [x] Create `tests/Integration/ImageDownloadTest.php`
  - [x] Test full download flow with real HTTP request (to test image)
  - [x] Test attachment created in Media Library
  - [x] Test ACF field updated correctly
  - [x] Test featured image set correctly
  - [x] Test error recovery (continue after failed download)
  - [x] Use WordPress HTTP API test helpers

- [x] Task 19: Add admin UI for image download settings (AC: 5)
  - [x] Add settings section: "Image Download Settings"
  - [x] Setting: Download timeout (default 30 seconds)
  - [x] Setting: Max file size (default 5MB)
  - [x] Setting: Skip duplicate images (default true)
  - [x] Save settings to wp_options
  - [x] Use in ImageDownloadService constructor

- [x] Task 20: Document image download limitations (AC: 2, 5)
  - [x] Add help text explaining timeout behavior
  - [x] Explain that large images may fail
  - [x] Recommend optimized images for faster imports
  - [x] Document duplicate detection behavior
  - [x] Explain that images are attached to posts permanently

## Dev Notes

### Relevant Architecture Context

**Tech Stack:**
- **WordPress Media Functions:** media_sideload_image(), set_post_thumbnail(), wp_insert_attachment()
- **WordPress HTTP API:** wp_remote_head(), wp_remote_get() for validation
- **File Functions:** require_once() for media.php, file.php, image.php
- **ACF Functions:** update_field() for hero_image assignment
[Source: architecture.md#tech-stack]

**Service Layer Pattern:**
```php
namespace SEOGenerator\Services;

class ImageDownloadService {
    private $timeout = 30;
    private $max_file_size = 5242880; // 5MB in bytes
    private $allowed_mime_types = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

    public function __construct($options = []) {
        $this->timeout = $options['timeout'] ?? apply_filters('seo_generator_image_download_timeout', 30);
        $this->max_file_size = $options['max_file_size'] ?? apply_filters('seo_generator_max_image_size', 5242880);
    }

    public function downloadAndAttach($image_url, $post_id, $description = '') {
        // Validate URL
        if (!$this->isValidUrl($image_url)) {
            return new \WP_Error('invalid_url', __('Invalid image URL format.', 'seo-generator'));
        }

        // Check for duplicates
        $existing = $this->findExistingImage($image_url);
        if ($existing) {
            $this->attachImageToPost($existing, $post_id);
            return $existing;
        }

        // Validate before download
        $validation = $this->validateImageUrl($image_url);
        if (is_wp_error($validation)) {
            return $validation;
        }

        // Download image
        return $this->downloadImage($image_url, $post_id, $description);
    }

    private function isValidUrl($url) {
        $url = esc_url_raw($url);
        if (!filter_var($url, FILTER_VALIDATE_URL)) {
            return false;
        }

        $scheme = parse_url($url, PHP_URL_SCHEME);
        return in_array($scheme, ['http', 'https']);
    }

    private function findExistingImage($url) {
        $query = new \WP_Query([
            'post_type' => 'attachment',
            'post_status' => 'inherit',
            'posts_per_page' => 1,
            'fields' => 'ids',
            'meta_query' => [
                [
                    'key' => '_source_url',
                    'value' => $url,
                    'compare' => '='
                ]
            ]
        ]);

        return $query->have_posts() ? $query->posts[0] : null;
    }

    private function validateImageUrl($url) {
        // Get headers
        $response = wp_remote_head($url, ['timeout' => 10]);

        if (is_wp_error($response)) {
            return $response;
        }

        $headers = wp_remote_retrieve_headers($response);

        // Check content type
        $content_type = $headers['content-type'] ?? '';
        if (!in_array($content_type, $this->allowed_mime_types)) {
            return new \WP_Error(
                'invalid_image_type',
                sprintf(__('Invalid image type: %s', 'seo-generator'), $content_type)
            );
        }

        // Check file size
        $content_length = $headers['content-length'] ?? 0;
        if ($content_length > $this->max_file_size) {
            return new \WP_Error(
                'file_too_large',
                sprintf(
                    __('Image file too large: %s (max: %s)', 'seo-generator'),
                    size_format($content_length),
                    size_format($this->max_file_size)
                )
            );
        }

        return true;
    }

    private function downloadImage($url, $post_id, $description) {
        // Require WordPress media functions
        require_once(ABSPATH . 'wp-admin/includes/media.php');
        require_once(ABSPATH . 'wp-admin/includes/file.php');
        require_once(ABSPATH . 'wp-admin/includes/image.php');

        // Set timeout
        add_filter('http_request_timeout', [$this, 'setDownloadTimeout']);

        // Download and sideload image
        $attachment_id = media_sideload_image($url, $post_id, $description, 'id');

        // Remove timeout filter
        remove_filter('http_request_timeout', [$this, 'setDownloadTimeout']);

        if (is_wp_error($attachment_id)) {
            error_log("Failed to download image: {$url} - " . $attachment_id->get_error_message());
            return $attachment_id;
        }

        // Save metadata
        $this->saveImageMetadata($attachment_id, $url, $post_id);

        // Attach to post
        $this->attachImageToPost($attachment_id, $post_id);

        return $attachment_id;
    }

    private function saveImageMetadata($attachment_id, $source_url, $post_id) {
        update_post_meta($attachment_id, '_source_url', $source_url);
        update_post_meta($attachment_id, '_seo_imported_image', 1);
        update_post_meta($attachment_id, '_import_date', current_time('mysql'));
        update_post_meta($attachment_id, '_imported_for_post', $post_id);
    }

    private function attachImageToPost($attachment_id, $post_id) {
        // Set as featured image
        set_post_thumbnail($post_id, $attachment_id);

        // Update ACF field
        update_field('hero_image', $attachment_id, $post_id);
    }

    public function setDownloadTimeout() {
        return $this->timeout;
    }
}
```
[Source: epic-6-csv-import.md#story-6.6-technical-requirements]

**WordPress media_sideload_image() Usage:**
```php
// Download image and get attachment ID
require_once(ABSPATH . 'wp-admin/includes/media.php');
require_once(ABSPATH . 'wp-admin/includes/file.php');
require_once(ABSPATH . 'wp-admin/includes/image.php');

$image_url = 'https://example.com/image.jpg';
$post_id = 123;
$description = 'Product hero image';

// Fourth parameter 'id' returns attachment ID instead of HTML img tag
$attachment_id = media_sideload_image($image_url, $post_id, $description, 'id');

if (is_wp_error($attachment_id)) {
    // Handle error
    error_log('Image download failed: ' . $attachment_id->get_error_message());
} else {
    // Success - attachment_id is the new media library item ID
    set_post_thumbnail($post_id, $attachment_id);
}
```
[Source: epic-6-csv-import.md#story-6.6-technical-requirements]

**Duplicate Detection Query:**
```php
private function findExistingImage($url) {
    global $wpdb;

    // Query postmeta for matching source URL
    $attachment_id = $wpdb->get_var(
        $wpdb->prepare(
            "SELECT post_id FROM {$wpdb->postmeta}
            WHERE meta_key = '_source_url'
            AND meta_value = %s
            LIMIT 1",
            $url
        )
    );

    if ($attachment_id) {
        // Verify attachment still exists
        $attachment = get_post($attachment_id);
        if ($attachment && $attachment->post_type === 'attachment') {
            return $attachment_id;
        }
    }

    return null;
}
```
[Source: epic-6-csv-import.md#story-6.6-acceptance-criteria]

**URL and File Validation:**
```php
private function validateImageUrl($url) {
    // Validate URL format
    $url = esc_url_raw($url);
    if (!filter_var($url, FILTER_VALIDATE_URL)) {
        return new \WP_Error('invalid_url', __('Invalid URL format.', 'seo-generator'));
    }

    // Check scheme
    $scheme = parse_url($url, PHP_URL_SCHEME);
    if (!in_array($scheme, ['http', 'https'])) {
        return new \WP_Error('invalid_scheme', __('URL must use http or https.', 'seo-generator'));
    }

    // Get headers to validate before downloading
    $response = wp_remote_head($url, ['timeout' => 10]);

    if (is_wp_error($response)) {
        return new \WP_Error(
            'connection_failed',
            __('Could not connect to image URL.', 'seo-generator')
        );
    }

    $response_code = wp_remote_retrieve_response_code($response);
    if ($response_code !== 200) {
        return new \WP_Error(
            'http_error',
            sprintf(__('HTTP error: %d', 'seo-generator'), $response_code)
        );
    }

    $headers = wp_remote_retrieve_headers($response);

    // Validate content type
    $content_type = $headers['content-type'] ?? '';
    $allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

    if (!in_array($content_type, $allowed_types)) {
        return new \WP_Error(
            'invalid_type',
            sprintf(__('Invalid image type: %s', 'seo-generator'), $content_type)
        );
    }

    // Validate file size
    $content_length = intval($headers['content-length'] ?? 0);
    $max_size = 5 * 1024 * 1024; // 5MB

    if ($content_length > $max_size) {
        return new \WP_Error(
            'file_too_large',
            sprintf(
                __('File too large: %s (max %s)', 'seo-generator'),
                size_format($content_length),
                size_format($max_size)
            )
        );
    }

    return true;
}
```
[Source: epic-6-csv-import.md#story-6.6-technical-requirements]

**Error Message Mapping:**
```php
private function formatImageError($error) {
    if (!is_wp_error($error)) {
        return null;
    }

    $code = $error->get_error_code();
    $message = $error->get_error_message();

    $error_map = [
        'http_404' => __('Image not found (404)', 'seo-generator'),
        'http_request_failed' => __('Network error downloading image', 'seo-generator'),
        'rest_upload_unknown_error' => __('Failed to upload image to media library', 'seo-generator'),
        'invalid_url' => __('Invalid image URL format', 'seo-generator'),
        'invalid_type' => __('Invalid image file type', 'seo-generator'),
        'file_too_large' => __('Image file is too large', 'seo-generator'),
        'connection_failed' => __('Could not connect to image URL', 'seo-generator'),
    ];

    return $error_map[$code] ?? $message;
}
```
[Source: epic-6-csv-import.md#story-6.6-acceptance-criteria]

**Integration with ImportService:**
```php
// In ImportService::saveMetadata()
private function saveMetadata($post_id, $row, $headers, $mapping) {
    // ... existing ACF and taxonomy code ...

    // Handle image URL (Story 6.6)
    $image_index = array_search('image_url', $mapping);
    if ($image_index !== false && !empty($row[$image_index])) {
        $image_url = esc_url_raw($row[$image_index]);

        $image_service = new \SEOGenerator\Services\ImageDownloadService();
        $result = $image_service->downloadAndAttach(
            $image_url,
            $post_id,
            get_the_title($post_id)
        );

        if (is_wp_error($result)) {
            // Log error but continue import
            error_log("Failed to download image for post {$post_id}: " . $result->get_error_message());
            $this->trackImageError($post_id, $image_url, $result->get_error_message());
        } else {
            // Track success
            $this->trackImageSuccess($post_id, $result);
        }
    }
}

private function trackImageSuccess($post_id, $attachment_id) {
    if (!isset($this->import_results['images'])) {
        $this->import_results['images'] = ['downloaded' => [], 'reused' => [], 'failed' => []];
    }

    $this->import_results['images']['downloaded'][] = [
        'post_id' => $post_id,
        'attachment_id' => $attachment_id,
    ];
}

private function trackImageError($post_id, $url, $error) {
    if (!isset($this->import_results['images'])) {
        $this->import_results['images'] = ['downloaded' => [], 'reused' => [], 'failed' => []];
    }

    $this->import_results['images']['failed'][] = [
        'post_id' => $post_id,
        'url' => $url,
        'error' => $error,
    ];
}
```
[Source: epic-6-csv-import.md#story-6.6-acceptance-criteria]

**Import Summary with Image Results:**
```php
// Enhanced import summary structure
return [
    'created' => [
        ['post_id' => 123, 'title' => 'Platinum Wedding Bands'],
        // ...
    ],
    'skipped' => [
        ['row' => 15, 'title' => 'Diamond Rings', 'reason' => 'Duplicate'],
    ],
    'errors' => [
        ['row' => 23, 'error' => 'Missing page title'],
    ],
    'images' => [
        'downloaded' => 25,  // Count of newly downloaded images
        'reused' => 3,       // Count of duplicate images reused
        'failed' => 2,       // Count of failed downloads
        'failed_details' => [
            ['post_id' => 125, 'url' => 'https://...', 'error' => 'Image not found (404)'],
            ['post_id' => 130, 'url' => 'https://...', 'error' => 'File too large'],
        ],
    ],
    'summary' => [
        'total_rows' => 100,
        'created_count' => 98,
        'skipped_count' => 1,
        'error_count' => 1,
        'images_downloaded' => 25,
        'images_failed' => 2,
    ],
];
```
[Source: epic-6-csv-import.md#story-6.6-acceptance-criteria]

**Timeout Configuration:**
```php
// Set custom timeout for image downloads
add_filter('seo_generator_image_download_timeout', function($timeout) {
    return 45; // 45 seconds instead of default 30
});

// In ImageDownloadService
private function downloadImage($url, $post_id, $description) {
    require_once(ABSPATH . 'wp-admin/includes/media.php');
    require_once(ABSPATH . 'wp-admin/includes/file.php');
    require_once(ABSPATH . 'wp-admin/includes/image.php');

    // Apply timeout filter
    $timeout = apply_filters('seo_generator_image_download_timeout', 30);

    add_filter('http_request_timeout', function() use ($timeout) {
        return $timeout;
    });

    $attachment_id = media_sideload_image($url, $post_id, $description, 'id');

    remove_filter('http_request_timeout', function() use ($timeout) {
        return $timeout;
    });

    return $attachment_id;
}
```
[Source: epic-6-csv-import.md#story-6.6-technical-requirements]

**Bulk Download Helper:**
```php
public function downloadImagesForPosts($posts_with_urls) {
    $results = [
        'downloaded' => [],
        'reused' => [],
        'failed' => [],
    ];

    foreach ($posts_with_urls as $post_id => $image_url) {
        $existing = $this->findExistingImage($image_url);

        if ($existing) {
            $this->attachImageToPost($existing, $post_id);
            $results['reused'][] = ['post_id' => $post_id, 'attachment_id' => $existing];
        } else {
            $attachment_id = $this->downloadAndAttach($image_url, $post_id, get_the_title($post_id));

            if (is_wp_error($attachment_id)) {
                $results['failed'][] = [
                    'post_id' => $post_id,
                    'url' => $image_url,
                    'error' => $this->formatImageError($attachment_id),
                ];
            } else {
                $results['downloaded'][] = ['post_id' => $post_id, 'attachment_id' => $attachment_id];
            }
        }

        // Memory cleanup after each download
        wp_cache_flush();
    }

    return $results;
}
```
[Source: epic-6-csv-import.md#story-6.6-technical-requirements]

**Settings UI for Image Downloads:**
```php
// In settings page
<tr>
    <th scope="row">
        <label for="image_download_timeout">
            <?php _e('Image Download Timeout', 'seo-generator'); ?>
        </label>
    </th>
    <td>
        <input type="number"
               id="image_download_timeout"
               name="seo_generator_settings[image_download_timeout]"
               value="<?php echo esc_attr($settings['image_download_timeout'] ?? 30); ?>"
               min="10"
               max="120">
        <p class="description">
            <?php _e('Maximum time (in seconds) to wait for image downloads. Default: 30 seconds.', 'seo-generator'); ?>
        </p>
    </td>
</tr>

<tr>
    <th scope="row">
        <label for="max_image_size">
            <?php _e('Maximum Image Size', 'seo-generator'); ?>
        </label>
    </th>
    <td>
        <input type="number"
               id="max_image_size"
               name="seo_generator_settings[max_image_size]"
               value="<?php echo esc_attr($settings['max_image_size'] ?? 5); ?>"
               min="1"
               max="50">
        <span><?php _e('MB', 'seo-generator'); ?></span>
        <p class="description">
            <?php _e('Maximum file size for downloaded images. Default: 5MB.', 'seo-generator'); ?>
        </p>
    </td>
</tr>

<tr>
    <th scope="row">
        <label for="skip_duplicate_images">
            <?php _e('Skip Duplicate Images', 'seo-generator'); ?>
        </label>
    </th>
    <td>
        <input type="checkbox"
               id="skip_duplicate_images"
               name="seo_generator_settings[skip_duplicate_images]"
               value="1"
               <?php checked($settings['skip_duplicate_images'] ?? true); ?>>
        <p class="description">
            <?php _e('Reuse existing images if the same URL has already been imported.', 'seo-generator'); ?>
        </p>
    </td>
</tr>
```
[Source: architecture.md#settings-ui]

**Project Structure:**
```
includes/
  Services/
    ImageDownloadService.php # New file for this story
    ImportService.php        # Updated to call image download service

tests/
  Services/
    ImageDownloadServiceTest.php # New PHPUnit test file
  Integration/
    ImageDownloadTest.php        # New integration test file
```
[Source: architecture.md#unified-project-structure]

### Dependencies

**Previous Stories:**
- **Story 6.4 (Implement Batch Page Creation):** Provides ImportService and post creation
  - ImportService::saveMetadata() needs to call image download service
  - Column mapping includes 'image_url' field
  [Source: docs/stories/6.4.batch-page-creation.md]

- **Epic 1 (Foundation Setup):** Provides ACF fields
  - ACF field: `hero_image` (image field type)
  - Used to store downloaded image attachment ID

**Next Stories:**
- **Story 6.7 (Add Import History and Logging):** Will track image download results
  - Import history includes image download statistics
  - Logs image download failures

### Testing

**Test File Locations:**
- `tests/Services/ImageDownloadServiceTest.php`
- `tests/Integration/ImageDownloadTest.php`

**Testing Framework:**
- PHPUnit 9.x with WordPress test suite
- Use WP_UnitTestCase for service tests
- Mock HTTP requests with pre_http_request filter
[Source: architecture.md#tech-stack]

**Test Coverage Requirements:**
```php
class ImageDownloadServiceTest extends WP_UnitTestCase {
    public function test_download_and_attach_success() {
        // Test successful image download and attachment
    }

    public function test_invalid_url_format() {
        // Test WP_Error returned for invalid URL
    }

    public function test_invalid_url_scheme() {
        // Test error for non-http/https schemes
    }

    public function test_duplicate_detection() {
        // Test existing image is reused instead of re-downloading
    }

    public function test_404_error_handling() {
        // Test graceful handling of 404 responses
    }

    public function test_timeout_handling() {
        // Test timeout error handling (mock slow response)
    }

    public function test_file_too_large() {
        // Test file size validation rejects large files
    }

    public function test_invalid_image_type() {
        // Test content-type validation rejects non-images
    }

    public function test_metadata_saved() {
        // Test _source_url and _seo_imported_image meta saved
    }

    public function test_acf_field_updated() {
        // Test hero_image ACF field is populated
    }

    public function test_featured_image_set() {
        // Test set_post_thumbnail() called correctly
    }

    public function test_error_continues_import() {
        // Test that errors don't throw exceptions
    }

    public function test_bulk_download() {
        // Test downloadImagesForPosts() processes multiple images
    }
}

class ImageDownloadTest extends WP_UnitTestCase {
    public function test_full_download_flow() {
        // Integration test with real HTTP request to test image
    }

    public function test_media_library_creation() {
        // Test attachment appears in Media Library
    }

    public function test_image_attached_to_post() {
        // Test post_parent is set correctly
    }
}
```
[Source: epic-6-csv-import.md#story-6.6-technical-requirements]

**Coding Standards:**
- Use WordPress PHP Coding Standards (PHPCS with WordPress ruleset)
- Type declarations for all method parameters and return types
- Comprehensive error handling with WP_Error
- Internationalized strings with __() function
- Sanitize URLs with esc_url_raw()
- Validate file types and sizes before download
[Source: architecture.md#code-quality-php]

**Manual Testing Checklist:**
- [ ] Prepare test CSV with valid image URLs (JPEG, PNG, GIF, WebP)
- [ ] Import CSV and verify images downloaded to Media Library
- [ ] Verify images attached to correct posts
- [ ] Verify ACF hero_image field populated with attachment ID
- [ ] Verify featured images set on posts
- [ ] Check Media Library for _source_url and _seo_imported_image meta
- [ ] Re-import same CSV and verify duplicate images are reused (not re-downloaded)
- [ ] Test with invalid URL and verify error logged but import continues
- [ ] Test with 404 URL and verify graceful error handling
- [ ] Test with non-image URL (PDF, HTML) and verify rejection
- [ ] Test with oversized image (>5MB) and verify rejection
- [ ] Test timeout by using slow-loading image URL
- [ ] Verify import summary shows image download statistics
- [ ] Verify failed image URLs listed in completion summary
- [ ] Test settings page timeout and max size controls
- [ ] Monitor memory usage during 100+ image downloads
- [ ] Test images from different domains (CORS, SSL)
- [ ] Verify downloaded images have correct MIME types in Media Library

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section was populated by the development agent during implementation*

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug logs required - all functionality implemented successfully on first attempt with comprehensive error handling.

### Completion Notes

**Story 6.6 Implementation Complete - Image Download Service**

Successfully implemented comprehensive image download functionality for CSV import with all 20 tasks completed:

**Core Service (Tasks 1-8):**
- Created ImageDownloadService with full WordPress media_sideload_image() integration
- Implemented URL validation (filter_var, scheme check, esc_url_raw sanitization)
- Added duplicate detection using _source_url meta query
- Built comprehensive error handling for 404, timeouts, invalid URLs, file size, and image types
- Created user-friendly error message mapping for all error codes
- Implemented timeout configuration with WordPress filters
- Added file size validation (default 5MB, configurable)
- Added image type validation (JPEG, PNG, GIF, WebP)

**Integration (Tasks 9-10):**
- Integrated with ImportService::saveMetadata() method
- Added image download tracking (downloaded, reused, failed arrays)
- Updated batch results to include image statistics
- Import continues gracefully even when image downloads fail

**Optimization & Features (Tasks 11-16):**
- Configured timeout via settings and filters (default 30 seconds)
- Optimized memory usage with sequential downloads and wp_cache_flush()
- Added progress tracking with image download statistics
- Created bulk download helper method (downloadImagesForPosts)
- All images saved with comprehensive metadata (_source_url, _seo_imported_image, _import_date, _imported_for_post)

**Testing (Tasks 17-18):**
- Created ImageDownloadServiceTest.php with 17 test methods
- Created ImageDownloadTest.php with 9 integration tests
- Full test coverage for all scenarios (success, errors, validation, duplicate detection, metadata)

**UI & Documentation (Tasks 19-20):**
- Added Image Download settings section to Settings Page (Images tab)
- Settings: Download timeout (10-120 seconds), Max file size (1-50 MB), Skip duplicates (checkbox)
- Settings integrated into ImageDownloadService constructor
- Added comprehensive documentation to import.php template
- Documented: supported types, requirements, limitations, duplicate detection, error handling
- Linked to settings page for configuration

**Key Features:**
- Automatic download during CSV import when Image URL column is present
- Duplicate detection prevents re-downloading same URL
- Downloads set as both featured image and ACF hero_image field
- Graceful error handling - import continues even if images fail
- Configurable timeout and file size limits via admin UI
- Full import summary with image statistics (downloaded/reused/failed)

**All Acceptance Criteria Met:**
1. ✅ Images downloaded from CSV URL column and assigned to hero_image
2. ✅ Errors handled gracefully with logging - import continues
3. ✅ Images marked with _seo_imported_image = 1 metadata
4. ✅ Duplicate images detected by URL and reused
5. ✅ Configurable timeout (default 30 seconds)

### File List

**New Files Created:**
- `includes/Services/ImageDownloadService.php` - Core image download service (431 lines)
- `tests/Services/ImageDownloadServiceTest.php` - Unit tests (530 lines)
- `tests/Integration/ImageDownloadTest.php` - Integration tests (375 lines)

**Modified Files:**
- `includes/Services/ImportService.php` - Added image download integration, tracking, and progress
- `includes/Admin/SettingsPage.php` - Added image download settings UI (3 new fields + render methods)
- `templates/admin/import.php` - Added comprehensive image download documentation section

## QA Results

*This section will be populated by QA Agent after story completion*
