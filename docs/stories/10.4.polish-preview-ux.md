# Story 10.4: Polish Preview UX and Handle Edge Cases

**Epic:** 10 - Live Block Preview
**Status:** Draft

---

## Story

**As a** content manager,
**I want** a polished preview experience with helpful guidance,
**so that** I understand how to use the preview and what it represents

---

## Acceptance Criteria

1. **Visual Polish:**
   - Preview disclaimer text clearly visible
   - Preview header styled consistently with WordPress admin
   - Preview iframe has subtle border/shadow for depth
   - Scrolling behavior smooth and intuitive
   - Preview content well-padded and readable

2. **User Guidance:**
   - Disclaimer: "This is a simplified preview. Actual styling may vary based on your theme."
   - Empty state message: "No blocks selected. Drag blocks from the left to see preview."
   - Clear, helpful messaging throughout

3. **Edge Case Handling:**
   - Preview handles missing block types gracefully
   - Preview handles malformed block data
   - Preview recovers from rendering errors
   - Preview maintains scroll position during updates (or resets to top)

4. **Browser Compatibility:**
   - Works in Chrome 90+
   - Works in Firefox 88+
   - Works in Safari 14+
   - Works in Edge 90+
   - Graceful degradation message for unsupported browsers (if needed)

5. **Accessibility Refinements:**
   - Preview updates announced to screen readers
   - Focus management doesn't break during updates
   - Keyboard navigation works between panes
   - Color contrast meets WCAG AA standards

6. **Performance Validation:**
   - Test with all 12 blocks enabled (no lag)
   - Test with rapid reordering (smooth updates)
   - Test with slow network (preview still renders locally)
   - No memory leaks on repeated updates

---

## Tasks / Subtasks

- [ ] **Task 1: Add ARIA Live Region for Screen Reader Announcements** (AC: 5)
  - [ ] Verify ARIA live region exists in template: `<div class="preview-sr-announcements" role="status" aria-live="polite" aria-atomic="true"></div>`
  - [ ] Add `announceUpdate()` method to BlockPreviewManager
  - [ ] Method updates ARIA live region text with announcement
  - [ ] Call `announceUpdate()` from `updatePreview()` after successful render
  - [ ] Test with screen reader (NVDA/JAWS)

- [ ] **Task 2: Implement Error Handling in updatePreview()** (AC: 3)
  - [ ] Wrap updatePreview() method body in try/catch
  - [ ] Catch block logs error and calls `showErrorState()`
  - [ ] `showErrorState()` displays user-friendly error message
  - [ ] Test error handling by forcing an error
  - [ ] Verify preview doesn't crash on errors

- [ ] **Task 3: Enhance Empty State Message** (AC: 2, 3)
  - [ ] Update `showEmptyState()` message to be more helpful
  - [ ] Message: "No blocks selected. Drag blocks from the left to see preview."
  - [ ] Style empty state with icon and centered layout
  - [ ] Test empty state displays correctly when all blocks removed

- [ ] **Task 4: Add Browser Compatibility Check** (AC: 4)
  - [ ] Add `checkBrowserSupport()` method to BlockPreviewManager
  - [ ] Check for CSS Grid support and template element support
  - [ ] Log warning if browser doesn't fully support features
  - [ ] Call check in `init()` method
  - [ ] Test in older browsers if available

- [ ] **Task 5: Add Smooth Scrolling to Preview** (AC: 1)
  - [ ] Add `scroll-behavior: smooth;` to iframe body CSS
  - [ ] Test scrolling behavior feels smooth and natural
  - [ ] Consider scroll position handling (reset vs. maintain)

- [ ] **Task 6: Polish Preview Header Styling** (AC: 1)
  - [ ] Review preview header CSS in `admin-block-preview.css`
  - [ ] Ensure disclaimer text is visible and styled appropriately
  - [ ] Verify header matches WordPress admin design patterns
  - [ ] Check spacing and typography consistency

- [ ] **Task 7: Add Preview Container Visual Depth** (AC: 1)
  - [ ] Review preview container styling for border/shadow
  - [ ] Add subtle box-shadow to iframe for depth
  - [ ] Ensure shadow doesn't interfere with readability
  - [ ] Test visual appearance across browsers

- [ ] **Task 8: Handle Unknown Block Types Gracefully** (AC: 3)
  - [ ] Verify `getBlockTemplate()` has fallback for unknown types
  - [ ] Fallback returns styled "unknown block" placeholder
  - [ ] Test with intentionally invalid block type
  - [ ] Verify no console errors for unknown blocks

- [ ] **Task 9: Add Keyboard Navigation Testing** (AC: 5)
  - [ ] Test Tab key navigation between panes
  - [ ] Verify focus order is logical (ordering panel → preview)
  - [ ] Ensure focus doesn't get trapped in iframe
  - [ ] Test Escape key behavior (should not interfere)
  - [ ] Verify keyboard shortcuts work correctly

- [ ] **Task 10: Verify WCAG AA Color Contrast** (AC: 5)
  - [ ] Check text color contrast ratios in preview templates
  - [ ] Verify all text meets WCAG AA standards (4.5:1 for normal, 3:1 for large)
  - [ ] Use browser DevTools accessibility checker
  - [ ] Fix any contrast issues found

- [ ] **Task 11: Performance Testing - All Blocks** (AC: 6)
  - [ ] Load preview with all 12 blocks
  - [ ] Measure render time using Performance tab
  - [ ] Verify no lag or frame drops
  - [ ] Check memory usage stability

- [ ] **Task 12: Performance Testing - Rapid Reordering** (AC: 6)
  - [ ] Perform 20+ rapid drag-drop operations
  - [ ] Monitor for lag, stuttering, or slowdown
  - [ ] Check browser Performance tab for issues
  - [ ] Verify memory doesn't continuously increase

- [ ] **Task 13: Performance Testing - Memory Leaks** (AC: 6)
  - [ ] Open Chrome DevTools Memory tab
  - [ ] Take heap snapshot
  - [ ] Perform 50+ preview updates
  - [ ] Take another heap snapshot
  - [ ] Compare snapshots - verify no significant growth
  - [ ] Check for detached DOM nodes

- [ ] **Task 14: Browser Compatibility Testing** (AC: 4)
  - [ ] Test full workflow in Chrome 90+
  - [ ] Test full workflow in Firefox 88+
  - [ ] Test full workflow in Edge 90+
  - [ ] Test full workflow in Safari 14+ (if available)
  - [ ] Document any browser-specific quirks

- [ ] **Task 15: Final UX Polish Pass** (AC: 1, 2)
  - [ ] Review entire feature from user perspective
  - [ ] Check all messaging is clear and helpful
  - [ ] Verify visual consistency across interface
  - [ ] Test complete user workflow end-to-end
  - [ ] Gather feedback from test user if possible

- [ ] **Task 16: Code Documentation Review** (AC: All)
  - [ ] Review all JSDoc comments for completeness
  - [ ] Add missing comments to public methods
  - [ ] Document any non-obvious code patterns
  - [ ] Add inline comments for complex logic

---

## Dev Notes

### Feature Context

This story is the final polish pass for the Live Block Preview feature. It focuses on accessibility, error handling, edge cases, and overall UX refinement to ensure the feature is production-ready. The goal is to handle every possible scenario gracefully and provide a professional, polished user experience.

**Key Goal:** Ensure the preview feature is bulletproof, accessible, and delightful to use.

### Previous Story Insights

From Story 10.1 (Split-Pane Layout and Preview Infrastructure):
- BlockPreviewManager class has `showEmptyState()` and `showErrorState()` stub methods [Source: Story 10.1]
- ARIA live region already added to template for screen reader announcements [Source: templates/admin/import.php:72]
- Preview iframe uses sandbox attribute for security [Source: Story 10.1]

From Story 10.2 (Create Block HTML Templates for Preview) - **IMPLEMENTED:**
- All 12 block templates created and tested [Source: Story 10.2 Dev Agent Record]
- Templates use via.placeholder.com for images
- Color palette uses #4A90E2 consistently
- `getBlockTemplate()` has fallback for unknown block types [Source: Story 10.2]
- Build compiled successfully at 24.9 KiB minified

From Story 10.3 (Integrate Real-Time Preview Updates with Block Ordering):
- `updatePreview()` method handles block order arrays [Source: Story 10.3]
- Preview updates triggered on drag, remove, reset events [Source: Story 10.3]
- Null checks prevent errors if preview manager missing [Source: Story 10.3]

### Technical Architecture

**Error Handling Flow:**
```
updatePreview() → try/catch →
  Success: Render templates + announceUpdate() →
  Failure: Log error + showErrorState()
```

**Accessibility Flow:**
```
Preview Update → updatePreview() → announceUpdate() →
ARIA Live Region → Screen Reader Announcement
```

### File Locations

**From Unified Project Structure** [Source: architecture.md#Unified Project Structure]:

**JavaScript:**
- Modify: `assets/js/src/block-preview.js` - Add error handling, ARIA announcements, browser check

**CSS:**
- Modify: `assets/css/admin-block-preview.css` - Polish styling (if needed)

### Component Specifications

**ARIA Announcements Implementation**

Location: Add to `BlockPreviewManager` class in `assets/js/src/block-preview.js`

```javascript
/**
 * Announce preview update to screen readers
 *
 * @param {number} blockCount - Number of blocks in preview
 */
announceUpdate(blockCount) {
    // Find ARIA live region in parent document (not in iframe)
    const liveRegion = document.querySelector('.preview-sr-announcements');

    if (!liveRegion) {
        console.warn('[Block Preview] ARIA live region not found');
        return;
    }

    const announcement = `Preview updated with ${blockCount} block${blockCount !== 1 ? 's' : ''}`;

    // Update text content for screen readers
    liveRegion.textContent = announcement;

    // Clear after 1 second to allow multiple announcements
    setTimeout(() => {
        liveRegion.textContent = '';
    }, 1000);
}
```

**Error Handling Implementation**

Location: Modify `updatePreview()` method in `assets/js/src/block-preview.js`

```javascript
/**
 * Update preview with block order
 *
 * @param {Array} blockOrder - Array of block type strings
 */
updatePreview(blockOrder) {
    try {
        if (!this.iframeDoc) {
            console.error('[Block Preview] Iframe document not accessible');
            this.showErrorState();
            return;
        }

        // Handle empty block order
        if (!blockOrder || blockOrder.length === 0) {
            this.showEmptyState();
            return;
        }

        // Generate HTML from block templates
        const htmlContent = blockOrder.map(blockType => {
            return getBlockTemplate(blockType);
        }).join('');

        // Update iframe content
        const root = this.iframeDoc.getElementById('preview-root');
        if (root) {
            root.innerHTML = htmlContent;
        }

        // Announce to screen readers
        this.announceUpdate(blockOrder.length);

        console.log(`[Block Preview] Rendered ${blockOrder.length} blocks successfully`);

    } catch (error) {
        console.error('[Block Preview] Update failed:', error);
        this.showErrorState();
    }
}
```

**Enhanced Empty State**

Location: Modify `showEmptyState()` method in `assets/js/src/block-preview.js`

```javascript
/**
 * Show empty state message when no blocks selected
 */
showEmptyState() {
    if (!this.iframeDoc) return;

    const root = this.iframeDoc.getElementById('preview-root');
    if (root) {
        root.innerHTML = `
            <div class="preview-empty-state">
                <p class="empty-state-icon" aria-hidden="true">📋</p>
                <p class="empty-state-message">No blocks selected.</p>
                <p class="empty-state-hint">Drag blocks from the left to see preview.</p>
            </div>
        `;
    }

    console.log('[Block Preview] Showing empty state');
}
```

**Enhanced Error State**

Location: Modify `showErrorState()` method in `assets/js/src/block-preview.js`

```javascript
/**
 * Show error state when preview rendering fails
 */
showErrorState() {
    if (!this.iframeDoc) return;

    const root = this.iframeDoc.getElementById('preview-root');
    if (root) {
        root.innerHTML = `
            <div class="preview-error-state">
                <p class="error-state-icon" aria-hidden="true">⚠️</p>
                <p class="error-state-message">Preview could not be rendered.</p>
                <p class="error-state-hint">Please refresh the page or contact support if the issue persists.</p>
            </div>
        `;
    }

    console.error('[Block Preview] Showing error state');
}
```

**Browser Compatibility Check**

Location: Add to `BlockPreviewManager` class in `assets/js/src/block-preview.js`

```javascript
/**
 * Check browser compatibility for preview features
 *
 * @return {boolean} True if browser supports required features
 */
checkBrowserSupport() {
    const checks = {
        template: 'content' in document.createElement('template'),
        grid: 'grid' in document.createElement('div').style,
        flexbox: 'flex' in document.createElement('div').style,
    };

    const isSupported = Object.values(checks).every(check => check === true);

    if (!isSupported) {
        console.warn('[Block Preview] Browser may not fully support preview features:', checks);
    } else {
        console.log('[Block Preview] Browser compatibility check passed');
    }

    return isSupported;
}
```

**Call in init() method:**
```javascript
init() {
    // Check browser compatibility
    this.checkBrowserSupport();

    if (!this.iframe) {
        console.error('[Block Preview] Iframe element not found');
        return;
    }

    // ... existing initialization code ...
}
```

**Enhanced CSS for Empty and Error States**

Location: Add to `getBaseCSS()` method in `assets/js/src/block-preview.js`

```css
/* Empty State */
.preview-empty-state {
    text-align: center;
    padding: 80px 20px;
    color: #646970;
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.empty-state-message {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: #1d2327;
}

.empty-state-hint {
    font-size: 14px;
    margin: 0;
    color: #646970;
}

/* Error State */
.preview-error-state {
    text-align: center;
    padding: 80px 20px;
    color: #d63638;
}

.error-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.error-state-message {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: #d63638;
}

.error-state-hint {
    font-size: 14px;
    margin: 0;
    color: #646970;
}

/* Smooth Scrolling */
html {
    scroll-behavior: smooth;
}
```

**Visual Polish - Preview Container Shadow**

Location: Modify `assets/css/admin-block-preview.css`

```css
/* Add subtle depth to preview container */
#block-preview-container {
    position: relative;
    background: #f6f7f7;
    border: 1px solid #c3c4c7;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* NEW: Subtle shadow */
}

#block-preview-iframe {
    width: 100%;
    min-height: 600px;
    border: none;
    display: block;
    background: #fff;
}
```

### Accessibility Considerations

**WCAG AA Color Contrast Requirements:**
- Normal text (< 18pt): 4.5:1 contrast ratio
- Large text (≥ 18pt or 14pt bold): 3:1 contrast ratio

**Current Color Palette** [Source: Story 10.2]:
- Primary: #4A90E2 (blue) - Check contrast with white backgrounds
- Text: #1d2327 (dark gray) - Should pass easily
- Secondary text: #50575e (medium gray) - Verify on white
- Light backgrounds: #f9f9f9 - Test with text colors

**Testing Tools:**
- Chrome DevTools Lighthouse (Accessibility audit)
- WebAIM Contrast Checker
- NVDA screen reader (Windows)
- VoiceOver screen reader (Mac)

### Performance Benchmarks

**Target Performance:**
- Initial preview render: < 500ms
- Preview update: < 100ms
- All 12 blocks render: < 200ms
- Memory stable after 50 updates: < 5MB growth
- No detached DOM nodes after interactions

**Testing Methodology:**
1. Open Chrome DevTools Performance tab
2. Start recording
3. Perform test actions
4. Stop recording
5. Analyze flame chart for bottlenecks

### Browser Compatibility Notes

**Target Browsers** [Source: Epic 10]:
- Chrome 90+ (released April 2021)
- Firefox 88+ (released April 2021)
- Safari 14+ (released September 2020)
- Edge 90+ (released April 2021)

**Known Compatibility:**
- CSS Grid: Supported in all target browsers
- Template elements: Supported in all target browsers
- Flexbox: Supported in all target browsers
- iframe sandbox: Supported in all target browsers

### WordPress Coding Standards

**JavaScript Standards** [Source: architecture.md#Tech Stack - Code Quality (JS)]:
- Use ES6+ features (const, let, arrow functions, template literals)
- JSDoc comments for all public methods
- Follow existing code style in block-preview.js
- Console logging with `[Block Preview]` prefix for consistency

**Accessibility Standards:**
- ARIA labels for all interactive elements
- ARIA live regions for dynamic content updates
- Keyboard navigation support
- Screen reader tested

---

## Testing

### Testing Standards

**Manual Testing** (Primary approach for polish/UX work):
- Comprehensive user experience testing
- Accessibility testing with screen readers
- Performance testing with DevTools
- Browser compatibility testing
- Test in multiple browsers and screen sizes

**Focus Areas:**
- User experience flow
- Error handling robustness
- Accessibility compliance
- Performance validation
- Visual polish

### Test Cases

**Accessibility Test: Screen Reader Announcements**
- [ ] Open page with NVDA or VoiceOver enabled
- [ ] Drag-drop a block to reorder
- [ ] Verify screen reader announces: "Preview updated with 12 blocks"
- [ ] Remove a block
- [ ] Verify screen reader announces: "Preview updated with 11 blocks"
- [ ] Remove all blocks
- [ ] Verify screen reader announces empty state

**Accessibility Test: Keyboard Navigation**
- [ ] Use only keyboard (no mouse)
- [ ] Tab through block ordering controls
- [ ] Tab to preview pane (focus indicator visible)
- [ ] Tab through all interactive elements
- [ ] Verify focus order is logical
- [ ] Verify focus doesn't get trapped in iframe
- [ ] Test Shift+Tab reverse navigation

**Accessibility Test: Color Contrast**
- [ ] Open Chrome DevTools
- [ ] Run Lighthouse accessibility audit
- [ ] Check for color contrast failures
- [ ] Manually verify text is readable
- [ ] Test with color blindness simulator
- [ ] Fix any contrast issues found

**Error Handling Test: Invalid Block Type**
- [ ] Temporarily modify code to pass invalid block type
- [ ] Verify preview shows fallback "unknown block" template
- [ ] Verify no console errors (or handled gracefully)
- [ ] Restore code

**Error Handling Test: Iframe Not Loading**
- [ ] Temporarily break iframe initialization
- [ ] Verify error state displays
- [ ] Verify no JavaScript exceptions crash page
- [ ] Verify ordering panel still functions
- [ ] Restore code

**Performance Test: All Blocks Rendering**
- [ ] Open Chrome DevTools Performance tab
- [ ] Start recording
- [ ] Load preview with all 12 blocks
- [ ] Stop recording
- [ ] Verify render time < 200ms
- [ ] Check for layout thrashing or long tasks

**Performance Test: Rapid Reordering**
- [ ] Open Chrome DevTools Performance tab
- [ ] Start recording
- [ ] Perform 20 rapid drag-drop operations
- [ ] Stop recording
- [ ] Verify no frame drops or stuttering
- [ ] Check FPS stays near 60

**Performance Test: Memory Leaks**
- [ ] Open Chrome DevTools Memory tab
- [ ] Click "Take snapshot"
- [ ] Perform 50 preview updates (drag, remove, reset repeatedly)
- [ ] Click "Take snapshot" again
- [ ] Compare snapshots
- [ ] Verify heap size growth < 5MB
- [ ] Check for detached DOM nodes (should be minimal)

**Browser Compatibility Test: Chrome**
- [ ] Test in Chrome 90+
- [ ] Verify split-pane layout renders correctly
- [ ] Verify all interactions work (drag, remove, reset)
- [ ] Verify preview updates smoothly
- [ ] Check console for errors

**Browser Compatibility Test: Firefox**
- [ ] Test in Firefox 88+
- [ ] Verify split-pane layout renders correctly
- [ ] Verify all interactions work (drag, remove, reset)
- [ ] Verify preview updates smoothly
- [ ] Check console for errors
- [ ] Note any Firefox-specific quirks

**Browser Compatibility Test: Edge**
- [ ] Test in Edge 90+
- [ ] Verify split-pane layout renders correctly
- [ ] Verify all interactions work (drag, remove, reset)
- [ ] Verify preview updates smoothly
- [ ] Check console for errors

**Browser Compatibility Test: Safari (Optional)**
- [ ] Test in Safari 14+
- [ ] Verify split-pane layout renders correctly
- [ ] Verify all interactions work (drag, remove, reset)
- [ ] Verify preview updates smoothly
- [ ] Check console for errors
- [ ] Note any Safari-specific quirks

**Visual Polish Test: Overall Appearance**
- [ ] Load import settings page
- [ ] Verify preview header is well-styled
- [ ] Verify disclaimer text is visible and clear
- [ ] Verify preview container has subtle shadow/depth
- [ ] Verify spacing and padding is comfortable
- [ ] Verify colors match WordPress admin design

**Visual Polish Test: Empty State**
- [ ] Remove all blocks
- [ ] Verify empty state displays centered
- [ ] Verify icon (📋) and messaging are clear
- [ ] Verify hint text is helpful
- [ ] Verify styling matches preview design

**Visual Polish Test: Error State**
- [ ] Force an error (temporarily break code)
- [ ] Verify error state displays centered
- [ ] Verify icon (⚠️) and messaging are clear
- [ ] Verify hint text is helpful
- [ ] Restore code

**User Experience Test: Complete Workflow**
- [ ] Load import settings page
- [ ] Verify initial preview shows all 12 blocks
- [ ] Remove 3 blocks (Comparison, Size & Fit, Ethics)
- [ ] Verify preview updates immediately
- [ ] Drag FAQs to position 2
- [ ] Verify preview updates immediately
- [ ] Drag CTA to position 3
- [ ] Verify preview updates immediately
- [ ] Click Reset to Default Order
- [ ] Verify preview and ordering panel both reset
- [ ] Remove all blocks
- [ ] Verify empty state shows
- [ ] Reset again
- [ ] Verify all blocks return
- [ ] No errors throughout entire workflow

**Documentation Review Test:**
- [ ] Review all JSDoc comments in block-preview.js
- [ ] Verify all public methods documented
- [ ] Verify parameter types and return types specified
- [ ] Verify complex logic has inline comments
- [ ] Check for typos or unclear descriptions

**Manual QA Checklist:**
- [ ] Preview disclaimer text clearly visible
- [ ] Preview header styled consistently with WordPress admin
- [ ] Preview iframe has subtle border/shadow for depth
- [ ] Scrolling behavior smooth and intuitive
- [ ] Preview content well-padded and readable
- [ ] Empty state message helpful and clear
- [ ] Preview handles unknown block types gracefully
- [ ] Preview handles errors gracefully
- [ ] Preview recovers from rendering errors
- [ ] Works in Chrome, Firefox, Edge, Safari
- [ ] ARIA announcements work with screen readers
- [ ] Keyboard navigation works correctly
- [ ] Focus doesn't get trapped in iframe
- [ ] Color contrast meets WCAG AA standards
- [ ] No lag with all 12 blocks
- [ ] No lag with rapid reordering
- [ ] No memory leaks after repeated updates
- [ ] No console errors under any scenario
- [ ] Code properly documented

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation for Epic 10 | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after testing*
