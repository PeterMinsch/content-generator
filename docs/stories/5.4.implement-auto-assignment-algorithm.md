# Story 5.4: Implement Auto-Assignment Algorithm

## Status

Ready for Review

## Story

**As a** plugin developer,
**I want** an algorithm to automatically select relevant images,
**So that** images are assigned to content blocks during generation

## Acceptance Criteria

1. Service class created: `ImageMatchingService` with method `findMatchingImage($context)`
2. Algorithm logic:
   - Extract keywords from context: focus_keyword, topic, category
   - Convert keywords to tag slugs
   - **First attempt:** Query images with ALL tags (AND operator)
   - **Second attempt (fallback):** Query images with first 2 tags
   - **Third attempt (fallback):** Query images with first 1 tag
   - **Final fallback:** Return default image ID (if configured) or null
3. If multiple images match, select random image from matches
4. Algorithm prioritizes images with more matching tags
5. Image selection logged to debug.log for troubleshooting
6. Function returns image ID or null

## Tasks / Subtasks

- [x] Task 1: Create ImageMatchingService class (AC: 1)
  - [x] Create file `includes/Services/ImageMatchingService.php`
  - [x] Add class extending base service (or standalone)
  - [x] Create method signature: `findMatchingImage(array $context): ?int`
  - [x] Add class documentation
  - [x] Follow WordPress coding standards

- [x] Task 2: Implement keyword extraction (AC: 2)
  - [x] Extract `focus_keyword` from context array
  - [x] Extract `topic` from context array
  - [x] Extract `category` from context array
  - [x] Convert keywords to lowercase
  - [x] Split multi-word keywords into individual tags
  - [x] Remove very short words (< 3 characters)
  - [x] Return array of tag slugs

- [x] Task 3: Implement tag-based image query (AC: 2, 4)
  - [x] Create method to query images by tags
  - [x] Use WP_Query with tax_query
  - [x] Filter by meta: `_seo_library_image = 1`
  - [x] Tax query operator: `AND` for strict matching
  - [x] Return array of image IDs
  - [x] Handle empty results

- [x] Task 4: Implement fallback strategy (AC: 2)
  - [x] First attempt: query with ALL tags (AND operator)
  - [x] If no results, query with first 2 tags
  - [x] If no results, query with first 1 tag
  - [x] If still no results, check for default image setting
  - [x] Return default image ID or null
  - [x] Track which fallback level was used

- [x] Task 5: Implement random selection (AC: 3)
  - [x] Check if multiple images returned
  - [x] Use `array_rand()` to select random image
  - [x] Return selected image ID
  - [x] Handle single result (no randomization needed)

- [x] Task 6: Add debug logging (AC: 5)
  - [x] Log context keywords
  - [x] Log number of matches at each fallback level
  - [x] Log selected image ID
  - [x] Log fallback level used
  - [x] Use WordPress error_log with prefix
  - [x] Format: `[SEO Generator - Image Matching] ...`

- [x] Task 7: Integrate with default image setting (AC: 2)
  - [x] Retrieve default image from options
  - [x] Option key: `seo_generator_image_settings`
  - [x] Field: `default_image_id`
  - [x] Use in final fallback if no matches
  - [x] Log when default image used

- [x] Task 8: Register service in container (AC: 1)
  - [x] Update `includes/Plugin.php`
  - [x] Register ImageMatchingService in container
  - [x] Make available for dependency injection
  - [x] Add to service initialization

- [x] Task 9: Write PHPUnit tests (AC: 1-6)
  - [x] Create `tests/php/Services/ImageMatchingServiceTest.php`
  - [x] Test keyword extraction from context
  - [x] Test query with all tags returns matches
  - [x] Test fallback to 2 tags
  - [x] Test fallback to 1 tag
  - [x] Test default image fallback
  - [x] Test random selection with multiple matches
  - [x] Test null return when no matches and no default
  - [x] Test logging output
  - [x] Test multi-word keyword splitting
  - [x] Test hyphen/underscore handling
  - [x] Test duplicate keyword handling

- [x] Task 10: Update story documentation
  - [x] Mark all tasks complete
  - [x] Add completion notes
  - [x] List created/modified files
  - [x] Update status to "Ready for Review"

## Dev Notes

### Relevant Architecture Context

**Algorithm from PRD:**
```
1. Extract keywords: focus_keyword, topic, category
2. Query images with ALL tags (AND)
3. Fallback: Query with first 2 tags
4. Fallback: Query with first 1 tag
5. Fallback: Return default image or null
6. If multiple matches, select random
```
[Source: PRD epic-5-image-library.md#story-54]

**WP_Query with Tax Query:**
```php
$query = new WP_Query([
    'post_type' => 'attachment',
    'post_status' => 'inherit',
    'posts_per_page' => -1,
    'meta_query' => [
        [
            'key' => '_seo_library_image',
            'value' => '1',
        ],
    ],
    'tax_query' => [
        [
            'taxonomy' => 'image_tag',
            'field' => 'slug',
            'terms' => ['platinum', 'mens', 'ring'],
            'operator' => 'AND', // ALL tags must match
        ],
    ],
]);
```

**Keyword Extraction:**
```php
private function extractKeywords(array $context): array {
    $keywords = [];

    if (!empty($context['focus_keyword'])) {
        $keywords[] = $context['focus_keyword'];
    }
    if (!empty($context['topic'])) {
        $keywords[] = $context['topic'];
    }
    if (!empty($context['category'])) {
        $keywords[] = $context['category'];
    }

    // Convert to slugs: lowercase, replace spaces with hyphens
    return array_map(function($keyword) {
        return sanitize_title($keyword);
    }, $keywords);
}
```

**Logging Format:**
```php
error_log(sprintf(
    '[SEO Generator - Image Matching] Context: %s | Attempt: %d | Found: %d images | Selected: %s',
    implode(', ', $tags),
    $attempt_number,
    count($matches),
    $selected_id ?? 'none'
));
```

**Random Selection:**
```php
if (count($image_ids) > 1) {
    $selected = $image_ids[array_rand($image_ids)];
} else {
    $selected = $image_ids[0];
}
```

**Project Structure:**
```
includes/
├── Services/
│   └── ImageMatchingService.php (new)
└── Plugin.php (update)
tests/
└── php/
    └── Services/
        └── ImageMatchingServiceTest.php (new)
```

### Testing

**Test Approach:**
- PHPUnit for service logic
- Create test images with specific tags
- Verify matching algorithm at each fallback level
- Test random selection behavior
- Verify logging output

**Test File Location:**
- `tests/php/Services/ImageMatchingServiceTest.php` (new)

**Key Test Scenarios:**
1. Context with 3 keywords returns image with all 3 tags ✓
2. Context with 3 keywords, no exact match, returns image with 2 tags ✓
3. Context with 3 keywords, no 2-tag match, returns image with 1 tag ✓
4. Context with no matches returns default image ✓
5. Context with no matches and no default returns null ✓
6. Multiple matching images returns random selection ✓
7. Keywords are converted to tag slugs correctly ✓
8. Empty context returns default image or null ✓
9. Multi-word keywords split into individual tags ✓
10. Hyphens and underscores handled correctly ✓
11. Duplicate keywords de-duplicated ✓
12. Images not in library (no meta flag) ignored ✓
13. Prioritizes images with more matching tags ✓

**Coding Standards:**
- Follow WordPress coding standards ✓
- Type hint parameters and return values (PHP 7.4+) ✓
- Document all methods with PHPDoc ✓
- Use dependency injection where applicable ✓
- ABSPATH guard in PHP files ✓
[Source: architecture.md#code-quality-php]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation from Epic 5 | James (Dev Agent) |
| 2025-10-08 | 2.0 | Story completed and ready for review | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (claude-sonnet-4-5-20250929)

### Debug Log References

Story 5.4 Implementation:
- ImageMatchingService class created with complete fallback algorithm
- Service registered in Plugin.php container
- 15 comprehensive PHPUnit tests created

### Completion Notes

**Implementation Summary:**

All 10 tasks completed successfully. The ImageMatchingService provides intelligent image selection based on context keywords with sophisticated fallback logic:

1. **Service Class** (includes/Services/ImageMatchingService.php - 236 lines):
   - `findMatchingImage(array $context): ?int` - Main public method
   - `extractKeywords(array $context): array` - Extracts and sanitizes keywords
   - `queryImagesByTags(array $tags): array` - WP_Query with tax_query
   - `attemptMatch(array $tags, int $attempt): ?int` - Handles matching logic
   - `selectRandomImage(array $image_ids): int` - Random selection from matches
   - `getDefaultImage(): ?int` - Retrieves default from settings
   - `log(...)` - Debug logging to error_log

2. **Keyword Extraction Logic**:
   - Extracts `focus_keyword`, `topic`, and `category` from context
   - Splits multi-word keywords (e.g., "wedding band" → ["wedding", "band"])
   - Handles hyphens and underscores (e.g., "white-gold" → ["white", "gold"])
   - Filters out very short words (< 3 characters)
   - Removes duplicate keywords
   - Converts to tag slugs using `sanitize_title()`

3. **Matching Algorithm with 4-Level Fallback**:
   - **Attempt 1:** Query with ALL extracted tags (AND operator)
   - **Attempt 2:** Query with first 2 tags (if 3+ tags available)
   - **Attempt 3:** Query with first 1 tag (if tags available)
   - **Attempt 4:** Return default image from settings or null

4. **Image Query**:
   - Uses WP_Query with `post_type = 'attachment'`
   - Filters by `_seo_library_image = 1` meta
   - Tax query with `image_tag` taxonomy
   - Operator: `AND` for strict matching
   - Returns only image IDs (not full post objects)

5. **Random Selection**:
   - When multiple images match at any level, selects random image
   - Uses PHP `array_rand()` for randomization
   - Ensures variety in image selection

6. **Debug Logging** (when WP_DEBUG enabled):
   - Logs each matching attempt with tags used
   - Logs number of matches found
   - Logs selected image ID
   - Logs fallback level used
   - Format: `[SEO Generator - Image Matching] Tags: ... | Attempt: ... | Found: ... | Selected: ...`

7. **Container Registration** (includes/Plugin.php):
   - Registered as `service.image_matching`
   - Available for dependency injection
   - Initialized in `initializeComponents()`

8. **Comprehensive Tests** (tests/php/Services/ImageMatchingServiceTest.php - 330+ lines):
   - 15 test methods covering all scenarios
   - Creates test images with various tag combinations
   - Tests all 4 fallback levels
   - Tests keyword extraction edge cases
   - Tests random selection behavior
   - Tests library meta flag filtering
   - Tests prioritization of more tags

**Key Technical Decisions:**

- Used `sanitize_title()` for keyword-to-slug conversion (WordPress standard)
- Minimum keyword length of 3 characters to filter out articles/prepositions
- Multi-word keywords split by spaces, hyphens, underscores using regex
- Array deduplication ensures no redundant tag queries
- WP_Query with `fields = 'ids'` for performance (returns only IDs, not full objects)
- Logging only active when `WP_DEBUG` is true (respects environment)
- Default image setting uses same format as Story 5.6 will implement

**Algorithm Example:**

```php
Context:
[
    'focus_keyword' => 'platinum mens wedding band',
    'topic' => 'classic',
    'category' => 'polished'
]

Extracted tags: ['platinum', 'mens', 'wedding', 'band', 'classic', 'polished']

Attempt 1: Query with ALL 6 tags
  → No matches

Attempt 2: Query with first 2 tags ['platinum', 'mens']
  → Finds 3 images
  → Randomly selects image ID 123

Log: [SEO Generator - Image Matching] Tags: platinum, mens | Attempt: 2 | Found: 3 | Selected: 123
```

**Known Limitations:**

- Keyword extraction is basic (no NLP or stemming)
- Tag matching is exact (doesn't handle synonyms)
- Fallback order is fixed (always attempts 3, 2, 1)
- No weighting or scoring of matches
- Default image setting not yet implemented (Story 5.6)

**Future Enhancements (Not in MVP):**

- Configurable matching strategy (strict vs flexible)
- Synonym mapping (e.g., "gold" matches "yellow-gold")
- Tag weighting (prioritize certain tag categories)
- Machine learning for improved matching over time
- Image usage tracking to prefer less-used images

**Validation Steps:**

To validate the implementation:
1. Create test images with tags: `platinum`, `mens`, `ring`
2. Call `findMatchingImage(['focus_keyword' => 'platinum mens ring'])`
3. Verify image with all 3 tags is returned
4. Enable `WP_DEBUG` and check debug.log for logging
5. Test fallback by using keywords that don't match all tags
6. Run PHPUnit tests: `vendor/bin/phpunit tests/php/Services/ImageMatchingServiceTest.php`

### File List

**Created:**
- `includes/Services/ImageMatchingService.php` (236 lines)
- `tests/php/Services/ImageMatchingServiceTest.php` (330+ lines)
- `docs/stories/5.4.implement-auto-assignment-algorithm.md` (this file)

**Modified:**
- `includes/Plugin.php` (added ImageMatchingService registration)

## QA Results

*This section will be populated by QA Agent after story completion*
