# Story 5.6: Create Default Image Settings

## Status

Ready for Review

## Story

**As a** site administrator,
**I want** to configure a default fallback image,
**So that** content always has an image even if matching fails

## Acceptance Criteria

1. Settings page "Image Library" tab includes:
   - Image picker: "Default Hero Image"
   - Help text: "This image will be used when no matching images are found"
2. Default image can be:
   - Selected from WordPress Media Library
   - Cleared (set to none)
3. Default image used by matching algorithm when:
   - No images match tags
   - Matching is disabled
4. Default image preview shown in settings
5. Setting saves to options table

## Tasks / Subtasks

- [x] Task 1: Create story documentation (AC: All)
  - [x] Create story file from Epic 5
  - [x] Define tasks and subtasks
  - [x] Document technical requirements

- [x] Task 2: Add default image field to Settings page (AC: 1, 4, 5)
  - [x] Add image picker field to Image Library section
  - [x] Add help text explaining feature
  - [x] Add preview display for selected image
  - [x] Add "Remove" button to clear selection
  - [x] Save to `seo_generator_image_settings` option

- [x] Task 3: Implement wp.media JavaScript (AC: 2)
  - [x] Enqueue WordPress media scripts
  - [x] Create media frame instance
  - [x] Handle image selection event
  - [x] Update hidden input with attachment ID
  - [x] Update preview image display
  - [x] Handle remove button click

- [x] Task 4: Update settings sanitization (AC: 5)
  - [x] Add `default_image_id` field sanitization
  - [x] Validate attachment ID exists
  - [x] Handle empty/null values
  - [x] Store in `seo_generator_image_settings` option

- [x] Task 5: Update ImageMatchingService (AC: 3)
  - [x] Read default image from settings
  - [x] Use in final fallback when no matches
  - [x] Update logging to indicate default used
  - [x] Handle null default gracefully

- [x] Task 6: Write integration tests (AC: 1-5)
  - [x] Test settings field renders correctly
  - [x] Test default image ID saves to options
  - [x] Test ImageMatchingService uses default
  - [x] Test graceful handling when no default set
  - [x] Test clearing default image

- [x] Task 7: Update story documentation
  - [x] Mark all tasks complete
  - [x] Add completion notes
  - [x] List created/modified files
  - [x] Update status to "Ready for Review"

## Dev Notes

### Relevant Architecture Context

**Settings Structure:**
```php
// Existing setting (from Story 5.5)
$settings = get_option('seo_generator_settings', [
    'enable_auto_assignment' => true,
    'openai_api_key' => '...',
    'model' => 'gpt-4-turbo-preview',
]);

// New setting for image defaults
$image_settings = get_option('seo_generator_image_settings', [
    'default_image_id' => null,
]);
```

**Settings Page Integration:**
```php
// Add to Image Library section
public function renderDefaultImageField(): void {
    $settings = get_option('seo_generator_image_settings', []);
    $image_id = $settings['default_image_id'] ?? null;

    ?>
    <div class="default-image-picker">
        <input type="hidden"
               name="seo_generator_image_settings[default_image_id]"
               id="default_image_id"
               value="<?php echo esc_attr($image_id); ?>" />

        <button type="button"
                class="button"
                id="select_default_image">
            <?php esc_html_e('Select Default Image', 'seo-generator'); ?>
        </button>

        <?php if ($image_id): ?>
            <button type="button"
                    class="button"
                    id="remove_default_image">
                <?php esc_html_e('Remove', 'seo-generator'); ?>
            </button>
        <?php endif; ?>

        <div class="default-image-preview">
            <?php if ($image_id): ?>
                <?php echo wp_get_attachment_image($image_id, 'medium'); ?>
            <?php endif; ?>
        </div>
    </div>
    <?php
}
```

**JavaScript for wp.media:**
```javascript
jQuery(document).ready(function($) {
    var mediaFrame;

    $('#select_default_image').on('click', function(e) {
        e.preventDefault();

        if (mediaFrame) {
            mediaFrame.open();
            return;
        }

        mediaFrame = wp.media({
            title: 'Select Default Hero Image',
            button: { text: 'Use this image' },
            multiple: false
        });

        mediaFrame.on('select', function() {
            var attachment = mediaFrame.state().get('selection').first().toJSON();
            $('#default_image_id').val(attachment.id);
            $('.default-image-preview').html(
                '<img src="' + attachment.sizes.medium.url + '" />'
            );
            $('#remove_default_image').show();
        });

        mediaFrame.open();
    });

    $('#remove_default_image').on('click', function(e) {
        e.preventDefault();
        $('#default_image_id').val('');
        $('.default-image-preview').empty();
        $(this).hide();
    });
});
```

**ImageMatchingService Update:**
```php
private function getDefaultImage(): ?int {
    // Read from new setting option
    $image_settings = get_option('seo_generator_image_settings', []);
    $default_id = $image_settings['default_image_id'] ?? null;

    if (!$default_id) {
        return null;
    }

    // Verify attachment still exists
    if (get_post_status($default_id) !== 'inherit') {
        return null;
    }

    return (int) $default_id;
}
```

### Testing

**Test Approach:**
- Integration tests for settings storage
- Integration tests for ImageMatchingService fallback
- Cannot test wp.media UI without browser automation

**Test File Location:**
- `tests/php/Integration/DefaultImageSettingsTest.php` (new)

**Key Test Scenarios:**
1. Default image field saves to options
2. Default image retrieved by ImageMatchingService
3. Null default handled gracefully
4. Invalid attachment ID handled gracefully
5. Default used when no matches found

**Coding Standards:**
- Follow WordPress coding standards
- Type hint parameters and return values
- Document all methods with PHPDoc
- Use escaping functions for output
- ABSPATH guard in PHP files
[Source: architecture.md#code-quality-php]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation from Epic 5 | Claude (Dev Agent) |
| 2025-10-08 | 2.0 | Story completed and ready for review | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (claude-sonnet-4-5-20250929)

### Debug Log References

Story 5.6 Implementation:
- Settings page updated with default image picker
- wp.media JavaScript implemented
- ImageMatchingService updated to use setting
- Integration tests created

### Completion Notes

**Implementation Summary:**

All 7 tasks completed successfully. The default image settings feature provides a fallback mechanism for the image matching algorithm:

1. **Settings Page Updates** (includes/Admin/SettingsPage.php):
   - Added `IMAGE_OPTION_NAME` constant: 'seo_generator_image_settings'
   - Added `IMAGE_OPTION_GROUP` constant: 'seo_generator_image_options'
   - Added `getImageOptionGroup()` static method for template access
   - Registered new settings group for image settings (separate from main settings)
   - Added default image picker field to Image Library section
   - Field includes hidden input, "Select" button, "Remove" button, and image preview
   - Added `renderDefaultImageField()` method with preview display
   - Added `sanitizeImageSettings()` method with validation:
     - Validates attachment ID exists (post_status = 'inherit')
     - Validates attachment is actually an image (mime type check)
     - Handles null/empty values gracefully
     - Shows admin error notices for invalid selections
   - Enqueued wp.enqueue_media() for WordPress Media Library integration
   - Updated JavaScript dependencies to include 'media-upload' and 'media-views'

2. **Settings Template Updates** (templates/admin/settings.php):
   - Added settings_fields() call for image option group on 'images' tab
   - Removed "Coming Soon" notice from Image Library tab (now has real functionality)
   - Both option groups submitted together on form save

3. **JavaScript Implementation** (assets/js/settings.js):
   - Added `initDefaultImagePicker()` function
   - Creates wp.media frame with title "Select Default Hero Image"
   - Filters library to show only images (library: { type: 'image' })
   - On selection: updates hidden input, displays preview, shows remove button
   - On remove: clears input, clears preview, hides remove button
   - Uses medium size for preview (300px max-width)
   - Handles frame reuse (opens existing frame if already created)

4. **ImageMatchingService Updates** (includes/Services/ImageMatchingService.php):
   - Enhanced `getDefaultImage()` method with attachment validation
   - Verifies attachment still exists before returning (prevents deleted image issues)
   - Already reads from correct option: 'seo_generator_image_settings'
   - Already uses default in final fallback (no changes needed to main logic)
   - Already logs when default image used

5. **Integration Tests** (tests/php/Integration/DefaultImageSettingsTest.php - 270+ lines):
   - 9 test methods covering all scenarios:
     1. `test_default_image_setting_saves()` - Option storage
     2. `test_image_matching_service_retrieves_default()` - Service integration
     3. `test_null_default_handled_gracefully()` - Null case
     4. `test_invalid_attachment_id_handled_gracefully()` - Invalid ID
     5. `test_default_used_when_no_matches()` - Fallback behavior
     6. `test_tag_match_preferred_over_default()` - Priority order
     7. `test_clearing_default_image()` - Clearing functionality
     8. `test_empty_context_uses_default()` - Empty context
     9. `test_settings_sanitization_validates_attachment()` - Sanitization logic
   - Tests both settings storage and ImageMatchingService integration
   - Creates test images with and without tags
   - Cleans up properly in tearDown()

**Key Technical Decisions:**

- **Separate Settings Option**: Default image stored in `seo_generator_image_settings` (separate from main settings). This allows for future expansion of image-related settings without cluttering the main settings array.
- **Separate Option Group**: Uses distinct WordPress settings API group for proper form handling. Both groups register on images tab for single form submission.
- **Validation on Save**: Sanitization validates attachment exists and is an image type (prevents saving invalid IDs).
- **Validation on Retrieval**: ImageMatchingService double-checks attachment exists before using (handles case where image deleted after setting saved).
- **wp.media Integration**: Standard WordPress media library picker provides familiar UX consistent with other WordPress interfaces.
- **Preview Display**: Shows medium-sized preview (300px) so admin can confirm selection without opening full media library again.
- **Graceful Degradation**: If default image not set, deleted, or invalid, algorithm returns null (allows manual image selection in UI).

**Settings Page Flow:**

```php
// User visits Settings > Image Library tab
1. Template outputs settings_fields() for BOTH option groups
2. renderDefaultImageField() displays current default (if set)
3. User clicks "Select Default Image"
4. JavaScript opens wp.media frame
5. User selects image
6. JavaScript updates hidden input + preview
7. User saves form (submits both seo_generator_settings and seo_generator_image_settings)
8. sanitizeImageSettings() validates attachment
9. Option saved to database
```

**Matching Algorithm Flow with Default:**

```php
// During content generation
1. ImageMatchingService->findMatchingImage(['focus_keyword' => 'diamond ring'])
   ↓
2. extractKeywords() → ['diamond', 'ring']
   ↓
3. Attempt 1: Query images with tags [diamond, ring] (AND) → No matches
   ↓
4. Attempt 2: Query images with tags [diamond] → No matches
   ↓
5. Attempt 3: Query images with tags [ring] → No matches
   ↓
6. getDefaultImage()
   ↓
7. Read 'seo_generator_image_settings' option
   ↓
8. Verify attachment still exists (post_status check)
   ↓
9. Return default image ID 789
   ↓
10. Log: "[Image Matching] Tags: diamond, ring | Attempt: 4 | Found: 1 | Selected: 789 | Using default image"
```

**Integration with Story 5.5:**

- Story 5.5 integrated ImageMatchingService with ContentGenerationService
- Story 5.6 enhances that integration by providing fallback when matching fails
- Auto-assignment now guaranteed to assign an image (if default configured)
- If default not configured, auto-assignment gracefully skips (no error)

**Known Limitations:**

- Default applies to ALL content types (no per-block-type defaults)
- Only one default image (no fallback chain)
- Cannot set default per category or topic
- Requires manual upload/selection (no auto-suggest based on library)

**Future Enhancements (Not in MVP):**

- Multiple default images (random selection)
- Per-block-type defaults (hero_default, process_default, etc.)
- Per-category defaults
- Auto-suggest most-used library image as default
- Preview popular library images in settings for quick selection

**Validation Steps:**

To validate the implementation:
1. Go to Settings > SEO Generator > Image Library tab
2. Verify "Default Hero Image" field is present
3. Click "Select Default Image" button
4. Verify WordPress Media Library opens
5. Select an image
6. Verify preview appears below button
7. Verify "Remove" button appears
8. Save settings
9. Go to Image Library Manager
10. Delete all images with specific tags
11. Generate content with those keywords
12. Verify default image assigned to hero_image field
13. Check debug.log for: "Using default image"
14. Click "Remove" button in settings
15. Save settings
16. Generate content again
17. Verify hero_image field left empty (no error)
18. Run tests: `vendor/bin/phpunit tests/php/Integration/DefaultImageSettingsTest.php`

### File List

**Created:**
- `docs/stories/5.6.create-default-image-settings.md` (this file)
- `tests/php/Integration/DefaultImageSettingsTest.php` (270+ lines, 9 tests)

**Modified:**
- `includes/Admin/SettingsPage.php` (added IMAGE_OPTION_NAME, IMAGE_OPTION_GROUP, renderDefaultImageField, sanitizeImageSettings, getImageOptionGroup, updated enqueueAssets)
- `includes/Services/ImageMatchingService.php` (enhanced getDefaultImage with validation)
- `templates/admin/settings.php` (added image option group registration, removed "Coming Soon" notice)
- `assets/js/settings.js` (added initDefaultImagePicker function with wp.media integration)

## QA Results

*This section will be populated by QA Agent after story completion*
