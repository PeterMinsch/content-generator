# Story 6.7: Import History and Logging

**Status:** Draft

---

## Story

**As a** site administrator,
**I want** to see history of past imports,
**so that** I can track what was imported and troubleshoot issues

---

## Acceptance Criteria

1. Import history table on Import page shows:
   - Import date/time
   - Filename
   - Total rows
   - Success count
   - Error count
   - User who imported
   - View details link
2. Details view shows:
   - Full import log
   - List of created post IDs and titles
   - List of errors encountered
   - Download error log as .txt file
3. Import data stored in custom table or post meta
4. History paginated (10 imports per page)
5. Old import records (90+ days) auto-deleted

---

## Tasks / Subtasks

- [ ] **Task 1: Create Import Log Data Storage** (AC: 3)
  - [ ] Determine storage approach (Option 1: `wp_options` serialized array for simple/low-volume, or Option 2: Custom table `wp_seo_import_log` for scalable/high-volume)
  - [ ] If using custom table, create database migration script with schema
  - [ ] Define log structure: `{timestamp, filename, total, success, errors, user_id, error_log}`
  - [ ] Create data model class or repository pattern for import log access [Source: architecture.md#Repository Pattern]
  - [ ] Implement methods: `saveImportLog()`, `getImportLogs()`, `getImportLogById()`, `deleteOldImportLogs()`

- [ ] **Task 2: Build Import History Table UI** (AC: 1, 4)
  - [ ] Create admin template file: `templates/admin/import-history-table.php`
  - [ ] Display import history table with columns: Date/Time, Filename, Total Rows, Success Count, Error Count, User, View Details
  - [ ] Implement pagination (10 imports per page) using WordPress pagination helpers
  - [ ] Add "View Details" link for each import record
  - [ ] Style table to match WordPress admin UI using WordPress admin styles [Source: architecture.md#CSS Framework]

- [ ] **Task 3: Create Import Details View** (AC: 2)
  - [ ] Create detail view template: `templates/admin/import-details.php`
  - [ ] Display full import log with timestamp, filename, user info
  - [ ] Show list of created post IDs with titles (link to edit post screen)
  - [ ] Display list of errors encountered during import
  - [ ] Implement "Download Error Log as .txt" functionality
  - [ ] Add "Back to History" navigation link

- [ ] **Task 4: Integrate Logging into Import Process** (AC: 3)
  - [ ] Update `ImportService.php` to log import start, progress, and completion
  - [ ] Capture import metadata: timestamp, filename, total rows, user ID
  - [ ] Track success count and error count during batch processing
  - [ ] Store error messages for failed rows in error_log field
  - [ ] Save complete import log after import finishes
  - [ ] Ensure logging doesn't significantly impact import performance

- [ ] **Task 5: Implement Auto-Cleanup of Old Import Records** (AC: 5)
  - [ ] Create WP Cron daily job: `seo_cleanup_old_import_logs`
  - [ ] Schedule cron job on plugin activation using `wp_schedule_event('daily', ...)`
  - [ ] Implement cleanup function to delete import logs older than 90 days
  - [ ] Add filter hook to allow customization of retention period: `apply_filters('seo_import_log_retention_days', 90)`
  - [ ] Log cleanup activity to WordPress debug log

- [ ] **Task 6: Add Import History to Import Page** (AC: 1)
  - [ ] Integrate import history table into existing Import page (`includes/Admin/ImportPage.php`)
  - [ ] Display history table below main import interface
  - [ ] Add section heading: "Import History"
  - [ ] Ensure proper spacing and layout within Import page

- [ ] **Task 7: Testing** (AC: All)
  - [ ] Write unit tests for ImportLog repository/model methods
  - [ ] Write unit tests for log storage and retrieval
  - [ ] Write integration tests for import logging workflow
  - [ ] Test pagination with > 10 import records
  - [ ] Test details view with various import scenarios (all success, partial errors, all errors)
  - [ ] Test error log .txt download functionality
  - [ ] Test auto-cleanup cron job (manually trigger with `wp_cron()`)
  - [ ] Verify old records (90+ days) are deleted correctly
  - [ ] Test with both storage options if supporting both

---

## Dev Notes

### Previous Story Insights
No specific information from previous stories available at this time. This is the final story in Epic 6 (CSV Import & Bulk Processing).

### Data Models

**Import Log Structure:**
```
{
  timestamp: DateTime,
  filename: string,
  total: int,
  success: int,
  errors: int,
  user_id: int,
  error_log: array of error strings
}
```

**Storage Options:**

**Option 1: wp_options (Simple, Low Volume)**
- Store as serialized array in `wp_options` table
- Key: `seo_import_history`
- Good for: < 100 imports total
- Pros: Simple, no schema changes
- Cons: Not scalable for high volume

**Option 2: Custom Table (Scalable, High Volume)**
- Create custom table: `wp_seo_import_log`
- Columns: id, timestamp, filename, total, success, errors, user_id, error_log (TEXT)
- Good for: Production use with many imports
- Pros: Scalable, efficient queries, indexable
- Cons: Requires database migration

[Source: epic-6-csv-import.md#Story 6.7 Technical Requirements]

### Plugin Architecture & Patterns

**Repository Pattern:**
The plugin uses a Repository Pattern for data access abstraction [Source: architecture.md#Architectural Patterns]. Create a repository class for import log access:

```php
class ImportLogRepository {
  public function save($logData): int
  public function findAll($limit, $offset): array
  public function findById($id): array|null
  public function deleteOlderThan($days): int
}
```

**MVC-Inspired Separation:**
- Controller: `ImportPage.php` handles routing and view rendering
- Service: `ImportService.php` handles import business logic and logging
- Repository: `ImportLogRepository.php` handles data persistence
- View: Templates in `templates/admin/` handle presentation

[Source: architecture.md#Architectural Patterns, architecture.md#Plugin Architecture]

### File Locations

Based on Unified Project Structure [Source: architecture.md#Unified Project Structure]:

**PHP Classes:**
- Repository: `includes/Repositories/ImportLogRepository.php`
- Update Service: `includes/Services/ImportService.php` (add logging)
- Admin Controller: `includes/Admin/ImportPage.php` (integrate history UI)

**Templates:**
- History Table: `templates/admin/import-history-table.php`
- Details View: `templates/admin/import-details.php`

**Database Migration (if using custom table):**
- Create migration in plugin activation hook within `includes/Plugin.php`

### API Specifications

No REST API endpoints required for this story. This is purely admin UI functionality.

### Component Specifications

**Admin UI Components:**
This story extends the existing Import admin page with additional UI components for history display. The Import page is already defined in the architecture [Source: architecture.md#Components - Backend Components (PHP)].

**History Table Component:**
- Displays paginated list of import logs
- Uses WordPress admin table styling (`.widefat` class)
- Pagination uses WordPress functions: `paginate_links()`

**Details View Component:**
- Full-page view showing single import details
- Download button for error log export
- Uses WordPress admin styling

### Testing Requirements

**Testing Strategy:**
The plugin uses PHPUnit 9.x for backend testing [Source: architecture.md#Tech Stack - Backend Testing].

**Test File Location:**
- Unit Tests: `tests/php/Repositories/ImportLogRepositoryTest.php`
- Unit Tests: `tests/php/Services/ImportServiceTest.php` (update existing)
- Integration Tests: `tests/php/Integration/ImportLoggingTest.php`

**Test Standards:**
- Follow PHPUnit best practices
- Use WordPress test framework for integration tests
- Mock external dependencies (database for unit tests)
- Test both success and failure scenarios
- Test edge cases (empty logs, missing data, old records)

[Source: architecture.md#Tech Stack - Backend Testing]

### Technical Constraints

**WordPress Cron Limitations:**
WordPress Cron is not real cron - it runs when site receives traffic. For production use, recommend setting up server cron to trigger `wp-cron.php`. Document this limitation in code comments and user documentation.

**Background Job Queue Pattern:**
The plugin uses WordPress Cron for background processing [Source: architecture.md#Architectural Patterns - Background Job Queue]. The cleanup job follows this pattern.

**Coding Standards:**
Follow WordPress Coding Standards enforced by PHP_CodeSniffer + WPCS [Source: architecture.md#Tech Stack - Code Quality (PHP)].

### Database Schema (if using Custom Table)

**Custom Table: wp_seo_import_log**

```sql
CREATE TABLE {prefix}_seo_import_log (
    id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
    timestamp DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    filename VARCHAR(255) NOT NULL,
    total_rows INT UNSIGNED NOT NULL DEFAULT 0,
    success_count INT UNSIGNED NOT NULL DEFAULT 0,
    error_count INT UNSIGNED NOT NULL DEFAULT 0,
    user_id BIGINT(20) UNSIGNED NOT NULL,
    error_log TEXT NULL,

    PRIMARY KEY (id),
    INDEX idx_timestamp (timestamp),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

Similar to the generation log custom table pattern [Source: architecture.md#Database Schema - Custom Table].

### WordPress Coding Patterns

**Cron Job Registration:**
```php
// On plugin activation
wp_schedule_event(time(), 'daily', 'seo_cleanup_old_import_logs');

// Hook callback
add_action('seo_cleanup_old_import_logs', 'seo_cleanup_old_import_logs_callback');
```

**Pagination Helper:**
```php
$paged = isset($_GET['paged']) ? absint($_GET['paged']) : 1;
$per_page = 10;
$offset = ($paged - 1) * $per_page;

// After getting total count
$total_pages = ceil($total_count / $per_page);
echo paginate_links([
    'base' => add_query_arg('paged', '%#%'),
    'format' => '',
    'current' => $paged,
    'total' => $total_pages,
]);
```

**Nonce Security:**
All admin forms must use WordPress nonces for security [Source: architecture.md#API Specification - Authentication].

### Project Structure Notes

The plugin follows WordPress Plugin Architecture with standard structure [Source: architecture.md#High Level Architecture - Repository Structure]. All new files should follow the established patterns in `includes/` for PHP classes and `templates/admin/` for admin view templates.

---

## Testing

### Testing Standards
- **Framework:** PHPUnit 9.x for PHP unit and integration tests
- **Test Location:**
  - Unit tests: `tests/php/Repositories/ImportLogRepositoryTest.php`
  - Service tests: `tests/php/Services/ImportServiceTest.php`
  - Integration tests: `tests/php/Integration/ImportLoggingTest.php`
- **Standards:** Follow WordPress test framework patterns with mocking for unit tests
- **Coverage:** Test success scenarios, error handling, pagination, and cleanup functionality

[Source: architecture.md#Tech Stack - Backend Testing, architecture.md#Testing Strategy]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after testing*
