# Story 7.5: Optimize Performance and Benchmarking

## Status

Draft

## Story

**As a** site administrator,
**I want** the plugin to perform efficiently,
**so that** generation is fast and doesn't slow down my site

## Acceptance Criteria

1. Performance benchmarks meet PRD targets:
   - ✓ Full page generation (12 blocks): under 5 minutes
   - ✓ Average cost per page: under $3
   - ✓ Page load time (frontend): under 3 seconds
   - ✓ Admin UI loads in under 2 seconds
   - ✓ No N+1 query problems (checked with Query Monitor)
2. Optimizations implemented:
   - Caching: prompt templates (1 hour), settings (1 hour)
   - Database: indexes on generation_log table
   - Assets: minified CSS/JS in production
   - Images: lazy loading on frontend
   - API: efficient prompts to reduce token usage
3. Benchmarking tests documented:
   - Test environment specs
   - Test data (page types, number of blocks)
   - Results for each metric
   - Comparison to PRD targets
4. Performance regression tests in CI

## Tasks / Subtasks

- [ ] Task 1: Benchmark current performance (AC: 1, 3)
  - [ ] Set up benchmarking environment with consistent specs
  - [ ] Create test dataset (5 pages with different topics)
  - [ ] Measure full page generation time (12 blocks)
  - [ ] Measure individual block generation times
  - [ ] Record token usage and calculate cost per page
  - [ ] Measure frontend page load time with GTmetrix/PageSpeed
  - [ ] Measure admin UI load time
  - [ ] Install Query Monitor and check for N+1 queries
  - [ ] Document baseline metrics in docs/performance-benchmarks.md

- [ ] Task 2: Implement caching layer (AC: 2)
  - [ ] Add prompt template caching with wp_cache_set/get (1 hour TTL)
  - [ ] Cache settings values with transients (1 hour TTL)
  - [ ] Cache ACF field configurations (invalidate on save)
  - [ ] Add cache warming for frequently accessed data
  - [ ] Implement cache key versioning for invalidation
  - [ ] Test cache hit/miss rates
  - [ ] Document caching strategy

- [ ] Task 3: Database optimization (AC: 2)
  - [ ] Verify indexes on generation_log table (post_id, created_at, cost_tracking)
  - [ ] Add composite index for analytics queries
  - [ ] Optimize slow queries identified by Query Monitor
  - [ ] Implement query result caching for analytics
  - [ ] Set up automated old log cleanup (30+ days via cron)
  - [ ] Test database performance under load
  - [ ] Document index strategy

- [ ] Task 4: Asset optimization (AC: 2)
  - [ ] Configure webpack production mode for minification
  - [ ] Enable code splitting for large React components
  - [ ] Implement tree shaking to remove unused code
  - [ ] Optimize image assets (compress, use appropriate formats)
  - [ ] Add asset versioning for cache busting
  - [ ] Test minified assets in staging
  - [ ] Verify no console errors with production build

- [ ] Task 5: Frontend performance optimization (AC: 1, 2)
  - [ ] Implement lazy loading for images (loading="lazy")
  - [ ] Add responsive image srcset attributes
  - [ ] Optimize CSS delivery (critical CSS inline)
  - [ ] Defer non-critical JavaScript
  - [ ] Test frontend with PageSpeed Insights
  - [ ] Ensure Core Web Vitals pass (LCP, FID, CLS)
  - [ ] Document frontend optimization techniques

- [ ] Task 6: API prompt optimization (AC: 1, 2)
  - [ ] Review all prompt templates for token efficiency
  - [ ] Remove redundant instructions from prompts
  - [ ] Test shorter prompts vs. quality trade-offs
  - [ ] Optimize system messages for reuse
  - [ ] Reduce max_tokens where appropriate
  - [ ] Measure token reduction percentage
  - [ ] Document prompt optimization guidelines

- [ ] Task 7: Admin UI performance (AC: 1)
  - [ ] Implement React.memo for expensive components
  - [ ] Add useMemo/useCallback for computed values
  - [ ] Optimize re-renders with proper dependency arrays
  - [ ] Implement virtual scrolling for long lists
  - [ ] Test UI responsiveness with Chrome DevTools
  - [ ] Measure and optimize bundle size
  - [ ] Document React optimization patterns used

- [ ] Task 8: N+1 query elimination (AC: 1)
  - [ ] Identify N+1 queries with Query Monitor
  - [ ] Implement eager loading where needed
  - [ ] Use get_posts() with proper query args
  - [ ] Batch ACF field retrieval
  - [ ] Optimize taxonomy term queries
  - [ ] Verify fixes with Query Monitor
  - [ ] Document query optimization patterns

- [ ] Task 9: Run final benchmarks and verify targets (AC: 1, 3)
  - [ ] Re-run all benchmark tests
  - [ ] Compare against baseline metrics
  - [ ] Verify all PRD targets met (<5min, <$3, <3s, <2s, no N+1)
  - [ ] Test with different page types and content volumes
  - [ ] Measure improvement percentages
  - [ ] Create performance report with before/after
  - [ ] Document final benchmark results

- [ ] Task 10: Performance regression tests (AC: 4)
  - [ ] Create PHPUnit performance tests with time assertions
  - [ ] Add test for generation time threshold
  - [ ] Add test for query count limits
  - [ ] Set up CI to run performance tests
  - [ ] Configure alerts for performance degradation
  - [ ] Document performance testing approach
  - [ ] Add performance tests to CI pipeline

## Dev Notes

### Performance Targets from PRD

**Generation Performance:**
- Full page (12 blocks): < 5 minutes
- 95%+ block success rate
- Average cost: < $3 per page
[Source: PRD prd.md#success-metrics]

**Frontend Performance:**
- Page load time: < 3 seconds
- Admin UI load: < 2 seconds
- No N+1 query problems
[Source: Epic epic-7-testing-polish.md#story-7.5]

### Caching Strategy from Architecture

**WordPress Caching:**
```php
// Prompt template caching
$cache_key = 'seo_gen_prompt_' . $block_type;
$cached = wp_cache_get($cache_key, 'seo-generator');
if (false === $cached) {
    $cached = $this->loadPromptTemplate($block_type);
    wp_cache_set($cache_key, $cached, 'seo-generator', HOUR_IN_SECONDS);
}

// Settings caching with transients
$settings = get_transient('seo_gen_settings');
if (false === $settings) {
    $settings = $this->loadSettings();
    set_transient('seo_gen_settings', $settings, HOUR_IN_SECONDS);
}

// ACF field cache (indefinite until save)
$fields = wp_cache_get('seo_gen_acf_fields', 'seo-generator');
```
[Source: PRD prd.md#caching-strategy]

### Database Optimization

**Required Indexes:**
```sql
-- generation_log table indexes
INDEX idx_post_id (post_id)
INDEX idx_created_at (created_at)
INDEX idx_cost_tracking (created_at, cost)
INDEX idx_user_id (user_id)

-- Composite index for analytics queries
INDEX idx_analytics (user_id, created_at, status)
```
[Source: Architecture architecture.md#database-schema]

**Cleanup Cron:**
```php
// Daily cron to delete logs older than 30 days
add_action('seo_gen_daily_cleanup', function() {
    global $wpdb;
    $table = $wpdb->prefix . 'seo_generation_log';
    $wpdb->query($wpdb->prepare(
        "DELETE FROM {$table} WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)"
    ));
});
```
[Source: PRD prd.md#database-optimization]

### Asset Loading from Architecture

**Webpack Configuration:**
```javascript
// Production mode enables minification
mode: 'production',
optimization: {
  minimize: true,
  splitChunks: {
    chunks: 'all',
    cacheGroups: {
      vendor: {
        test: /[\\/]node_modules[\\/]/,
        name: 'vendors',
        priority: 10
      }
    }
  }
}
```
[Source: Architecture architecture.md#asset-loading]

**Conditional Loading:**
```php
// Only load admin assets on plugin pages
add_action('admin_enqueue_scripts', function($hook) {
    if (strpos($hook, 'seo-generator') === false) {
        return;
    }
    wp_enqueue_script('seo-gen-admin', plugins_url('assets/js/build/admin.js'));
});
```
[Source: PRD prd.md#asset-loading]

### Query Monitor Usage

**Installation:**
```bash
wp plugin install query-monitor --activate
```

**What to Check:**
- Database queries (look for duplicates, N+1 patterns)
- Total query time
- Slow queries (> 0.05s)
- HTTP requests
- PHP errors
- Hooks fired
[Source: Epic epic-7-testing-polish.md#technical-requirements]

### Token Optimization Strategies

**Efficient Prompting:**
- Remove redundant context
- Use concise system messages
- Avoid repeating instructions
- Set appropriate max_tokens per block type
- Reuse system message across blocks

**Target Reductions:**
- Hero block: ~200 tokens → ~150 tokens
- SERP Answer: ~300 tokens → ~225 tokens
- Materials: ~400 tokens → ~300 tokens
[Source: PRD prd.md#openai-integration]

### Testing

**Performance Benchmarking Tools:**
- WordPress Query Monitor plugin
- Chrome DevTools Performance tab
- GTmetrix or PageSpeed Insights for frontend
- Custom timing with microtime() in PHP
- React DevTools Profiler

**Test Environment Specs to Document:**
- Server: PHP version, memory limit, CPU cores
- WordPress: version, active plugins, theme
- Database: MySQL/MariaDB version, table sizes
- Network: connection speed for API calls
[Source: Epic epic-7-testing-polish.md#story-7.5]

**Benchmark Test Cases:**
1. Fresh page with all 12 blocks (worst case)
2. Page with 6 blocks (typical case)
3. Single block regeneration (best case)
4. Bulk generate 5 pages (stress test)
5. Concurrent generation (3 users)

**Performance Assertions:**
```php
// PHPUnit performance test example
public function test_full_page_generation_under_5_minutes() {
    $start = microtime(true);
    $result = $this->generationService->generateAllBlocks($post_id);
    $duration = microtime(true) - $start;

    $this->assertLessThan(300, $duration, 'Generation took longer than 5 minutes');
    $this->assertTrue($result->isSuccess());
}
```
[Source: Architecture architecture.md#testing-strategy]

### Cost Tracking Verification

**Cost Calculation:**
```php
// GPT-4 Turbo pricing
$promptCost = ($tokens['prompt'] / 1000) * 0.01;
$completionCost = ($tokens['completion'] / 1000) * 0.03;
$totalCost = $promptCost + $completionCost;
```

**Verify Average < $3:**
- Query generation logs for last 30 days
- Calculate average cost per page
- Group by page type to identify expensive patterns
[Source: PRD prd.md#cost-tracking]

### Relevant File Locations

**Performance-Related Files:**
- `includes/Services/CacheService.php` - Caching implementation
- `includes/Services/ContentGenerationService.php` - Generation logic
- `includes/Repositories/GenerationLogRepository.php` - Database queries
- `webpack.config.js` - Asset build configuration
- `assets/css/admin.css` - Admin styles
- `assets/js/src/` - React components
- `templates/frontend/blocks/` - Frontend block templates
[Source: Architecture architecture.md#unified-project-structure]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by QA Agent after story completion*
