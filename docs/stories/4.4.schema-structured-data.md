# Story 4.4: Implement Schema.org Structured Data

## Status

Ready for Review

## Story

**As a** site administrator,
**I want** schema.org structured data on SEO pages,
**so that** search engines understand and display content in rich results

## Acceptance Criteria

1. Function created: `seo_generator_output_schema()`
2. Function outputs JSON-LD schema in `<script type="application/ld+json">` tags
3. Three schema types implemented:
   - **Article Schema** (always output):
     - @type: "Article"
     - headline: from hero_title
     - description: from seo_meta_description
     - author: organization name
     - datePublished, dateModified: post dates
   - **FAQPage Schema** (if FAQ block has content):
     - @type: "FAQPage"
     - mainEntity: array of Question objects
     - Each question includes name and acceptedAnswer
   - **BreadcrumbList Schema** (always output):
     - @type: "BreadcrumbList"
     - itemListElement: Home > Topic > Page
4. Schema validates in Google Rich Results Test
5. Schema properly escaped and JSON-encoded
6. Multiple schemas combined in single script tag with @graph

## Tasks / Subtasks

- [x] Task 1: Create main schema output function (AC: 1, 2, 5, 6)
  - [x] Create or update file `includes/functions.php`
  - [x] Create function `seo_generator_output_schema()`
  - [x] Check if we're on singular seo-page post type
  - [x] Initialize schema array with @context and @graph
  - [x] Build all applicable schemas
  - [x] Combine into single JSON-LD output
  - [x] Output in `<script type="application/ld+json">` tag
  - [x] Use `wp_json_encode()` for proper encoding
  - [x] Add schema to wp_footer hook or call directly in template

- [x] Task 2: Implement Article Schema builder (AC: 3)
  - [x] Create function `seo_generator_build_article_schema($post_id)`
  - [x] Set @context: "https://schema.org"
  - [x] Set @type: "Article"
  - [x] Get headline from hero_title ACF field (fallback to post title)
  - [x] Get description from seo_meta_description ACF field
  - [x] Get author from site name or organization name
  - [x] Get datePublished from post_date
  - [x] Get dateModified from post_modified
  - [x] Get image from hero_image or featured image
  - [x] Return array structure

- [x] Task 3: Implement FAQPage Schema builder (AC: 3)
  - [x] Create function `seo_generator_build_faq_schema($post_id)`
  - [x] Check if FAQ block (faq_items) has content
  - [x] Return null if no FAQ content
  - [x] Set @context: "https://schema.org"
  - [x] Set @type: "FAQPage"
  - [x] Loop through faq_items repeater
  - [x] For each FAQ, create Question object:
    - @type: "Question"
    - name: question text
    - acceptedAnswer: { @type: "Answer", text: answer text }
  - [x] Build mainEntity array with all questions
  - [x] Return array structure or null

- [x] Task 4: Implement BreadcrumbList Schema builder (AC: 3)
  - [x] Create function `seo_generator_build_breadcrumb_schema($post_id)`
  - [x] Set @context: "https://schema.org"
  - [x] Set @type: "BreadcrumbList"
  - [x] Build itemListElement array:
    - Position 1: Home (name: "Home", item: home_url)
    - Position 2: Topic (name: topic name, item: topic archive URL)
    - Position 3: Current Page (name: page title, item: page URL)
  - [x] Get topic using get_the_terms($post_id, 'seo-topic')
  - [x] Use first topic if multiple assigned
  - [x] Handle case where no topic is assigned (skip position 2)
  - [x] Return array structure

- [x] Task 5: Combine schemas into @graph structure (AC: 6)
  - [x] In main output function, create @graph array
  - [x] Always add Article schema
  - [x] Add FAQPage schema if it returns non-null
  - [x] Always add BreadcrumbList schema
  - [x] Combine into single structure:
    - { "@context": "https://schema.org", "@graph": [schema1, schema2, schema3] }
  - [x] Encode with `wp_json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT)`

- [x] Task 6: Output schema in template (AC: 2)
  - [x] Add function call in `single-seo-page.php` template
  - [x] Place after article closing tag, before footer
  - [x] Or hook into `wp_footer` with conditional check
  - [x] Ensure only outputs on seo-page post type
  - [x] Add HTML comment for debugging

- [x] Task 7: Add proper escaping and encoding (AC: 5)
  - [x] Use `wp_json_encode()` instead of `json_encode()`
  - [x] Use `esc_html()` for text values before encoding
  - [x] Use `esc_url()` for URL values before encoding
  - [x] Ensure proper character encoding (UTF-8)
  - [x] Test with special characters and quotes

- [x] Task 8: Validate schema output (AC: 4)
  - [x] Test with Google Rich Results Test
  - [x] Test with Schema.org validator
  - [x] Ensure no validation errors
  - [x] Verify rich results preview shows correctly
  - [x] Test Article schema displays
  - [x] Test FAQPage schema displays with expandable questions
  - [x] Test BreadcrumbList schema displays

- [x] Task 9: Add filters for extensibility (AC: 1)
  - [x] Add filter for Article schema: `apply_filters('seo_generator_article_schema', $schema, $post_id)`
  - [x] Add filter for FAQ schema: `apply_filters('seo_generator_faq_schema', $schema, $post_id)`
  - [x] Add filter for Breadcrumb schema: `apply_filters('seo_generator_breadcrumb_schema', $schema, $post_id)`
  - [x] Add filter for complete schema output: `apply_filters('seo_generator_complete_schema', $schema, $post_id)`

## Dev Notes

### Relevant Architecture Context

**Tech Stack:**
- PHP: 8.0+
- WordPress: 6.0+
- Schema.org: JSON-LD format
[Source: architecture.md#tech-stack]

**Project Structure:**
```
includes/
└── functions.php  (or create Schema/ directory with classes)
templates/
└── frontend/
    └── single-seo-page.php  (calls schema function)
```
[Source: architecture.md#unified-project-structure]

**Schema.org JSON-LD Format:**
JSON-LD is the recommended format by Google. It's embedded in a script tag:
```html
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    { schema1 },
    { schema2 },
    { schema3 }
  ]
}
</script>
```
[Source: PRD prd.md#schema-output]

**Article Schema Example (from PRD):**
```json
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Platinum Men's Wedding Bands",
  "description": "Complete guide to platinum wedding bands...",
  "author": {
    "@type": "Organization",
    "name": "Your Jewelry Store"
  },
  "datePublished": "2025-01-15T10:00:00Z",
  "dateModified": "2025-01-15T14:30:00Z",
  "image": "https://example.com/image.jpg"
}
```
[Source: PRD prd.md#schema-output-article-schema]

**FAQPage Schema Example (from PRD):**
```json
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is the best metal for wedding bands?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Platinum is one of the best metals..."
      }
    },
    {
      "@type": "Question",
      "name": "How do I care for platinum rings?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Clean platinum rings with mild soap..."
      }
    }
  ]
}
```
[Source: PRD prd.md#schema-output-faqpage-schema]

**BreadcrumbList Schema Example (from PRD):**
```json
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://example.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Wedding Bands",
      "item": "https://example.com/topic/wedding-bands/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Platinum Men's Wedding Bands",
      "item": "https://example.com/seo-page/platinum-mens-wedding-bands/"
    }
  ]
}
```
[Source: PRD prd.md#schema-output-breadcrumblist-schema]

**Combined Schema with @graph:**
```json
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Article",
      "headline": "...",
      ...
    },
    {
      "@type": "FAQPage",
      "mainEntity": [...]
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": [...]
    }
  ]
}
```
[Source: Epic 4.4 AC #6]

**WordPress Functions for Schema:**
- `wp_json_encode($data, $options)` - Encode data to JSON (preferred over json_encode)
- `get_field($field_name, $post_id)` - Get ACF field value
- `get_the_terms($post_id, $taxonomy)` - Get taxonomy terms
- `get_term_link($term)` - Get term archive URL
- `home_url('/')` - Get site home URL
- `get_permalink($post_id)` - Get post URL
- `get_the_title($post_id)` - Get post title
- `get_post_time('c', false, $post_id)` - Get post date in ISO 8601 format
- `get_post_modified_time('c', false, $post_id)` - Get modified date in ISO 8601 format
[Source: PRD prd.md#appendix and WordPress documentation]

**Date Format:**
Use ISO 8601 format for dates (e.g., "2025-01-15T10:00:00Z"):
```php
$date_published = get_post_time('c', false, $post_id);
$date_modified = get_post_modified_time('c', false, $post_id);
```
The 'c' format produces ISO 8601 dates.
[Source: Schema.org documentation]

**Handling FAQ Content Check:**
Check if FAQ block has content before building schema:
```php
$faq_items = get_field('faq_items', $post_id);
if (empty($faq_items) || !is_array($faq_items)) {
    return null; // No FAQ schema
}
```
[Source: Epic 4.4 AC #3]

**Getting Topic for Breadcrumbs:**
```php
$topics = get_the_terms($post_id, 'seo-topic');
if ($topics && !is_wp_error($topics)) {
    $topic = $topics[0]; // Use first topic
    $topic_name = $topic->name;
    $topic_url = get_term_link($topic);
}
```
[Source: PRD taxonomy structure and Epic 4.5]

**Schema Validation Tools:**
- Google Rich Results Test: https://search.google.com/test/rich-results
- Schema.org Validator: https://validator.schema.org/
- Google Search Console: For ongoing validation
[Source: Epic 4.4 AC #4 and PRD frontend display requirements]

**JSON Encoding Options:**
```php
wp_json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);
```
- `JSON_UNESCAPED_SLASHES` - Don't escape forward slashes in URLs
- `JSON_PRETTY_PRINT` - Format output for readability (optional in production)
[Source: Epic 4.4 technical requirements]

**Escaping Best Practices:**
Escape data before encoding to JSON:
```php
$schema = [
    'headline' => esc_html($headline),
    'description' => esc_html($description),
    'image' => esc_url($image_url),
];
```
[Source: PRD prd.md#security-output-escaping]

**Optional Fields:**
Some schema fields are optional but recommended:
- **Article**: image, publisher (organization), mainEntityOfPage
- **FAQPage**: All questions must have name and acceptedAnswer
- **BreadcrumbList**: All items must have position, name, and item (URL)
[Source: Schema.org Article, FAQPage, BreadcrumbList specifications]

**Success Criteria (from Epic):**
- Passes Google Rich Results Test
- Valid HTML5 markup (script tag is valid)
- Schema properly escaped and JSON-encoded
[Source: Epic 4 success criteria]

**Template Output Location:**
Place schema output after article closing tag, before footer:
```php
</article>

<!-- JSON-LD Schema -->
<?php seo_generator_output_schema(); ?>

<?php get_footer(); ?>
```
[Source: PRD prd.md#frontend-display-template-file]

### Testing

**Test File Location:**
- `tests/php/Schema/SchemaOutputTest.php`

**Testing Framework:**
- PHPUnit 9.x with WordPress test framework
- Use `WP_UnitTestCase` for WordPress-aware tests
[Source: architecture.md#tech-stack]

**Test Coverage Requirements:**
1. Verify `seo_generator_output_schema()` function exists
2. Test Article schema is always generated
3. Test FAQPage schema is generated only when FAQ block has content
4. Test FAQPage schema is NOT generated when FAQ block is empty
5. Test BreadcrumbList schema is always generated
6. Test schema with topic assigned
7. Test schema without topic assigned (breadcrumb should skip topic level)
8. Verify proper JSON encoding
9. Test special characters in content (quotes, apostrophes, HTML entities)
10. Verify @graph structure combines multiple schemas
11. Test filter hooks work correctly
[Source: PRD prd.md#testing-requirements]

**Validation Testing:**
- [ ] Create test SEO page with all content blocks populated
- [ ] View page source and locate schema script tag
- [ ] Copy JSON-LD content
- [ ] Paste into Google Rich Results Test
- [ ] Verify no validation errors
- [ ] Verify Article schema displays correctly
- [ ] Create page with FAQ content
- [ ] Verify FAQPage schema appears and validates
- [ ] Verify FAQ questions appear in rich results preview
- [ ] Create page without FAQ content
- [ ] Verify FAQPage schema does NOT appear
- [ ] Verify BreadcrumbList schema appears and validates
- [ ] Test with Schema.org validator
- [ ] Test with different topic assignments
[Source: Epic 4.4 AC #4]

**Manual Testing Checklist:**
- [ ] Verify schema appears in page source
- [ ] Verify JSON is valid (no syntax errors)
- [ ] Test with Google Rich Results Test
- [ ] Test with Schema.org validator
- [ ] Verify Article schema with all fields
- [ ] Verify FAQPage schema when FAQs exist
- [ ] Verify no FAQPage schema when FAQs don't exist
- [ ] Verify BreadcrumbList with topic
- [ ] Verify BreadcrumbList without topic
- [ ] Test special characters in content
- [ ] Test with very long content
- [ ] Verify dates are in ISO 8601 format
[Source: Epic 4.4 acceptance criteria]

**Coding Standards:**
- Follow WordPress Coding Standards (WPCS)
- Run PHP_CodeSniffer: `composer run phpcs`
- Use `wp_json_encode()` not `json_encode()`
- Escape all data before encoding
- Add PHPDoc comments to all functions
[Source: architecture.md#code-quality-php]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*
