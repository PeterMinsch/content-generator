# Story 3.6: Implement Form Validation and Character Counters

## Status

Draft

## Story

**As a** content manager,
**I want** real-time validation and character count feedback,
**so that** I know my content meets requirements before saving

## Acceptance Criteria

1. Character counters displayed on all fields with limits:
   - Shows "X / Y characters" below field
   - Updates in real-time as user types
   - Turns red when limit exceeded
2. Required field validation:
   - Page title required before generation
   - Focus keyword required for generation
   - Visual indicator (red border) on empty required fields
3. URL validation on URL fields:
   - Validates format is valid URL
   - Shows error message if invalid
4. Save button disabled when:
   - Required fields empty
   - Character limits exceeded
   - Validation errors present
5. Validation messages clear and actionable
6. Validation runs on blur and before save

## Tasks / Subtasks

- [ ] Task 1: Enhance CharacterCounter component (AC: 1)
  - [ ] Update `assets/js/src/components/common/CharacterCounter.js`
  - [ ] Accept props: current, max, showWarning (optional)
  - [ ] Add conditional styling classes based on current vs max
  - [ ] Show warning color (orange) when 90% of limit reached
  - [ ] Show error color (red) when limit exceeded
  - [ ] Display percentage in addition to count (optional)

- [ ] Task 2: Create validation utility functions (AC: 2, 3)
  - [ ] Create `assets/js/src/utils/validation.js`
  - [ ] Implement `validateRequired(value)` - checks if value is non-empty
  - [ ] Implement `validateCharacterLimit(value, max)` - checks length <= max
  - [ ] Implement `validateUrl(value)` - validates URL format using regex or URL constructor
  - [ ] Implement `validateEmail(value)` - if needed for future fields
  - [ ] Return validation result: `{ isValid: boolean, error: string | null }`

- [ ] Task 3: Create useValidation custom hook (AC: 2, 3, 6)
  - [ ] Create `assets/js/src/hooks/useValidation.js`
  - [ ] Accept props: rules (validation rules object), values (field values)
  - [ ] Implement validation logic that runs rules against values
  - [ ] Track validation errors in state: `{ fieldName: 'error message' }`
  - [ ] Provide `validate()` function to run all validations
  - [ ] Provide `validateField(fieldName)` for single field validation
  - [ ] Return: `{ errors, validate, validateField, isValid }`

- [ ] Task 4: Create FieldError component (AC: 5)
  - [ ] Create `assets/js/src/components/common/FieldError.js`
  - [ ] Accept props: error (string | null)
  - [ ] Display error message with error styling
  - [ ] Only render if error exists
  - [ ] Use WordPress Notice component or custom styled div
  - [ ] Add appropriate ARIA attributes for accessibility

- [ ] Task 5: Update BasicInfo to add required field validation (AC: 2)
  - [ ] Import useValidation hook
  - [ ] Define validation rules for Page Title (required)
  - [ ] Define validation rules for Focus Keyword (required)
  - [ ] Add red border CSS class when field has error
  - [ ] Display FieldError component below each required field
  - [ ] Run validateField on blur event
  - [ ] Run validate before allowing generation

- [ ] Task 6: Add character limit validation to text fields (AC: 1, 4)
  - [ ] Update all block components with character limits
  - [ ] Add validation rule: validateCharacterLimit(value, max)
  - [ ] Display CharacterCounter below each field with limit
  - [ ] Add error state to field when limit exceeded
  - [ ] Prevent save when any field exceeds limit

- [ ] Task 7: Add URL validation to URL fields (AC: 3, 5)
  - [ ] Identify URL fields: cta_primary_url, cta_secondary_url, alt_image_url, cert_link
  - [ ] Add validation rule: validateUrl(value)
  - [ ] Display FieldError when URL is invalid
  - [ ] Show validation on blur
  - [ ] Clear error when user corrects the URL

- [ ] Task 8: Create validation rules configuration (AC: 2, 3)
  - [ ] Create `assets/js/src/config/validationRules.js`
  - [ ] Define validation rules for all fields in centralized config
  - [ ] Structure: `{ fieldName: { required: boolean, maxLength: number, type: 'url' | 'text' } }`
  - [ ] Export rules for use in components

- [ ] Task 9: Integrate validation with Save functionality (AC: 4, 6)
  - [ ] Update GenerationControls or PageEditor
  - [ ] Add "Save Draft" button functionality
  - [ ] Import useValidation with all field rules
  - [ ] Run validate() before saving
  - [ ] Disable Save button when isValid is false
  - [ ] Show validation errors if save attempted with invalid data
  - [ ] Scroll to first error field if validation fails

- [ ] Task 10: Add visual indicators for validation states (AC: 2, 5)
  - [ ] Update `assets/css/admin-blocks.css`
  - [ ] Style required fields with asterisk (*)
  - [ ] Style invalid fields with red border
  - [ ] Style valid fields with green border (optional)
  - [ ] Style character counter warning (orange at 90%)
  - [ ] Style character counter error (red when exceeded)
  - [ ] Style error messages (red text, warning icon)

- [ ] Task 11: Implement real-time validation on change (AC: 1)
  - [ ] Add onChange validation for character counters
  - [ ] Update counter display as user types
  - [ ] Debounce validation checks (optional, for performance)
  - [ ] Don't show validation errors while typing (only on blur)

- [ ] Task 12: Add validation summary (AC: 4, 5)
  - [ ] Create ValidationSummary component
  - [ ] Display at top of page when validation fails
  - [ ] List all validation errors with field names
  - [ ] Provide links to scroll to error fields
  - [ ] Show on attempted save with errors

- [ ] Task 13: Prevent generation when required fields missing (AC: 2, 4)
  - [ ] Check required fields before allowing single block generation
  - [ ] Check required fields before bulk generation
  - [ ] Display alert or notice: "Please fill in Page Title and Focus Keyword"
  - [ ] Disable Generate All button when required fields empty

- [ ] Task 14: Add accessibility features for validation
  - [ ] Add aria-required="true" to required fields
  - [ ] Add aria-invalid="true" to invalid fields
  - [ ] Add aria-describedby linking field to error message
  - [ ] Announce validation errors to screen readers
  - [ ] Ensure keyboard navigation works with error states

## Dev Notes

### Relevant Architecture Context

**Tech Stack:**
- **Frontend Framework:** React 18.x with functional components and hooks
- **WordPress Components:** @wordpress/components for UI elements
- **Form Validation:** Custom validation with React hooks (no external library needed)
[Source: architecture.md#tech-stack]

**Character Limits (from PRD):**
Fields with character limits:
- hero_title: 100 chars
- hero_subtitle: 150 chars
- hero_summary: 400 chars
- answer_heading: 100 chars
- answer_paragraph: 600 chars
- answer_bullets.bullet_text: 150 chars each
- step_text: 400 chars
- comparison left_text/right_text: 200 chars each
- ethics_text: 800 chars
- faq answer: 600 chars
- seo_title: 65 chars
- seo_meta_description: 165 chars
[Source: PRD prd.md#content-structure]

**Required Fields:**
- Page Title (post_title) - Required before generation
- Focus Keyword (seo_focus_keyword) - Required for generation
[Source: epic-3-admin-ui.md#story-3.6-acceptance-criteria]

**URL Fields to Validate:**
- cta_primary_url
- cta_secondary_url
- alt_image_url (in Product Showcase block)
- cert_link (in Ethics block certifications repeater)
- seo_canonical
[Source: PRD prd.md#content-structure]

**Character Counter Enhanced Component:**
```javascript
const CharacterCounter = ({ current, max, showWarning = true }) => {
  const percentage = (current / max) * 100;
  const isWarning = showWarning && percentage >= 90 && percentage < 100;
  const isError = current > max;

  let className = 'char-counter';
  if (isError) className += ' char-counter-error';
  else if (isWarning) className += ' char-counter-warning';

  return (
    <div className={className}>
      {current} / {max} characters
      {isError && ' (exceeds limit)'}
    </div>
  );
};
```
[Source: epic-3-admin-ui.md#story-3.6-technical-requirements]

**Validation Utilities:**
```javascript
// utils/validation.js
export const validateRequired = (value) => {
  const isValid = value !== null && value !== undefined && value.trim() !== '';
  return {
    isValid,
    error: isValid ? null : 'This field is required'
  };
};

export const validateCharacterLimit = (value, max) => {
  const length = value?.length || 0;
  const isValid = length <= max;
  return {
    isValid,
    error: isValid ? null : `Character limit exceeded (${length}/${max})`
  };
};

export const validateUrl = (value) => {
  if (!value) return { isValid: true, error: null }; // Empty is valid unless required

  try {
    new URL(value);
    return { isValid: true, error: null };
  } catch (err) {
    return { isValid: false, error: 'Please enter a valid URL (e.g., https://example.com)' };
  }
};
```
[Source: epic-3-admin-ui.md#story-3.6-technical-requirements]

**useValidation Hook Pattern:**
```javascript
const useValidation = (rules, values) => {
  const [errors, setErrors] = useState({});

  const validateField = (fieldName) => {
    const fieldRules = rules[fieldName];
    const value = values[fieldName];
    let error = null;

    if (fieldRules.required) {
      const result = validateRequired(value);
      if (!result.isValid) {
        error = result.error;
      }
    }

    if (!error && fieldRules.maxLength) {
      const result = validateCharacterLimit(value, fieldRules.maxLength);
      if (!result.isValid) {
        error = result.error;
      }
    }

    if (!error && fieldRules.type === 'url') {
      const result = validateUrl(value);
      if (!result.isValid) {
        error = result.error;
      }
    }

    setErrors(prev => ({ ...prev, [fieldName]: error }));
    return error === null;
  };

  const validate = () => {
    const newErrors = {};
    Object.keys(rules).forEach(fieldName => {
      validateField(fieldName);
    });
    return Object.values(errors).every(error => error === null);
  };

  const isValid = Object.values(errors).every(error => error === null);

  return { errors, validate, validateField, isValid };
};
```
[Source: epic-3-admin-ui.md#story-3.6-technical-requirements]

**Validation Rules Configuration:**
```javascript
// config/validationRules.js
export const validationRules = {
  title: { required: true },
  focusKeyword: { required: true },
  hero_title: { maxLength: 100 },
  hero_subtitle: { maxLength: 150 },
  hero_summary: { maxLength: 400 },
  cta_primary_url: { type: 'url' },
  cta_secondary_url: { type: 'url' },
  // ... more fields
};
```
[Source: Architecture best practices]

**CSS for Validation States:**
```css
.field-error {
  border-color: #dc3232 !important;
  border-width: 2px;
}

.field-valid {
  border-color: #46b450;
}

.error-message {
  color: #dc3232;
  font-size: 12px;
  margin-top: 4px;
}

.char-counter {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.char-counter-warning {
  color: #f0b849;
}

.char-counter-error {
  color: #dc3232;
  font-weight: bold;
}

.required-field label::after {
  content: ' *';
  color: #dc3232;
}
```
[Source: epic-3-admin-ui.md#story-3.6-technical-requirements]

**Controlled Component Pattern with Validation:**
```javascript
const BasicInfo = ({ pageData, onChange }) => {
  const [title, setTitle] = useState(pageData.title || '');
  const { errors, validateField } = useValidation(
    { title: { required: true } },
    { title }
  );

  const handleTitleChange = (value) => {
    setTitle(value);
    onChange('title', value);
  };

  const handleTitleBlur = () => {
    validateField('title');
  };

  return (
    <div>
      <TextControl
        label="Page Title"
        value={title}
        onChange={handleTitleChange}
        onBlur={handleTitleBlur}
        className={errors.title ? 'field-error' : ''}
        required
      />
      {errors.title && <FieldError error={errors.title} />}
    </div>
  );
};
```
[Source: WordPress React patterns]

**Disable Save Button Logic:**
```javascript
const isSaveDisabled = !isValid || hasCharacterLimitErrors || isGenerating;

<Button
  isPrimary
  onClick={handleSave}
  disabled={isSaveDisabled}
>
  Save Draft
</Button>
```
[Source: epic-3-admin-ui.md#story-3.6-acceptance-criteria]

**Validation Before Generation:**
```javascript
const handleGenerateAll = () => {
  if (!validate()) {
    alert('Please fill in required fields: Page Title and Focus Keyword');
    return;
  }
  // Proceed with generation
  openBulkGenerationModal();
};
```
[Source: epic-3-admin-ui.md#story-3.6-acceptance-criteria]

### Testing

**Test File Location:**
- `tests/js/components/common/CharacterCounter.test.js`
- `tests/js/components/common/FieldError.test.js`
- `tests/js/hooks/useValidation.test.js`
- `tests/js/utils/validation.test.js`

**Testing Framework:**
- Jest 29.x + React Testing Library 14.x
- Test validation logic independently from components
[Source: architecture.md#tech-stack]

**Test Coverage Requirements:**
- Verify validateRequired returns error for empty strings
- Verify validateCharacterLimit returns error when exceeded
- Verify validateUrl accepts valid URLs and rejects invalid ones
- Verify CharacterCounter shows warning at 90% limit
- Verify CharacterCounter shows error when exceeded
- Verify FieldError displays error message
- Verify useValidation hook validates all fields correctly
- Verify Save button is disabled when validation fails
- Verify validation errors clear when corrected

**Coding Standards:**
- Use WordPress ESLint configuration
- Provide clear, user-friendly error messages
- Add ARIA attributes for accessibility
- Use controlled components for all form fields
[Source: architecture.md#code-quality-js]

**Manual Testing Checklist:**
- [ ] Leave Page Title empty and try to generate - verify alert shown
- [ ] Leave Focus Keyword empty and try to generate - verify alert shown
- [ ] Fill required fields - verify Generate buttons become enabled
- [ ] Type into hero_title field - verify character counter updates
- [ ] Exceed 100 character limit - verify counter turns red
- [ ] Verify field shows red border when limit exceeded
- [ ] Verify Save button is disabled when limit exceeded
- [ ] Enter invalid URL in cta_primary_url - verify error shown on blur
- [ ] Correct the URL - verify error disappears
- [ ] Fill all fields correctly - verify Save button is enabled
- [ ] Click Save with errors - verify validation summary appears
- [ ] Test keyboard navigation through error states
- [ ] Verify screen reader announces validation errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*
