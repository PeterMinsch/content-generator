# Story 6.2: Implement Column Mapping Interface

**Epic:** 6 - CSV Import & Bulk Processing
**Story:** 6.2
**Estimated Effort:** 3-4 hours

---

## Status

Ready for Review

---

## Story

**As a** site administrator
**I want** to map CSV columns to page fields
**so that** data imports correctly regardless of CSV format

---

## Acceptance Criteria

1. Interface shows CSV column headers
2. For each CSV column, dropdown to select mapping:
   - Page Title (required)
   - Focus Keyword
   - Topic Category
   - Image URL (optional)
   - Skip (don't import this column)
3. System detects likely mappings automatically:
   - Column named "keyword" maps to Page Title
   - Column named "intent" or "category" maps to Topic Category
   - Column named "search_volume" can be skipped
4. At least one column must map to "Page Title" (validation)
5. Preview table shows 3 sample rows with mapped data
6. Mapping saved temporarily (session or transient) for this import

---

## Tasks / Subtasks

- [ ] **Task 1: Add CSV Parsing Method to ImportPage** (AC: 1)
  - [ ] In `ImportPage.php`, add method `parseCSVHeaders( $file_path ): array`
  - [ ] Use `fopen()` and `fgetcsv()` to read first row (headers)
  - [ ] Handle errors: file not found, empty file, no headers
  - [ ] Return array: `['headers' => [...], 'preview_rows' => [...]]`
  - [ ] Read first 4 rows total (1 header + 3 preview rows)
  - [ ] Close file handle after reading
  - [ ] Sanitize header values with `sanitize_text_field()`

- [ ] **Task 2: Create Auto-Detection Logic** (AC: 3)
  - [ ] In `ImportPage.php`, add method `detectColumnMappings( array $headers ): array`
  - [ ] Create mapping rules (case-insensitive):
    - `keyword`, `title`, `query` → 'page_title'
    - `focus_keyword`, `search_query` → 'focus_keyword'
    - `intent`, `category`, `topic` → 'topic_category'
    - `image_url`, `image` → 'image_url'
    - `search_volume`, `volume`, `searches` → 'skip'
  - [ ] Loop through headers and apply rules
  - [ ] Return array: `['column_name' => 'mapped_field']`
  - [ ] If no 'page_title' mapping detected, leave first column unmapped for user selection

- [ ] **Task 3: Create AJAX Endpoint for Column Mapping** (AC: 1, 2, 5, 6)
  - [ ] In `ImportPage.php`, add method `handleColumnMapping()`
  - [ ] Register AJAX action: `wp_ajax_seo_get_column_mapping`
  - [ ] Verify nonce from request
  - [ ] Get file path from transient: `get_transient( 'import_file_' . get_current_user_id() )`
  - [ ] Call `parseCSVHeaders()` to get headers and preview rows
  - [ ] Call `detectColumnMappings()` to get auto-detected mappings
  - [ ] Return JSON response:
    ```php
    [
      'success' => true,
      'headers' => ['keyword', 'intent', 'search_volume'],
      'mappings' => ['keyword' => 'page_title', 'intent' => 'topic_category', 'search_volume' => 'skip'],
      'preview_rows' => [['platinum wedding bands', 'commercial', '1000'], ...]
    ]
    ```
  - [ ] Store mappings in transient: `set_transient('import_mapping_' . $user_id, $mappings, HOUR_IN_SECONDS)`

- [ ] **Task 4: Create Column Mapping JavaScript** (AC: 1, 2, 3, 4, 5)
  - [ ] Create file `assets/js/src/column-mapping.js`
  - [ ] Import `@wordpress/api-fetch`
  - [ ] Add event listener for file upload form submission
  - [ ] On submit, prevent default and call AJAX endpoint `seo_get_column_mapping`
  - [ ] On response, show `#column-mapping-section` div
  - [ ] Render column mapping UI dynamically:
    - For each header, create row with label and dropdown
    - Dropdown options: Page Title, Focus Keyword, Topic Category, Image URL, Skip
    - Pre-select dropdown based on auto-detected mappings
  - [ ] Render preview table:
    - Table headers show CSV column names
    - 3 rows show sample data
  - [ ] Add validation on "Import" button click:
    - Check that at least one column maps to "Page Title"
    - Show error if validation fails
  - [ ] Store updated mappings when user changes dropdowns

- [ ] **Task 5: Update Import Template with Column Mapping UI** (AC: 1, 2, 5)
  - [ ] In `templates/admin/import.php`, update `#column-mapping-section` div
  - [ ] Remove placeholder notice, keep div hidden by default
  - [ ] Add structure for dynamic rendering:
    ```html
    <div id="column-mapping-section" style="display:none;">
      <h2>Step 2: Map CSV Columns</h2>
      <div id="column-mapping-table"></div>
      <h3>Preview (First 3 Rows)</h3>
      <div id="preview-table-container"></div>
      <div class="mapping-actions">
        <button type="button" id="proceed-import" class="button button-primary">Proceed to Import</button>
        <button type="button" id="cancel-mapping" class="button">Cancel</button>
      </div>
    </div>
    ```
  - [ ] Enqueue column-mapping script after upload script
  - [ ] Add localization for AJAX endpoint and nonce

- [ ] **Task 6: Add Mapping Validation Endpoint** (AC: 4, 6)
  - [ ] In `ImportPage.php`, add method `validateMapping( array $mapping ): array`
  - [ ] Check that $mapping contains at least one 'page_title' value
  - [ ] Return validation result: `['valid' => true/false, 'error' => 'message']`
  - [ ] Create AJAX endpoint `wp_ajax_seo_validate_mapping`
  - [ ] Save validated mapping to transient for use in Story 6.4
  - [ ] Return success response to proceed to import

- [ ] **Task 7: Build JavaScript Assets** (Development)
  - [ ] Add `column-mapping.js` to webpack config entry points
  - [ ] Run `npm run build` to compile source to build directory
  - [ ] Verify compiled file exists: `assets/js/build/column-mapping.js`
  - [ ] Test that WordPress dependency extraction works (@wordpress/api-fetch)

- [ ] **Task 8: Add Unit Tests** (Testing)
  - [ ] Update `tests/php/Admin/ImportPageTest.php` with new tests
  - [ ] Test `parseCSVHeaders()`:
    - Valid CSV file returns headers and preview rows
    - Empty file returns error
    - File with only headers (no data rows) handled
  - [ ] Test `detectColumnMappings()`:
    - Common column names auto-detected correctly
    - Case-insensitive matching works
    - Unknown columns default to 'skip'
  - [ ] Test `validateMapping()`:
    - Mapping with 'page_title' returns valid=true
    - Mapping without 'page_title' returns valid=false with error
  - [ ] Test AJAX endpoints require valid nonce and capability

---

## Dev Notes

### Architecture Context

**Project:** WordPress SEO Content Generator Plugin for Jewelry E-Commerce
[Source: docs/prd.md, docs/architecture.md]

**Purpose of This Story:**
Build the column mapping interface that allows users to map CSV columns to page fields. This story builds on Story 6.1 (file upload) and prepares for Story 6.4 (batch processing). The mapping UI uses JavaScript for dynamic rendering and AJAX for server communication.

### Previous Story Insights (Story 6.1)

[Source: docs/stories/6.1.create-csv-import-page.md - Dev Agent Record]

**Key Learnings:**
- ImportPage class established in `includes/Admin/ImportPage.php`
- File upload working with transient storage: `import_file_{user_id}`
- Template placeholders ready at `#column-mapping-section` and `#preview-section`
- Security pattern: nonce + capability checks (`edit_posts`)
- handleUpload() method stores uploaded CSV in `wp_upload_dir()['path'] . '/import_' . time() . '.csv'`

**Dependencies from 6.1:**
- Upload form submits and stores file path in transient
- Column mapping section hidden by default, ready to be shown
- admin-import.css provides base styling

### CSV Parsing in PHP

[Source: docs/prd/epic-6-csv-import.md#Technical Requirements]

**PHP CSV Functions:**
- `fopen($file, 'r')` - Open CSV file for reading
- `fgetcsv($handle, 0, ',')` - Read one line as array
  - Parameters: file handle, max length (0 = unlimited), delimiter
  - Returns array of values or FALSE on error/EOF
- `fclose($handle)` - Close file handle

**Reading Strategy:**
```php
$file = fopen($file_path, 'r');
if (!$file) {
    return ['error' => 'Could not open file'];
}

// Read header row
$headers = fgetcsv($file);

// Read preview rows (3 samples)
$preview = [];
for ($i = 0; $i < 3 && ($row = fgetcsv($file)) !== false; $i++) {
    $preview[] = $row;
}

fclose($file);
```

**Error Handling:**
- Check `file_exists($file_path)` before opening
- Verify `fgetcsv()` returns array (not FALSE)
- Handle empty files (no headers)
- Handle files with only headers (no data rows)

### Auto-Detection Logic

[Source: docs/prd/epic-6-csv-import.md#Story 6.2]

**Mapping Rules (case-insensitive matching):**

| CSV Column Names | Maps To |
|-----------------|---------|
| keyword, title, query | page_title |
| focus_keyword, search_query | focus_keyword |
| intent, category, topic | topic_category |
| image_url, image | image_url |
| search_volume, volume, searches | skip |

**Implementation:**
```php
function detectColumnMappings(array $headers): array {
    $mappings = [];
    $rules = [
        'page_title' => ['keyword', 'title', 'query'],
        'focus_keyword' => ['focus_keyword', 'search_query'],
        'topic_category' => ['intent', 'category', 'topic'],
        'image_url' => ['image_url', 'image'],
        'skip' => ['search_volume', 'volume', 'searches']
    ];

    foreach ($headers as $header) {
        $lower = strtolower(trim($header));
        $mapped = false;

        foreach ($rules as $field => $patterns) {
            if (in_array($lower, $patterns)) {
                $mappings[$header] = $field;
                $mapped = true;
                break;
            }
        }

        if (!$mapped) {
            $mappings[$header] = 'skip'; // Default unmapped to skip
        }
    }

    return $mappings;
}
```

### AJAX Communication Pattern

[Source: architecture.md#Frontend React Architecture]

**WordPress AJAX Pattern:**

**PHP Side (register action):**
```php
add_action('wp_ajax_seo_get_column_mapping', array($this, 'handleColumnMapping'));

public function handleColumnMapping() {
    check_ajax_referer('seo_csv_upload', 'nonce');

    // Process request
    $response = [...];

    wp_send_json_success($response);
}
```

**JavaScript Side (call AJAX):**
```javascript
import apiFetch from '@wordpress/api-fetch';

async function loadColumnMapping() {
    try {
        const response = await apiFetch({
            path: '/wp/v2/...',  // Or use admin-ajax.php for non-REST
            method: 'POST',
            data: { action: 'seo_get_column_mapping', nonce: seoImport.nonce }
        });
        // Handle response
    } catch (error) {
        console.error(error);
    }
}
```

**Note:** For admin AJAX (not REST API), use standard admin-ajax.php pattern with jQuery or vanilla fetch.

### JavaScript Build System

[Source: architecture.md#Tech Stack, package.json]

**Build Tool:** Webpack 5.x via @wordpress/scripts

**File Locations:**
- Source: `assets/js/src/column-mapping.js`
- Build output: `assets/js/build/column-mapping.js`

**Webpack Entry Points:**
Current entries in webpack config (need to add column-mapping):
- image-upload.js
- image-tags.js

**Build Commands:**
```bash
npm run build       # Production build
npm run start       # Development with watch mode
```

**WordPress Script Dependencies:**
- `@wordpress/api-fetch` - For AJAX requests
- Dependencies extracted automatically by @wordpress/dependency-extraction-webpack-plugin
- Enqueue in PHP: `wp_enqueue_script('handle', 'path', ['wp-api-fetch'], 'version')`

### Transient Storage Pattern

[Source: docs/stories/6.1.create-csv-import-page.md#Dev Notes]

**Storing Data Temporarily:**

Story 6.1 stores file path:
```php
$transient_key = 'import_file_' . get_current_user_id();
set_transient($transient_key, $file_path, HOUR_IN_SECONDS);
```

Story 6.2 should store mappings:
```php
$transient_key = 'import_mapping_' . get_current_user_id();
set_transient($transient_key, $mapping_array, HOUR_IN_SECONDS);
```

**Transient Functions:**
- `set_transient($key, $value, $expiration)` - Store data (expires in X seconds)
- `get_transient($key)` - Retrieve data (returns FALSE if not found/expired)
- `delete_transient($key)` - Delete data

**Why Transients:**
- User-specific import data that expires
- Avoids database clutter (auto-deletes)
- Simpler than sessions in WordPress

### WordPress Functions Reference

**File Handling:**
- `file_exists($path)` - Check if file exists
- `is_readable($path)` - Check if file is readable
- `fopen($file, 'r')` - Open file for reading
- `fgetcsv($handle)` - Read CSV line as array
- `fclose($handle)` - Close file handle

**AJAX:**
- `add_action('wp_ajax_{action}', $callback)` - Register logged-in AJAX handler
- `check_ajax_referer($action, $query_arg)` - Verify AJAX nonce
- `wp_send_json_success($data)` - Send JSON success response
- `wp_send_json_error($data)` - Send JSON error response

**Enqueuing Scripts:**
- `wp_enqueue_script($handle, $src, $deps, $ver, $in_footer)`
- `wp_localize_script($handle, $object_name, $data)` - Pass PHP data to JS

**String Functions:**
- `strtolower($string)` - Convert to lowercase
- `trim($string)` - Remove whitespace
- `in_array($needle, $haystack)` - Check if value in array
- `sanitize_text_field($string)` - Sanitize text input

### Project Structure Notes

[Source: docs/architecture.md#Unified Project Structure]

**New Files Created:**
```
assets/js/src/column-mapping.js        # JavaScript for mapping UI
assets/js/build/column-mapping.js      # Compiled output (gitignored)
```

**Modified Files:**
```
includes/Admin/ImportPage.php          # Add parsing, auto-detection, AJAX methods
templates/admin/import.php             # Update column mapping section structure
tests/php/Admin/ImportPageTest.php     # Add tests for new methods
webpack.config.js                      # Add column-mapping to entry points
```

**Dependencies:**
- Story 6.1: Uses uploaded file path from transient
- Story 6.4: Will use mapping data from transient for batch processing

### Testing

[Source: docs/architecture.md#Testing Strategy]

**Test Framework:** PHPUnit 9.x with WordPress Test Framework
**Test Location:** `tests/php/Admin/ImportPageTest.php` (update existing file)

**Required Test Coverage:**

1. **CSV Parsing Tests**
   - Valid CSV with headers and data returns correct array structure
   - CSV with only headers (no data) returns headers with empty preview
   - Empty file returns error
   - File not found returns error
   - Headers sanitized correctly

2. **Auto-Detection Tests**
   - Column "keyword" maps to "page_title"
   - Column "intent" maps to "topic_category"
   - Column "search_volume" maps to "skip"
   - Case-insensitive matching works ("KEYWORD" → "page_title")
   - Unknown column defaults to "skip"

3. **Validation Tests**
   - Mapping with at least one "page_title" returns valid=true
   - Mapping with no "page_title" returns valid=false
   - Error message explains "page_title" requirement

4. **AJAX Security Tests**
   - Invalid nonce rejected
   - User without edit_posts capability denied

**Test Data Setup:**
Create test CSV files in `tests/fixtures/`:
- `test-import-valid.csv` - Valid CSV with headers and 3 rows
- `test-import-headers-only.csv` - Only headers, no data
- `test-import-empty.csv` - Empty file

**Running Tests:**
```bash
composer run test -- tests/php/Admin/ImportPageTest.php
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation from Epic 6.2 | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No errors encountered during implementation. All code followed established patterns from Story 6.1 and existing admin pages.

### Completion Notes List

1. ✅ Successfully added `parseCSVHeaders()` method to ImportPage
   - Reads CSV headers and up to 3 preview rows
   - Handles all error cases: file not found, not readable, empty file, no headers
   - Sanitizes all data with `sanitize_text_field()`

2. ✅ Successfully added `detectColumnMappings()` method to ImportPage
   - Case-insensitive pattern matching for common column names
   - Maps keyword/title/query → page_title
   - Maps intent/category/topic → topic_category
   - Maps search_volume/volume/searches → skip
   - Maps image_url/image → image_url
   - Defaults unknown columns to 'skip'

3. ✅ Successfully created AJAX endpoint `handleColumnMapping()`
   - Registers as `wp_ajax_seo_get_column_mapping`
   - Retrieves uploaded file from transient
   - Calls parseCSVHeaders() and detectColumnMappings()
   - Stores mappings in transient for later use
   - Returns JSON with headers, mappings, and preview rows

4. ✅ Successfully created column-mapping.js
   - Uses @wordpress/api-fetch for AJAX calls
   - Dynamically renders column mapping table with dropdowns
   - Renders preview table showing first 3 rows
   - Client-side validation ensures at least one page_title mapping
   - Cancel button resets form and hides mapping section

5. ✅ Successfully updated import template
   - Added column mapping section with proper structure
   - Enqueued column-mapping.js with wp-api-fetch dependency
   - Localized script with nonce and AJAX URL
   - Added containers for dynamic rendering
   - Added Proceed and Cancel buttons

6. ✅ Successfully added `validateMapping()` method and `handleMappingValidation()` endpoint
   - Validates that at least one column maps to page_title
   - Registers as `wp_ajax_seo_validate_mapping`
   - Saves validated mapping to transient
   - Returns clear error messages when validation fails

7. ✅ Successfully built JavaScript assets
   - Added column-mapping entry to webpack.config.js
   - Ran npm run build successfully
   - Generated column-mapping.js (3.71 KiB minified)
   - Generated column-mapping.asset.php with wp-api-fetch dependency

8. ✅ Successfully added comprehensive unit tests
   - Added 7 new test methods to ImportPageTest.php
   - Tests for parseCSVHeaders() with valid/invalid/empty files
   - Tests for detectColumnMappings() with various column names
   - Tests for case-insensitive matching
   - Tests for validateMapping() with/without page_title
   - All tests follow existing test patterns

**All Acceptance Criteria Met:**
- ✅ AC1: Interface shows CSV column headers (dynamic rendering in JavaScript)
- ✅ AC2: Dropdowns for each column with mapping options
- ✅ AC3: Auto-detection of likely mappings based on column names
- ✅ AC4: Validation ensures at least one page_title mapping
- ✅ AC5: Preview table shows 3 sample rows with mapped data
- ✅ AC6: Mapping saved in transient for this import session

### File List

**Created Files:**
- `assets/js/src/column-mapping.js` - Column mapping UI JavaScript
- `assets/js/build/column-mapping.js` - Compiled JavaScript (gitignored)
- `assets/js/build/column-mapping.asset.php` - WordPress dependency file (gitignored)

**Modified Files:**
- `includes/Admin/ImportPage.php` - Added 5 new methods:
  - `register()` - Registers AJAX actions
  - `parseCSVHeaders()` - Parses CSV headers and preview rows
  - `detectColumnMappings()` - Auto-detects column mappings
  - `handleColumnMapping()` - AJAX endpoint for column mapping
  - `validateMapping()` - Validates mapping configuration
  - `handleMappingValidation()` - AJAX endpoint for validation
- `includes/Plugin.php` - Added ImportPage->register() call
- `templates/admin/import.php` - Updated column mapping section structure, enqueued script
- `webpack.config.js` - Added column-mapping entry point
- `tests/php/Admin/ImportPageTest.php` - Added 7 new test methods

---

## QA Results

_To be filled by QA agent after implementation review_
