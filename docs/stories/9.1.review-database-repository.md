# Story 9.1: Review Database Schema and Repository

**Epic:** 9 - Automated Review Integration
**Status:** Draft

---

## Story

**As a** plugin developer,
**I want** a custom database table and repository pattern for cached review data,
**so that** reviews can be stored efficiently and reused across multiple page generations

---

## Acceptance Criteria

1. **Database Table Creation**
   - Custom table `{prefix}_seo_reviews` created during plugin activation
   - Table includes fields: id, source, external_review_id, reviewer_name, reviewer_avatar_url, rating, review_text, review_date, last_fetched_at
   - Unique constraint on (source, external_review_id) prevents duplicate reviews
   - Indexes on source, last_fetched_at, and rating for query performance
   - Table uses InnoDB engine with utf8mb4 charset

2. **Repository Class Implementation**
   - Repository class `ReviewRepository` provides clean data access layer
   - Method: `getAll(int $limit = 10): array` - get all reviews ordered by rating DESC
   - Method: `getByRating(float $min_rating, int $limit = 10): array` - filter by minimum rating
   - Method: `getTopRated(int $limit = 5): array` - get highest rated reviews
   - Method: `save(array $review_data): int` - insert new review (skip duplicates)
   - Method: `deleteAll(): int` - clear all cached reviews
   - Method: `getCacheAge(): int` - return age of oldest review in days
   - Method: `needsRefresh(int $max_days = 30): bool` - check if cache is stale

3. **Activation Hook Integration**
   - Table created/updated via `Activation::activate()` hook
   - Database version tracked with option `seo_generator_review_db_version`
   - Support for future schema upgrades (version checking)

4. **Data Integrity**
   - All database operations use prepared statements (SQL injection prevention)
   - Duplicate reviews prevented via UNIQUE constraint
   - Repository returns associative arrays (consistent data format)
   - Null values handled gracefully (optional fields)

5. **Performance**
   - Table creation completes in <1 second
   - No impact on plugin activation time
   - Indexes optimize common queries (source, rating, cache age)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Database Schema Definition** (AC: 1)
  - [ ] Define table schema in `includes/Activation.php`
  - [ ] Add all 9 columns: id, source, external_review_id, reviewer_name, reviewer_avatar_url, rating, review_text, review_date, last_fetched_at
  - [ ] Set UNIQUE KEY on (source, external_review_id)
  - [ ] Add INDEX on source, last_fetched_at, rating
  - [ ] Set ENGINE=InnoDB and CHARSET=utf8mb4

- [ ] **Task 2: Implement Table Creation in Activation Hook** (AC: 1, 3)
  - [ ] Update `includes/Activation.php::activate()` method
  - [ ] Check current DB version with `get_option('seo_generator_review_db_version')`
  - [ ] Create table using `$wpdb->query()` with dbDelta()
  - [ ] Update DB version option after successful creation
  - [ ] Add error logging if table creation fails

- [ ] **Task 3: Create ReviewRepository Class** (AC: 2)
  - [ ] Create `includes/Repositories/ReviewRepository.php`
  - [ ] Add constructor with `$wpdb` injection
  - [ ] Define table name constant: `{$wpdb->prefix}seo_reviews`
  - [ ] Add PHPDoc for all methods with parameter/return types

- [ ] **Task 4: Implement getAll() Method** (AC: 2)
  - [ ] Query: `SELECT * FROM {table} ORDER BY rating DESC, review_date DESC LIMIT %d`
  - [ ] Use `$wpdb->prepare()` for limit parameter
  - [ ] Use `$wpdb->get_results(ARRAY_A)` to return associative arrays
  - [ ] Return empty array if no results

- [ ] **Task 5: Implement getByRating() Method** (AC: 2)
  - [ ] Query: `SELECT * FROM {table} WHERE rating >= %f ORDER BY rating DESC LIMIT %d`
  - [ ] Use `$wpdb->prepare()` for min_rating and limit
  - [ ] Return associative arrays

- [ ] **Task 6: Implement getTopRated() Method** (AC: 2)
  - [ ] Query: `SELECT * FROM {table} ORDER BY rating DESC, review_date DESC LIMIT %d`
  - [ ] Use `$wpdb->prepare()` for limit
  - [ ] Return associative arrays

- [ ] **Task 7: Implement save() Method** (AC: 2, 4)
  - [ ] Use `INSERT IGNORE INTO` to skip duplicates
  - [ ] Prepare data array for insert: all 8 fields (excluding id)
  - [ ] Use `$wpdb->insert()` with format array
  - [ ] Return `$wpdb->insert_id` on success, 0 if duplicate
  - [ ] Add error logging if insert fails

- [ ] **Task 8: Implement deleteAll() Method** (AC: 2)
  - [ ] Query: `DELETE FROM {table}`
  - [ ] Use `$wpdb->query()` to execute
  - [ ] Return number of rows deleted (`$wpdb->rows_affected`)

- [ ] **Task 9: Implement getCacheAge() Method** (AC: 2)
  - [ ] Query: `SELECT DATEDIFF(NOW(), MIN(last_fetched_at)) as age FROM {table}`
  - [ ] Use `$wpdb->get_var()` to return single value
  - [ ] Return 0 if table is empty
  - [ ] Return integer number of days

- [ ] **Task 10: Implement needsRefresh() Method** (AC: 2)
  - [ ] Call `getCacheAge()` internally
  - [ ] Return true if cache age >= $max_days
  - [ ] Return true if table is empty (cache age = 0)
  - [ ] Return false if cache is fresh

- [ ] **Task 11: Add Unit Tests** (AC: All)
  - [ ] Test table creation succeeds during activation
  - [ ] Test getAll() returns all reviews ordered by rating
  - [ ] Test getByRating() filters correctly
  - [ ] Test getTopRated() returns top N reviews
  - [ ] Test save() inserts new review and returns ID
  - [ ] Test save() skips duplicate review (returns 0)
  - [ ] Test deleteAll() clears all reviews
  - [ ] Test getCacheAge() calculates age correctly
  - [ ] Test needsRefresh() returns true when cache stale
  - [ ] Test needsRefresh() returns false when cache fresh

---

## Dev Notes

### Feature Context

This story lays the foundation for Epic 9 (Automated Review Integration) by creating the database infrastructure needed to cache Google Business Profile reviews. Reviews are fetched from the API and stored locally to reduce API calls and improve performance during page generation.

**Key Design Decisions:**
- Custom table (not CPT) for efficient querying and non-WordPress data
- Repository pattern provides abstraction layer for future migrations
- Cache age tracking enables automatic refresh logic (Story 9.3)
- Duplicate prevention via UNIQUE constraint ensures data integrity

### Previous Story Insights

From Story 5.2 (Bulk Image Upload):
- Custom table creation follows same pattern as existing plugin tables
- Use dbDelta() for table creation (WordPress best practice)
- Track DB version with option for upgrade support

From Epic 1 (Foundation Setup):
- Activation hooks handle one-time setup tasks
- Database operations should use `$wpdb` global with prepared statements
- Error logging critical for debugging activation issues

### Data Models

**Database Schema:**
```sql
CREATE TABLE {prefix}_seo_reviews (
    id BIGINT(20) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    source VARCHAR(50) NOT NULL DEFAULT 'google',
    external_review_id VARCHAR(255) NOT NULL,
    reviewer_name VARCHAR(255),
    reviewer_avatar_url VARCHAR(500),
    rating DECIMAL(2,1),
    review_text TEXT,
    review_date DATETIME,
    last_fetched_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY unique_review (source, external_review_id),
    INDEX idx_source (source),
    INDEX idx_last_fetched (last_fetched_at),
    INDEX idx_rating (rating)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**Review Data Structure (Repository Return Format):**
```php
[
    'id' => 123,
    'source' => 'google',
    'external_review_id' => 'ChZDSUhNMG9nS0VJQ0FnSURueF9YdGR3EAE',
    'reviewer_name' => 'Sarah Johnson',
    'reviewer_avatar_url' => 'https://lh3.googleusercontent.com/a-/AOh14Gi...',
    'rating' => '5.0',
    'review_text' => 'Excellent service! Beautiful engagement ring.',
    'review_date' => '2025-09-15 10:30:00',
    'last_fetched_at' => '2025-10-15 14:22:00'
]
```

[Source: Epic 9 - Story 9.1 Requirements]

### Plugin Architecture & Patterns

**Repository Pattern**
The plugin uses repository classes for data access abstraction [Source: architecture.md#Repository Pattern]:
- Repositories handle all database queries for a specific entity
- Business logic stays in service layer, data access in repository
- Enables easier testing with mock repositories
- Similar pattern used in existing `GenerationLogRepository` (if exists)

**Database Abstraction ($wpdb)**
WordPress global `$wpdb` provides secure database access [Source: WordPress Codex]:
- All queries use prepared statements via `$wpdb->prepare()`
- Methods: `insert()`, `update()`, `delete()`, `get_results()`, `get_var()`
- Automatic prefix handling: `{$wpdb->prefix}seo_reviews`

**Activation Hook Pattern**
Plugin activation hooks handle one-time setup [Source: content-generator.php:72]:
```php
register_activation_hook( __FILE__, array( 'SEOGenerator\\Activation', 'activate' ) );
```

### File Locations

Based on Unified Project Structure [Source: architecture.md#Unified Project Structure]:

**PHP Classes:**
- New: `includes/Repositories/ReviewRepository.php`
- Update: `includes/Activation.php` (add table creation)

**Database:**
- Table: `{prefix}_seo_reviews` (e.g., `wp_seo_reviews`)
- Option: `seo_generator_review_db_version` (current version: 1.0)

### Component Specifications

**ReviewRepository Class**
Location: `includes/Repositories/ReviewRepository.php`

```php
<?php
namespace SEOGenerator\Repositories;

class ReviewRepository {
    private $wpdb;
    private $table_name;

    public function __construct() {
        global $wpdb;
        $this->wpdb = $wpdb;
        $this->table_name = $wpdb->prefix . 'seo_reviews';
    }

    /**
     * Get all reviews ordered by rating DESC
     *
     * @param int $limit Maximum number of reviews to return
     * @return array Associative arrays of review data
     */
    public function getAll(int $limit = 10): array {
        $sql = $this->wpdb->prepare(
            "SELECT * FROM {$this->table_name} ORDER BY rating DESC, review_date DESC LIMIT %d",
            $limit
        );
        $results = $this->wpdb->get_results($sql, ARRAY_A);
        return $results ?: [];
    }

    /**
     * Get reviews with minimum rating
     *
     * @param float $min_rating Minimum rating (e.g., 4.0)
     * @param int $limit Maximum number of reviews
     * @return array Associative arrays of review data
     */
    public function getByRating(float $min_rating, int $limit = 10): array {
        $sql = $this->wpdb->prepare(
            "SELECT * FROM {$this->table_name} WHERE rating >= %f ORDER BY rating DESC, review_date DESC LIMIT %d",
            $min_rating,
            $limit
        );
        $results = $this->wpdb->get_results($sql, ARRAY_A);
        return $results ?: [];
    }

    /**
     * Get top-rated reviews
     *
     * @param int $limit Number of top reviews to return
     * @return array Associative arrays of review data
     */
    public function getTopRated(int $limit = 5): array {
        return $this->getAll($limit);
    }

    /**
     * Save a new review to database (skip duplicates)
     *
     * @param array $review_data Review data (source, external_review_id, etc.)
     * @return int Insert ID if successful, 0 if duplicate
     */
    public function save(array $review_data): int {
        $result = $this->wpdb->insert(
            $this->table_name,
            [
                'source' => $review_data['source'],
                'external_review_id' => $review_data['external_review_id'],
                'reviewer_name' => $review_data['reviewer_name'] ?? null,
                'reviewer_avatar_url' => $review_data['reviewer_avatar_url'] ?? null,
                'rating' => $review_data['rating'] ?? null,
                'review_text' => $review_data['review_text'] ?? null,
                'review_date' => $review_data['review_date'] ?? null,
                'last_fetched_at' => current_time('mysql'),
            ],
            [
                '%s', // source
                '%s', // external_review_id
                '%s', // reviewer_name
                '%s', // reviewer_avatar_url
                '%f', // rating
                '%s', // review_text
                '%s', // review_date
                '%s', // last_fetched_at
            ]
        );

        // Return insert ID on success, 0 if duplicate (INSERT IGNORE)
        return $result ? $this->wpdb->insert_id : 0;
    }

    /**
     * Delete all reviews from cache
     *
     * @return int Number of rows deleted
     */
    public function deleteAll(): int {
        $result = $this->wpdb->query("DELETE FROM {$this->table_name}");
        return $this->wpdb->rows_affected;
    }

    /**
     * Get age of oldest review in cache (in days)
     *
     * @return int Number of days since oldest review fetched
     */
    public function getCacheAge(): int {
        $sql = "SELECT DATEDIFF(NOW(), MIN(last_fetched_at)) as age FROM {$this->table_name}";
        $age = $this->wpdb->get_var($sql);
        return (int) ($age ?: 0);
    }

    /**
     * Check if cache needs refresh
     *
     * @param int $max_days Maximum cache age in days (default: 30)
     * @return bool True if cache is stale or empty
     */
    public function needsRefresh(int $max_days = 30): bool {
        $age = $this->getCacheAge();
        return $age === 0 || $age >= $max_days;
    }
}
```

[Source: Epic 9 - Story 9.1 Technical Requirements]

**Activation Hook Update**
Location: `includes/Activation.php`

```php
<?php
namespace SEOGenerator;

class Activation {
    public static function activate() {
        // ... existing activation code ...

        // Create review cache table
        self::createReviewTable();

        // ... existing activation code ...
    }

    private static function createReviewTable() {
        global $wpdb;

        $table_name = $wpdb->prefix . 'seo_reviews';
        $charset_collate = $wpdb->get_charset_collate();

        $sql = "CREATE TABLE $table_name (
            id BIGINT(20) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
            source VARCHAR(50) NOT NULL DEFAULT 'google',
            external_review_id VARCHAR(255) NOT NULL,
            reviewer_name VARCHAR(255),
            reviewer_avatar_url VARCHAR(500),
            rating DECIMAL(2,1),
            review_text TEXT,
            review_date DATETIME,
            last_fetched_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            UNIQUE KEY unique_review (source, external_review_id),
            INDEX idx_source (source),
            INDEX idx_last_fetched (last_fetched_at),
            INDEX idx_rating (rating)
        ) $charset_collate;";

        require_once ABSPATH . 'wp-admin/includes/upgrade.php';
        dbDelta($sql);

        // Update database version
        update_option('seo_generator_review_db_version', '1.0');

        // Log table creation
        error_log('[SEO Generator] Review table created/updated');
    }
}
```

[Source: WordPress dbDelta() Documentation]

### API Specifications

**ReviewRepository Methods:**

1. **getAll(int $limit = 10): array**
   - Returns all reviews ordered by rating DESC, then review_date DESC
   - Default limit: 10 reviews
   - Returns empty array if no reviews

2. **getByRating(float $min_rating, int $limit = 10): array**
   - Filters reviews by minimum rating (e.g., 4.0 or higher)
   - Useful for showing only positive reviews
   - Returns empty array if no matches

3. **getTopRated(int $limit = 5): array**
   - Alias for getAll() with smaller default limit
   - Returns highest-rated reviews
   - Used in Story 9.4 for page generation

4. **save(array $review_data): int**
   - Inserts new review (skips if duplicate external_review_id)
   - Returns insert ID on success, 0 if duplicate
   - Handles null values for optional fields

5. **deleteAll(): int**
   - Clears entire review cache
   - Returns number of rows deleted
   - Useful for manual cache refresh

6. **getCacheAge(): int**
   - Calculates age of oldest review in days
   - Returns 0 if table is empty
   - Used by needsRefresh() for cache validation

7. **needsRefresh(int $max_days = 30): bool**
   - Returns true if cache older than max_days or empty
   - Default: 30 days
   - Used in Story 9.3 to trigger API fetch

### Technical Constraints

**WordPress Database Requirements**
- Must use `$wpdb` global for all queries (WordPress standard)
- All queries must use prepared statements (security)
- Table prefix must be dynamic: `{$wpdb->prefix}seo_reviews`

**Data Type Constraints**
- `rating`: DECIMAL(2,1) supports values like 4.5, 5.0 (1 decimal place)
- `external_review_id`: VARCHAR(255) based on Google review ID format
- `review_text`: TEXT supports reviews up to 65,535 characters

**Duplicate Prevention**
- UNIQUE constraint on (source, external_review_id)
- INSERT will fail silently if duplicate exists
- Repository should handle gracefully (return 0 instead of throwing error)

**Performance Considerations**
- Indexes on source, last_fetched_at, rating for fast queries
- Limit default queries to 10 rows (prevent large result sets)
- Use InnoDB engine for transaction support (future-proofing)

### Integration Points

**Hook 1: Plugin Activation**
Location: `content-generator.php:72`

```php
register_activation_hook( __FILE__, array( 'SEOGenerator\\Activation', 'activate' ) );
```

When plugin activates, `Activation::activate()` creates review table.

**Hook 2: Repository Usage (Future Stories)**
Location: `includes/Services/ReviewFetchService.php` (Story 9.3)

```php
$repository = new ReviewRepository();
if ($repository->needsRefresh(30)) {
    // Fetch from API (Story 9.2)
}
$reviews = $repository->getTopRated(5);
```

**Hook 3: Helper Functions (Story 9.4)**
Location: `includes/functions.php`

```php
function seo_get_page_reviews(int $post_id): array {
    // Will use ReviewRepository to retrieve cached reviews
}
```

### Project Structure Notes

The plugin follows WordPress Plugin Architecture with repository pattern [Source: architecture.md#Plugin Architecture]. New files follow established patterns:
- Repository classes in `includes/Repositories/`
- Activation logic in `includes/Activation.php`
- Custom tables use `{$wpdb->prefix}` for multi-site compatibility

No admin UI required for this story - purely backend data layer.

---

## Testing

### Testing Standards

**Framework:** PHPUnit 9.x for PHP unit and integration tests [Source: architecture.md#Tech Stack - Backend Testing]

**Test Location:**
- Unit tests: `tests/php/Repositories/ReviewRepositoryTest.php` (new)
- Integration tests: `tests/php/Integration/ReviewTableTest.php` (new)

**Standards:** Follow WordPress test framework patterns with `WP_UnitTestCase` base class

**Coverage:** Test all repository methods, table creation, and cache age calculations

### Test Cases

**Unit Test: Table Creation During Activation**
```php
public function test_table_created_on_activation() {
    global $wpdb;

    // Trigger activation
    \SEOGenerator\Activation::activate();

    // Check table exists
    $table_name = $wpdb->prefix . 'seo_reviews';
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table_name'") === $table_name;

    $this->assertTrue($table_exists);

    // Check DB version option
    $db_version = get_option('seo_generator_review_db_version');
    $this->assertEquals('1.0', $db_version);
}
```

**Unit Test: getAll() Returns Reviews Ordered by Rating**
```php
public function test_get_all_returns_reviews_ordered_by_rating() {
    $repository = new ReviewRepository();

    // Insert test reviews
    $repository->save(['source' => 'google', 'external_review_id' => '1', 'rating' => 4.5, ...]);
    $repository->save(['source' => 'google', 'external_review_id' => '2', 'rating' => 5.0, ...]);
    $repository->save(['source' => 'google', 'external_review_id' => '3', 'rating' => 4.0, ...]);

    $results = $repository->getAll(10);

    $this->assertCount(3, $results);
    $this->assertEquals(5.0, $results[0]['rating']); // Highest first
    $this->assertEquals(4.5, $results[1]['rating']);
    $this->assertEquals(4.0, $results[2]['rating']);
}
```

**Unit Test: save() Skips Duplicate Reviews**
```php
public function test_save_skips_duplicate_review() {
    $repository = new ReviewRepository();

    $review_data = [
        'source' => 'google',
        'external_review_id' => 'abc123',
        'reviewer_name' => 'John Doe',
        'rating' => 5.0,
    ];

    // First save should succeed
    $id1 = $repository->save($review_data);
    $this->assertGreaterThan(0, $id1);

    // Second save should return 0 (duplicate)
    $id2 = $repository->save($review_data);
    $this->assertEquals(0, $id2);

    // Only 1 review should exist
    $all = $repository->getAll(10);
    $this->assertCount(1, $all);
}
```

**Unit Test: getCacheAge() Calculates Age Correctly**
```php
public function test_get_cache_age_calculates_age_correctly() {
    $repository = new ReviewRepository();

    // Insert review with old last_fetched_at date
    global $wpdb;
    $table_name = $wpdb->prefix . 'seo_reviews';
    $wpdb->insert($table_name, [
        'source' => 'google',
        'external_review_id' => 'old123',
        'last_fetched_at' => date('Y-m-d H:i:s', strtotime('-15 days')),
    ]);

    $age = $repository->getCacheAge();

    $this->assertEquals(15, $age);
}
```

**Unit Test: needsRefresh() Returns True When Cache Stale**
```php
public function test_needs_refresh_returns_true_when_cache_stale() {
    $repository = new ReviewRepository();

    // Insert old review (35 days ago)
    global $wpdb;
    $table_name = $wpdb->prefix . 'seo_reviews';
    $wpdb->insert($table_name, [
        'source' => 'google',
        'external_review_id' => 'stale123',
        'last_fetched_at' => date('Y-m-d H:i:s', strtotime('-35 days')),
    ]);

    $needs_refresh = $repository->needsRefresh(30);

    $this->assertTrue($needs_refresh);
}
```

**Unit Test: needsRefresh() Returns False When Cache Fresh**
```php
public function test_needs_refresh_returns_false_when_cache_fresh() {
    $repository = new ReviewRepository();

    // Insert recent review (5 days ago)
    global $wpdb;
    $table_name = $wpdb->prefix . 'seo_reviews';
    $wpdb->insert($table_name, [
        'source' => 'google',
        'external_review_id' => 'fresh123',
        'last_fetched_at' => date('Y-m-d H:i:s', strtotime('-5 days')),
    ]);

    $needs_refresh = $repository->needsRefresh(30);

    $this->assertFalse($needs_refresh);
}
```

**Integration Test: Full Review Lifecycle**
```php
public function test_full_review_lifecycle() {
    $repository = new ReviewRepository();

    // Save multiple reviews
    $repository->save(['source' => 'google', 'external_review_id' => '1', 'rating' => 5.0, ...]);
    $repository->save(['source' => 'google', 'external_review_id' => '2', 'rating' => 4.5, ...]);
    $repository->save(['source' => 'google', 'external_review_id' => '3', 'rating' => 3.5, ...]);

    // Get by rating
    $high_rated = $repository->getByRating(4.0, 10);
    $this->assertCount(2, $high_rated); // Only 5.0 and 4.5

    // Get top rated
    $top = $repository->getTopRated(1);
    $this->assertCount(1, $top);
    $this->assertEquals(5.0, $top[0]['rating']);

    // Delete all
    $deleted = $repository->deleteAll();
    $this->assertEquals(3, $deleted);

    // Verify empty
    $all = $repository->getAll(10);
    $this->assertCount(0, $all);
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after testing*
