# Story 9.4: Integration with Page Generation

**Epic:** 9 - Automated Review Integration
**Status:** Draft

---

## Story

**As a** content manager,
**I want** reviews automatically available when generating pages with review blocks,
**so that** review blocks display real customer feedback from Google without manual intervention

---

## Acceptance Criteria

1. **Review Block Detection**
   - During page generation, check if 'review_section' exists in block order
   - Only fetch reviews if review block requested (don't waste resources)
   - Detection happens before any review fetching occurs
   - Block order read from post meta `_seo_block_order` or default constant

2. **Automatic Review Fetching**
   - In `ContentGenerationService::generateBlock('review_section')` method
   - Call `ReviewFetchService::getReviews(5)` to get top 5 reviews
   - Reviews fetched automatically (no user interaction)
   - Cache logic handled by ReviewFetchService (Story 9.3)
   - Fetching logged to debug.log for troubleshooting

3. **Review Data Storage**
   - Store fetched reviews in post meta: `_seo_reviews_data`
   - Data format: JSON-encoded array of review objects
   - Store after successful fetch (even if empty array)
   - Reviews persist with page for later use by block developer

4. **Helper Functions for Block Developer**
   - Create `seo_get_page_reviews(int $post_id): array` - retrieve reviews for a page
   - Create `seo_format_review_rating(float $rating): string` - format rating as stars
   - Create `seo_get_review_avatar(string $url, int $size): string` - get avatar HTML
   - Functions available globally for use in block templates
   - Functions documented in integration guide for block developer

5. **Empty State Handling**
   - If no reviews available (API failed, no cache), store empty array
   - Block developer's template should handle empty array gracefully
   - Display placeholder: "No reviews available yet" or similar
   - No errors thrown to user (graceful degradation)

6. **Documentation for Block Developer**
   - Create `docs/review-block-integration.md` guide
   - Document review data structure (fields, types)
   - Document helper functions with code examples
   - Provide sample block template code
   - Explain how to handle empty reviews array

---

## Tasks / Subtasks

- [ ] **Task 1: Add Review Block Detection Logic** (AC: 1)
  - [ ] In `ContentGenerationService.php`, add method `hasReviewBlock(int $post_id): bool`
  - [ ] Method reads block order via existing `getBlockOrder()` method
  - [ ] Check if 'review_section' exists in array: `in_array('review_section', $block_order)`
  - [ ] Return boolean true/false

- [ ] **Task 2: Update generateAllBlocks() to Check for Review Block** (AC: 1, 2)
  - [ ] In `generateAllBlocks()` method, before block loop
  - [ ] Call `hasReviewBlock($post_id)` to check if review fetching needed
  - [ ] If true, log "[Review Integration] Review block detected, fetching reviews"
  - [ ] Set flag or proceed to fetching step

- [ ] **Task 3: Implement Review Fetching in generateBlock()** (AC: 2, 3)
  - [ ] Add case for 'review_section' in `generateBlock()` method
  - [ ] Get ReviewFetchService instance: `Plugin::getReviewFetchService()`
  - [ ] Call `getReviews(5)` to fetch top 5 reviews
  - [ ] Log number of reviews fetched
  - [ ] Store in post meta: `update_post_meta($post_id, '_seo_reviews_data', wp_json_encode($reviews))`
  - [ ] Return success result

- [ ] **Task 4: Create Helper Function: seo_get_page_reviews()** (AC: 4)
  - [ ] Add to `includes/functions.php`
  - [ ] Signature: `function seo_get_page_reviews(int $post_id): array`
  - [ ] Retrieve meta: `get_post_meta($post_id, '_seo_reviews_data', true)`
  - [ ] Decode JSON: `json_decode($json, true)`
  - [ ] Return array (or empty array if not set)
  - [ ] Add PHPDoc with usage example

- [ ] **Task 5: Create Helper Function: seo_format_review_rating()** (AC: 4)
  - [ ] Add to `includes/functions.php`
  - [ ] Signature: `function seo_format_review_rating(float $rating): string`
  - [ ] Convert rating to star HTML/emoji
  - [ ] Full stars: `floor($rating)`
  - [ ] Half star: `($rating - floor($rating)) >= 0.5`
  - [ ] Return HTML string with stars (★★★★★ or ⭐⭐⭐⭐⭐)
  - [ ] Add PHPDoc with usage example

- [ ] **Task 6: Create Helper Function: seo_get_review_avatar()** (AC: 4)
  - [ ] Add to `includes/functions.php`
  - [ ] Signature: `function seo_get_review_avatar(string $url, int $size = 64): string`
  - [ ] If URL empty, return default avatar using `get_avatar_url()`
  - [ ] Build HTML `<img>` tag with size, alt text, and class
  - [ ] Return sanitized HTML
  - [ ] Add PHPDoc with usage example

- [ ] **Task 7: Handle Empty Reviews Array** (AC: 5)
  - [ ] In `generateBlock('review_section')`, check if reviews array empty
  - [ ] If empty, log "[Review Integration] No reviews available, storing empty array"
  - [ ] Still store empty array in post meta (so block knows reviews were checked)
  - [ ] Document empty state handling in integration guide

- [ ] **Task 8: Create Integration Documentation** (AC: 6)
  - [ ] Create `docs/review-block-integration.md`
  - [ ] Document review data structure with field descriptions
  - [ ] Document all helper functions with code examples
  - [ ] Provide sample block template code (PHP)
  - [ ] Explain empty state handling
  - [ ] Include troubleshooting tips (check debug.log)

- [ ] **Task 9: Add Integration Tests** (AC: All)
  - [ ] Test hasReviewBlock() returns true when review block in order
  - [ ] Test hasReviewBlock() returns false when no review block
  - [ ] Test generateBlock('review_section') fetches and stores reviews
  - [ ] Test seo_get_page_reviews() retrieves stored reviews
  - [ ] Test seo_format_review_rating() formats ratings correctly
  - [ ] Test seo_get_review_avatar() returns avatar HTML
  - [ ] Test empty reviews array stored when no reviews available
  - [ ] Integration test: full page generation with review block

---

## Dev Notes

### Feature Context

This story completes Epic 9 (Automated Review Integration) by connecting the review fetching system to the page generation workflow. It ensures reviews are automatically available when a page with a review block is generated, and provides helper functions for the block developer to display the data.

**Key Design Decisions:**
- Reviews only fetched when review block actually present (performance)
- Data stored in post meta (persistent, survives regeneration)
- Helper functions simplify block developer's work
- Empty state handled gracefully (no errors if no reviews)

**Workflow:**
1. User generates page with 'review_section' in block order
2. ContentGenerationService detects review block
3. Calls ReviewFetchService to get top 5 reviews (cached or fresh)
4. Stores reviews in post meta `_seo_reviews_data`
5. Block developer retrieves reviews using `seo_get_page_reviews()`
6. Block template renders reviews with helper functions

### Previous Story Insights

From Story 9.3 (Review Fetch Service):
- ReviewFetchService provides `getReviews()` method
- Returns array of review data (from cache or API)
- Handles all caching and error logic internally

From Story 8.2 (Block Order Customization):
- Block order stored in post meta `_seo_block_order`
- ContentGenerationService has `getBlockOrder()` method
- Blocks generated in `generateBlock()` method

From Epic 2 (Content Generation):
- Post meta used to store generated content data
- Helper functions in `includes/functions.php` for templates
- ACF fields populated during generation

### Data Models

**Review Data Structure (Stored in Post Meta):**
```php
// Stored as JSON in _seo_reviews_data
[
    [
        'id' => 123,
        'source' => 'google',
        'external_review_id' => 'ChZDSUhN...',
        'reviewer_name' => 'Sarah Johnson',
        'reviewer_avatar_url' => 'https://lh3.googleusercontent.com/...',
        'rating' => '5.0',
        'review_text' => 'Excellent service! Beautiful engagement ring.',
        'review_date' => '2025-09-20 10:30:00',
        'last_fetched_at' => '2025-10-15 14:22:00'
    ],
    [
        'id' => 124,
        'source' => 'google',
        'reviewer_name' => 'Michael Chen',
        'rating' => '4.5',
        'review_text' => 'Great selection and helpful staff.',
        'review_date' => '2025-09-18 15:45:00',
        ...
    ],
    // ... up to 5 reviews
]
```

**Helper Function Return Examples:**

`seo_get_page_reviews(123)` returns:
```php
[
    ['reviewer_name' => 'Sarah Johnson', 'rating' => '5.0', ...],
    ['reviewer_name' => 'Michael Chen', 'rating' => '4.5', ...],
]
```

`seo_format_review_rating(4.5)` returns:
```html
<span class="seo-review-stars">⭐⭐⭐⭐<span class="half-star">⭐</span></span>
```

`seo_get_review_avatar('https://...', 64)` returns:
```html
<img src="https://..." alt="Reviewer avatar" width="64" height="64" class="seo-review-avatar">
```

[Source: Epic 9 - Story 9.4 Requirements]

### Plugin Architecture & Patterns

**Service Integration Pattern**
Page generation service calls review fetch service [Source: architecture.md#Service Layer]:
- ContentGenerationService = high-level orchestrator
- ReviewFetchService = data provider
- Loose coupling via service methods (not tight dependencies)

**Post Meta Storage**
WordPress post meta stores structured data [Source: WordPress Codex]:
- Key: `_seo_reviews_data` (leading underscore = hidden from custom fields UI)
- Value: JSON-encoded array
- Retrieved with `get_post_meta($post_id, '_seo_reviews_data', true)`

**Helper Functions**
Global functions simplify template development [Source: architecture.md#Helper Functions]:
- Prefix: `seo_` to avoid naming conflicts
- Located in `includes/functions.php`
- Available in all templates and blocks

### File Locations

Based on Unified Project Structure [Source: architecture.md#Unified Project Structure]:

**PHP Classes:**
- Update: `includes/Services/ContentGenerationService.php`
- Update: `includes/functions.php` (add helper functions)

**Documentation:**
- New: `docs/review-block-integration.md`

**Tests:**
- New: `tests/php/Integration/ReviewBlockIntegrationTest.php`

### Component Specifications

**ContentGenerationService Updates**
Location: `includes/Services/ContentGenerationService.php`

```php
<?php
namespace SEOGenerator\Services;

class ContentGenerationService {

    // ... existing code ...

    /**
     * Check if page includes review block in block order
     *
     * @param int $post_id Post ID
     * @return bool True if review block present
     */
    private function hasReviewBlock(int $post_id): bool {
        $block_order = $this->getBlockOrder($post_id);
        return in_array('review_section', $block_order);
    }

    /**
     * Generate all blocks for a page (existing method - UPDATE)
     */
    public function generateAllBlocks(int $post_id): BulkGenerationResult {
        // ... existing code ...

        // Check if review block present
        if ($this->hasReviewBlock($post_id)) {
            error_log('[Review Integration] Review block detected in generation plan');
        }

        // ... existing block generation loop ...
    }

    /**
     * Generate single block (existing method - ADD CASE)
     */
    public function generateBlock(int $post_id, string $block_type): BlockGenerationResult {
        // ... existing switch statement ...

        switch ($block_type) {
            // ... existing cases ...

            case 'review_section':
                return $this->generateReviewBlock($post_id);

            // ... existing cases ...
        }
    }

    /**
     * Generate review block by fetching and storing review data
     *
     * @param int $post_id Post ID
     * @return BlockGenerationResult Generation result
     */
    private function generateReviewBlock(int $post_id): BlockGenerationResult {
        $start_time = microtime(true);

        error_log('[Review Integration] Fetching reviews for post ' . $post_id);

        // Get review fetch service
        $reviewService = \SEOGenerator\Plugin::getReviewFetchService();

        // Fetch top 5 reviews (cached or fresh from API)
        $reviews = $reviewService->getReviews(5);

        // Store in post meta
        update_post_meta($post_id, '_seo_reviews_data', wp_json_encode($reviews));

        $review_count = count($reviews);
        error_log(sprintf('[Review Integration] Stored %d reviews for post %d', $review_count, $post_id));

        $elapsed = microtime(true) - $start_time;

        return new BlockGenerationResult(
            'review_section',
            true,
            $review_count > 0 ? 'success' : 'empty',
            sprintf('%d reviews stored', $review_count),
            $elapsed
        );
    }
}
```

**Helper Functions**
Location: `includes/functions.php`

```php
<?php

if (!function_exists('seo_get_page_reviews')) {
    /**
     * Get reviews for a page
     *
     * Retrieves reviews stored in post meta during page generation.
     *
     * @param int $post_id Post ID
     * @return array Array of review data (empty if no reviews)
     *
     * @example
     * ```php
     * $reviews = seo_get_page_reviews(get_the_ID());
     * foreach ($reviews as $review) {
     *     echo '<p>' . esc_html($review['reviewer_name']) . ': ' . esc_html($review['review_text']) . '</p>';
     * }
     * ```
     */
    function seo_get_page_reviews(int $post_id): array {
        $json = get_post_meta($post_id, '_seo_reviews_data', true);

        if (empty($json)) {
            return [];
        }

        $reviews = json_decode($json, true);

        return is_array($reviews) ? $reviews : [];
    }
}

if (!function_exists('seo_format_review_rating')) {
    /**
     * Format review rating as star HTML
     *
     * Converts numeric rating (1.0-5.0) to star emoji/HTML display.
     *
     * @param float $rating Rating value (1.0 to 5.0)
     * @return string HTML string with star emojis
     *
     * @example
     * ```php
     * echo seo_format_review_rating(4.5); // ⭐⭐⭐⭐☆
     * echo seo_format_review_rating(5.0); // ⭐⭐⭐⭐⭐
     * ```
     */
    function seo_format_review_rating(float $rating): string {
        $full_stars = floor($rating);
        $half_star = ($rating - $full_stars) >= 0.5;
        $empty_stars = 5 - $full_stars - ($half_star ? 1 : 0);

        $html = '<span class="seo-review-stars" aria-label="' . esc_attr($rating . ' out of 5 stars') . '">';

        // Full stars
        for ($i = 0; $i < $full_stars; $i++) {
            $html .= '⭐';
        }

        // Half star
        if ($half_star) {
            $html .= '<span class="half-star">⭐</span>';
        }

        // Empty stars
        for ($i = 0; $i < $empty_stars; $i++) {
            $html .= '☆';
        }

        $html .= '</span>';

        return $html;
    }
}

if (!function_exists('seo_get_review_avatar')) {
    /**
     * Get review avatar HTML
     *
     * Returns img tag for reviewer avatar with fallback to default avatar.
     *
     * @param string $url Avatar URL (can be empty)
     * @param int $size Avatar size in pixels (default: 64)
     * @return string HTML img tag
     *
     * @example
     * ```php
     * echo seo_get_review_avatar($review['reviewer_avatar_url'], 80);
     * // <img src="https://..." alt="Reviewer avatar" width="80" height="80" class="seo-review-avatar">
     * ```
     */
    function seo_get_review_avatar(string $url, int $size = 64): string {
        // Use default avatar if URL empty
        if (empty($url)) {
            $url = get_avatar_url(0, ['size' => $size, 'default' => 'mystery']);
        }

        return sprintf(
            '<img src="%s" alt="%s" width="%d" height="%d" class="seo-review-avatar" loading="lazy">',
            esc_url($url),
            esc_attr__('Reviewer avatar', 'seo-generator'),
            $size,
            $size
        );
    }
}
```

**Integration Documentation**
Location: `docs/review-block-integration.md`

```markdown
# Review Block Integration Guide

This guide explains how to use review data in your review block template.

## Overview

When a page is generated with a review block, the plugin automatically:
1. Fetches reviews from Google Business Profile (cached for 30 days)
2. Stores top 5 reviews in post meta: `_seo_reviews_data`
3. Makes reviews available via helper functions

## Review Data Structure

Each review contains:

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `id` | int | Database ID | `123` |
| `source` | string | Platform (always 'google' for now) | `'google'` |
| `external_review_id` | string | Google's review ID | `'ChZDSUhN...'` |
| `reviewer_name` | string | Reviewer's display name | `'Sarah Johnson'` |
| `reviewer_avatar_url` | string | Avatar image URL (can be empty) | `'https://...'` |
| `rating` | string | Rating as decimal string | `'5.0'`, `'4.5'` |
| `review_text` | string | Review comment (can be empty) | `'Excellent service!'` |
| `review_date` | string | Review date (MySQL datetime) | `'2025-09-20 10:30:00'` |

## Helper Functions

### seo_get_page_reviews()

Retrieves reviews for a page.

**Signature:**
```php
function seo_get_page_reviews(int $post_id): array
```

**Example:**
```php
$reviews = seo_get_page_reviews(get_the_ID());

if (empty($reviews)) {
    echo '<p>No reviews available yet.</p>';
} else {
    foreach ($reviews as $review) {
        echo '<div class="review">';
        echo '<h4>' . esc_html($review['reviewer_name']) . '</h4>';
        echo '<p>' . esc_html($review['review_text']) . '</p>';
        echo '</div>';
    }
}
```

### seo_format_review_rating()

Formats rating as star emojis.

**Signature:**
```php
function seo_format_review_rating(float $rating): string
```

**Example:**
```php
$rating = (float) $review['rating'];
echo seo_format_review_rating($rating); // ⭐⭐⭐⭐⭐
```

### seo_get_review_avatar()

Returns avatar image HTML.

**Signature:**
```php
function seo_get_review_avatar(string $url, int $size = 64): string
```

**Example:**
```php
echo seo_get_review_avatar($review['reviewer_avatar_url'], 80);
// <img src="..." alt="Reviewer avatar" width="80" height="80">
```

## Sample Block Template

```php
<?php
// Get reviews for current page
$reviews = seo_get_page_reviews(get_the_ID());

if (empty($reviews)) {
    // Empty state
    echo '<div class="review-section-empty">';
    echo '<p>No customer reviews available yet. Check back soon!</p>';
    echo '</div>';
    return;
}
?>

<div class="review-section">
    <h2>Customer Reviews</h2>

    <div class="review-grid">
        <?php foreach ($reviews as $review): ?>
            <div class="review-card">
                <div class="review-header">
                    <?php echo seo_get_review_avatar($review['reviewer_avatar_url'], 64); ?>
                    <div class="review-meta">
                        <h4 class="reviewer-name"><?php echo esc_html($review['reviewer_name']); ?></h4>
                        <div class="review-rating">
                            <?php echo seo_format_review_rating((float) $review['rating']); ?>
                        </div>
                        <time datetime="<?php echo esc_attr($review['review_date']); ?>">
                            <?php echo esc_html(date('F j, Y', strtotime($review['review_date']))); ?>
                        </time>
                    </div>
                </div>

                <?php if (!empty($review['review_text'])): ?>
                    <div class="review-text">
                        <p><?php echo esc_html($review['review_text']); ?></p>
                    </div>
                <?php endif; ?>

                <div class="review-source">
                    <span class="google-badge">Google Review</span>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
</div>
```

## Handling Empty Reviews

Always check if reviews array is empty before rendering:

```php
$reviews = seo_get_page_reviews(get_the_ID());

if (empty($reviews)) {
    // Show placeholder or hide block
    return;
}
```

## Troubleshooting

**No reviews showing?**
- Check `wp-content/debug.log` for "[Review Integration]" entries
- Verify post meta exists: `get_post_meta($post_id, '_seo_reviews_data', true)`
- Confirm review block in generation plan (block order)

**Reviews not updating?**
- Reviews cached for 30 days (by design)
- Force refresh: regenerate page content
- Check Google API credentials in `GoogleBusinessService.php`

## API Rate Limits

Reviews are cached for 30 days to conserve Google API quota. Fresh reviews only fetched when:
- Cache is empty (first generation)
- Cache is stale (> 30 days old)
- Page is regenerated

This prevents hitting Google's rate limits during normal operation.
```

[Source: Epic 9 - Story 9.4 Requirements + Block Developer Needs]

### API Specifications

**Helper Function APIs:**

1. **seo_get_page_reviews(int $post_id): array**
   - Retrieves reviews from post meta
   - Returns empty array if no reviews stored
   - Never returns null (always array)

2. **seo_format_review_rating(float $rating): string**
   - Converts 1.0-5.0 to star HTML
   - Supports half stars (4.5 shows 4 full + 1 half)
   - Returns accessible HTML with aria-label

3. **seo_get_review_avatar(string $url, int $size = 64): string**
   - Returns img tag with avatar
   - Falls back to WordPress default avatar if URL empty
   - Includes lazy loading attribute

### Technical Constraints

**Block Order Requirement**
- Review block must be in block order (custom or default)
- If not in order, reviews not fetched (performance optimization)
- Block order checked via `getBlockOrder()` method

**Review Count Limitation**
- Only top 5 reviews stored per page
- Limit set in `ReviewFetchService::getReviews(5)` call
- Adjustable if needed (change parameter)

**Post Meta Storage**
- Key: `_seo_reviews_data` (underscore prefix hides from custom fields UI)
- Value: JSON-encoded array (max ~10KB typically)
- Retrieved with single meta query (efficient)

**Helper Function Safety**
- All output escaped (`esc_html`, `esc_url`, `esc_attr`)
- Functions check for empty values before processing
- Never throw exceptions (return safe defaults)

### Integration Points

**Hook 1: ContentGenerationService Block Loop**
Location: `includes/Services/ContentGenerationService.php:generateAllBlocks()`

```php
// Before block loop
if ($this->hasReviewBlock($post_id)) {
    // Reviews will be fetched during block generation
}

// In block loop
foreach ($block_order as $block_type) {
    if ($block_type === 'review_section') {
        $this->generateBlock($post_id, 'review_section');
    }
}
```

**Hook 2: Review Fetch Service Call**
Location: `ContentGenerationService::generateReviewBlock()`

```php
$reviewService = \SEOGenerator\Plugin::getReviewFetchService();
$reviews = $reviewService->getReviews(5);
```

**Hook 3: Block Template Usage**
Location: Block developer's template file

```php
$reviews = seo_get_page_reviews(get_the_ID());
// Render reviews using helper functions
```

### Project Structure Notes

The plugin follows WordPress template helper function pattern [Source: architecture.md#Helper Functions]:
- Global functions prefixed with `seo_`
- Located in `includes/functions.php`
- Available in all templates
- Well-documented with examples

Integration between services uses existing service layer pattern - no new architecture needed.

---

## Testing

### Testing Standards

**Framework:** PHPUnit 9.x with WordPress test framework [Source: architecture.md#Tech Stack - Backend Testing]

**Test Location:**
- Unit tests: `tests/php/Services/ContentGenerationServiceTest.php` (update)
- Unit tests: `tests/php/Functions/HelperFunctionsTest.php` (new)
- Integration tests: `tests/php/Integration/ReviewBlockIntegrationTest.php` (new)

**Standards:** Test both service integration and helper functions

**Coverage:** Test review fetching, storage, retrieval, and formatting

### Test Cases

**Unit Test: hasReviewBlock() Detects Review Block**
```php
public function test_has_review_block_returns_true_when_present() {
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);

    // Set block order with review_section
    update_post_meta($post_id, '_seo_block_order', wp_json_encode([
        'seo_metadata', 'hero', 'review_section', 'faqs', 'cta'
    ]));

    $service = new ContentGenerationService(...);
    $has_review = $this->callPrivateMethod($service, 'hasReviewBlock', [$post_id]);

    $this->assertTrue($has_review);
}
```

**Unit Test: hasReviewBlock() Returns False When Not Present**
```php
public function test_has_review_block_returns_false_when_absent() {
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);

    // Set block order WITHOUT review_section
    update_post_meta($post_id, '_seo_block_order', wp_json_encode([
        'seo_metadata', 'hero', 'faqs', 'cta'
    ]));

    $service = new ContentGenerationService(...);
    $has_review = $this->callPrivateMethod($service, 'hasReviewBlock', [$post_id]);

    $this->assertFalse($has_review);
}
```

**Unit Test: generateReviewBlock() Stores Reviews**
```php
public function test_generate_review_block_stores_reviews_in_post_meta() {
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);

    // Mock ReviewFetchService
    $mockReviewService = $this->createMock(ReviewFetchService::class);
    $mockReviewService->method('getReviews')->willReturn([
        ['reviewer_name' => 'John Doe', 'rating' => 5.0, ...],
        ['reviewer_name' => 'Jane Smith', 'rating' => 4.5, ...],
    ]);

    // Inject mock (or use Plugin::setReviewFetchService() if available)
    // ... inject mock ...

    $service = new ContentGenerationService(...);
    $result = $service->generateBlock($post_id, 'review_section');

    $this->assertTrue($result->success);

    // Check post meta
    $stored_json = get_post_meta($post_id, '_seo_reviews_data', true);
    $stored = json_decode($stored_json, true);

    $this->assertCount(2, $stored);
    $this->assertEquals('John Doe', $stored[0]['reviewer_name']);
}
```

**Unit Test: seo_get_page_reviews() Retrieves Reviews**
```php
public function test_seo_get_page_reviews_retrieves_stored_reviews() {
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);

    // Store test reviews
    $reviews = [
        ['reviewer_name' => 'Alice', 'rating' => 5.0],
        ['reviewer_name' => 'Bob', 'rating' => 4.0],
    ];
    update_post_meta($post_id, '_seo_reviews_data', wp_json_encode($reviews));

    // Call helper function
    $result = seo_get_page_reviews($post_id);

    $this->assertCount(2, $result);
    $this->assertEquals('Alice', $result[0]['reviewer_name']);
}
```

**Unit Test: seo_get_page_reviews() Returns Empty When No Reviews**
```php
public function test_seo_get_page_reviews_returns_empty_when_no_meta() {
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);

    $result = seo_get_page_reviews($post_id);

    $this->assertIsArray($result);
    $this->assertEmpty($result);
}
```

**Unit Test: seo_format_review_rating() Formats Stars Correctly**
```php
public function test_seo_format_review_rating_formats_full_stars() {
    $html = seo_format_review_rating(5.0);

    $this->assertStringContainsString('⭐⭐⭐⭐⭐', $html);
    $this->assertStringNotContainsString('☆', $html);
}

public function test_seo_format_review_rating_formats_half_stars() {
    $html = seo_format_review_rating(4.5);

    $this->assertStringContainsString('⭐⭐⭐⭐', $html);
    $this->assertStringContainsString('half-star', $html);
}

public function test_seo_format_review_rating_includes_aria_label() {
    $html = seo_format_review_rating(4.0);

    $this->assertStringContainsString('aria-label="4 out of 5 stars"', $html);
}
```

**Unit Test: seo_get_review_avatar() Returns Avatar HTML**
```php
public function test_seo_get_review_avatar_returns_img_tag() {
    $url = 'https://example.com/avatar.jpg';

    $html = seo_get_review_avatar($url, 80);

    $this->assertStringContainsString('<img', $html);
    $this->assertStringContainsString('src="' . $url . '"', $html);
    $this->assertStringContainsString('width="80"', $html);
    $this->assertStringContainsString('height="80"', $html);
}

public function test_seo_get_review_avatar_uses_default_when_empty() {
    $html = seo_get_review_avatar('', 64);

    $this->assertStringContainsString('<img', $html);
    // Should contain WordPress default avatar URL
}
```

**Integration Test: Full Page Generation with Review Block**
```php
public function test_full_page_generation_with_review_block() {
    // Create page with review block in order
    $post_id = $this->factory->post->create(['post_type' => 'seo-page']);
    update_post_meta($post_id, '_seo_block_order', wp_json_encode([
        'seo_metadata', 'hero', 'review_section', 'cta'
    ]));

    // Mock review data (or use real ReviewRepository with test data)
    // ...

    // Generate all blocks
    $service = new ContentGenerationService(...);
    $result = $service->generateAllBlocks($post_id);

    // Verify reviews stored
    $reviews = seo_get_page_reviews($post_id);
    $this->assertNotEmpty($reviews);

    // Verify helper functions work
    $rating_html = seo_format_review_rating((float) $reviews[0]['rating']);
    $this->assertNotEmpty($rating_html);
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after testing*
