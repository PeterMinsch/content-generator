# Story 10.3: Integrate Real-Time Preview Updates with Block Ordering

**Epic:** 10 - Live Block Preview
**Status:** Draft

---

## Story

**As a** content manager,
**I want** the preview to update automatically when I reorder or remove blocks,
**so that** I see immediate visual feedback on my layout changes

---

## Acceptance Criteria

1. **Event Integration:**
   - Preview updates on SortableJS `onEnd` event (after drag-drop)
   - Preview updates on block removal (click X button)
   - Preview updates on reset button click
   - Initial preview renders on page load

2. **Update Performance:**
   - Preview updates within 100ms of user action
   - No visible lag or flickering
   - Smooth rendering (no flash of empty content)
   - Debouncing if necessary for rapid changes

3. **Block Order Synchronization:**
   - Preview reflects exact order of blocks in ordering panel
   - Removed blocks disappear from preview immediately
   - Reset synchronizes both panels to default state
   - Block order detection works correctly (only non-removed blocks)

4. **Initial Load:**
   - Preview renders initial block order on page load
   - Default block order displayed (all 12 blocks)
   - Preview ready state indicated in console log

5. **Edge Cases:**
   - Preview handles zero blocks (shows empty state message)
   - Preview handles all 12 blocks enabled
   - Preview handles rapid reordering (debounced if needed)
   - Preview recovers gracefully from errors

---

## Tasks / Subtasks

- [ ] **Task 1: Add getCurrentBlockOrder() Helper Function** (AC: 3)
  - [ ] Create `getCurrentBlockOrder()` function in `BlockOrderingManager` class
  - [ ] Function reads current block order from DOM
  - [ ] Filters out removed blocks (no longer in DOM after Story 10.1's removeBlock)
  - [ ] Returns array of block type strings
  - [ ] Test function returns correct order

- [ ] **Task 2: Integrate Preview Update on Drag-Drop** (AC: 1, 2)
  - [ ] Modify `initSortable()` method in BlockOrderingManager
  - [ ] Add preview update call to SortableJS `onEnd` event
  - [ ] Call `window.blockPreviewManager.updatePreview(getCurrentBlockOrder())`
  - [ ] Verify preview updates immediately after drag ends
  - [ ] Test with multiple reorderings

- [ ] **Task 3: Integrate Preview Update on Block Removal** (AC: 1, 2)
  - [ ] Modify `removeBlock()` method in BlockOrderingManager
  - [ ] Add preview update call after block removal animation completes
  - [ ] Call preview update in setTimeout after 300ms (animation duration)
  - [ ] Verify removed block disappears from preview
  - [ ] Test removing multiple blocks

- [ ] **Task 4: Integrate Preview Update on Reset** (AC: 1, 3)
  - [ ] Modify `resetToDefaultOrder()` method in BlockOrderingManager
  - [ ] Add preview update call after sort completes
  - [ ] Call `window.blockPreviewManager.updatePreview(this.defaultOrder)`
  - [ ] Verify preview resets to default block order
  - [ ] Test reset functionality multiple times

- [ ] **Task 5: Add Initial Preview Render** (AC: 4)
  - [ ] Add initial preview update in BlockOrderingManager constructor
  - [ ] Call `triggerInitialPreview()` after sortable initialized
  - [ ] Method calls `updatePreview()` with current block order
  - [ ] Only trigger if blockPreviewManager exists
  - [ ] Verify preview shows default blocks on page load

- [ ] **Task 6: Add Null Check Guards** (AC: 5)
  - [ ] Add null check for `window.blockPreviewManager` before all updates
  - [ ] Log warning if preview manager not available
  - [ ] Gracefully skip preview updates if manager missing
  - [ ] Verify no errors if preview iframe fails to load

- [ ] **Task 7: Optimize Performance with Debouncing (Optional)** (AC: 2)
  - [ ] Test rapid reordering (10+ drags quickly)
  - [ ] If lag detected, implement debounce utility function
  - [ ] Debounce preview updates with 50ms delay
  - [ ] Test performance improvement
  - [ ] Document debouncing decision

- [ ] **Task 8: Add Console Logging for Debugging** (AC: 4)
  - [ ] Add log when preview updates triggered: `[Block Ordering] Updating preview with X blocks`
  - [ ] Log block order array being sent to preview
  - [ ] Add log if preview manager not available
  - [ ] Verify logs appear correctly during interactions

- [ ] **Task 9: Testing** (AC: All)
  - [ ] Manual test: Load page, verify initial preview renders
  - [ ] Manual test: Drag-drop blocks, verify preview updates
  - [ ] Manual test: Remove blocks, verify preview updates
  - [ ] Manual test: Reset blocks, verify preview resets
  - [ ] Manual test: Remove all blocks, verify empty state shows
  - [ ] Performance test: Rapid reordering (10+ times)
  - [ ] Browser test: Chrome, Firefox, Edge
  - [ ] Verify no console errors

---

## Dev Notes

### Feature Context

This story brings together Stories 10.1 (preview infrastructure) and 10.2 (block templates) by wiring up the real-time event integration. When users interact with the block ordering interface (drag-drop, remove, reset), the preview immediately updates to reflect the new layout.

**Key Goal:** Create a seamless, responsive connection between user actions and visual feedback with <100ms update latency.

### Previous Story Insights

From Story 10.1 (Split-Pane Layout and Preview Infrastructure):
- `BlockPreviewManager` class created with `updatePreview(blockOrder)` method
- Preview manager instance available globally as `window.blockPreviewManager`
- `updatePreview()` accepts array of block type strings [Source: Story 10.1]
- Preview shows empty state when block order is empty array [Source: Story 10.1]

From Story 10.2 (Create Block HTML Templates for Preview):
- `getBlockTemplate(blockType)` function returns HTML for each block
- All 12 block templates created with jewelry-themed content [Source: Story 10.2]
- Templates automatically used by `updatePreview()` method [Source: Story 10.2]

From Existing block-ordering.js:
- `BlockOrderingManager` class handles all drag-drop logic [Source: block-ordering.js]
- SortableJS initialized in `initSortable()` method with event handlers [Source: block-ordering.js:51-64]
- `removeBlock()` animates block removal over 300ms then removes from DOM [Source: block-ordering.js:102-146]
- `resetToDefaultOrder()` uses `sortable.sort()` to restore default [Source: block-ordering.js:174-192]
- `defaultOrder` array stored in constructor for reset [Source: block-ordering.js:29, 42-45]

### Technical Architecture

**Event Flow:**
```
User Action → SortableJS Event → BlockOrderingManager Method →
getCurrentBlockOrder() → blockPreviewManager.updatePreview() →
Preview Renders with Templates
```

**Integration Points:**
1. **onEnd Event** (drag-drop complete)
2. **removeBlock Method** (after animation)
3. **resetToDefaultOrder Method** (after sort)
4. **Constructor** (initial load)

### File Locations

**From Unified Project Structure** [Source: architecture.md#Unified Project Structure]:

**JavaScript:**
- Modify: `assets/js/src/block-ordering.js` - Add preview update calls

### Component Specifications

**getCurrentBlockOrder() Method**

Location: Add to `BlockOrderingManager` class in `assets/js/src/block-ordering.js`

```javascript
/**
 * Get current block order from DOM
 *
 * @return {Array} Array of block keys in current order (excludes removed blocks)
 */
getCurrentBlockOrder() {
    // Get all list items that are still in the DOM
    // Note: removeBlock() completely removes items from DOM after animation
    return Array.from( this.sortableList.children ).map(
        ( li ) => li.dataset.block
    );
}
```

**Key Detail:** The existing `removeBlock()` method **completely removes** the DOM element after 300ms [Source: block-ordering.js:138-140], so `getCurrentBlockOrder()` will naturally exclude removed blocks by only reading remaining children.

**Integration with onEnd Event**

Location: Modify `initSortable()` method in `assets/js/src/block-ordering.js`

```javascript
initSortable() {
    this.sortable = Sortable.create( this.sortableList, {
        animation: 150,
        handle: '.seo-sortable-handle',
        ghostClass: 'seo-sortable-ghost',
        dragClass: 'seo-sortable-drag',
        chosenClass: 'seo-sortable-chosen',
        forceFallback: true,
        onStart: () => {
            this.sortableList.classList.add( 'seo-sortable-dragging' );
        },
        onEnd: () => {
            this.sortableList.classList.remove( 'seo-sortable-dragging' );

            // NEW: Update preview after drag-drop
            this.updatePreview();
        },
    } );
}

/**
 * Update preview with current block order
 */
updatePreview() {
    if ( typeof window.blockPreviewManager === 'undefined' ) {
        console.warn( '[Block Ordering] Preview manager not available' );
        return;
    }

    const blockOrder = this.getCurrentBlockOrder();
    console.log( `[Block Ordering] Updating preview with ${blockOrder.length} blocks:`, blockOrder );

    window.blockPreviewManager.updatePreview( blockOrder );
}
```

**Integration with removeBlock Method**

Location: Modify `removeBlock()` method in `assets/js/src/block-ordering.js`

```javascript
removeBlock( listItem ) {
    // ... existing animation code ...

    // After animation completes, ACTUALLY REMOVE THE ELEMENT from DOM
    setTimeout( () => {
        // Remove the list item completely from DOM
        if ( listItem.parentNode ) {
            listItem.parentNode.removeChild( listItem );
        }
        // Remove the placeholder
        if ( placeholder.parentNode ) {
            placeholder.parentNode.removeChild( placeholder );
        }

        // NEW: Update preview after removal
        this.updatePreview();
    }, 300 );
}
```

**Integration with resetToDefaultOrder Method**

Location: Modify `resetToDefaultOrder()` method in `assets/js/src/block-ordering.js`

```javascript
resetToDefaultOrder() {
    if ( ! this.sortable || this.defaultOrder.length === 0 ) {
        return;
    }

    // Re-enable all blocks (not applicable in current implementation)
    // Existing code already handles this if needed

    // Use Sortable's sort method to reorder
    this.sortable.sort( this.defaultOrder );

    // Visual feedback
    this.sortableList.classList.add( 'seo-sortable-reset' );
    setTimeout( () => {
        this.sortableList.classList.remove( 'seo-sortable-reset' );
    }, 300 );

    // NEW: Update preview with default order
    this.updatePreview();
}
```

**Initial Preview Render**

Location: Modify `BlockOrderingManager` constructor in `assets/js/src/block-ordering.js`

```javascript
constructor() {
    this.sortableList = document.getElementById( 'sortable-blocks' );
    this.sortable = null;
    this.defaultOrder = [];

    if ( ! this.sortableList ) {
        return;
    }

    // Store default order for reset functionality
    this.storeDefaultOrder();

    // Initialize sortable
    this.initSortable();

    // Bind event listeners
    this.bindEvents();

    // NEW: Trigger initial preview render
    this.triggerInitialPreview();
}

/**
 * Trigger initial preview render on page load
 */
triggerInitialPreview() {
    // Wait for preview manager to initialize
    // It's initialized in the same DOMContentLoaded event, so use setTimeout
    setTimeout( () => {
        if ( typeof window.blockPreviewManager !== 'undefined' ) {
            console.log( '[Block Ordering] Triggering initial preview render' );
            this.updatePreview();
        }
    }, 100 );
}
```

**Alternative Approach for Initial Render:**

If timing issues occur, use a custom event:

```javascript
// In BlockPreviewManager init() after iframe loads (Story 10.1):
document.dispatchEvent( new CustomEvent( 'preview-manager-ready' ) );

// In BlockOrderingManager constructor (Story 10.3):
document.addEventListener( 'preview-manager-ready', () => {
    this.updatePreview();
} );
```

### Performance Considerations

**Update Latency:**
- Preview update is simple DOM innerHTML replacement [Source: Story 10.1]
- Template generation is string concatenation (very fast) [Source: Story 10.2]
- Expected latency: 20-50ms for 12 blocks
- Well within 100ms requirement

**Debouncing Decision:**
- Test without debouncing first
- Only add if lag detected during rapid reordering
- SortableJS `onEnd` only fires after drag completes, so frequency is naturally limited
- Unlikely to need debouncing, but code provided if needed:

```javascript
/**
 * Debounce utility
 */
debounce( func, wait ) {
    let timeout;
    return function executedFunction( ...args ) {
        const later = () => {
            clearTimeout( timeout );
            func( ...args );
        };
        clearTimeout( timeout );
        timeout = setTimeout( later, wait );
    };
}

// Usage in constructor:
this.debouncedUpdatePreview = this.debounce( this.updatePreview.bind( this ), 50 );

// Use debouncedUpdatePreview instead of updatePreview if needed
```

### Edge Case Handling

**1. Preview Manager Not Available:**
- Guard with null check: `typeof window.blockPreviewManager === 'undefined'`
- Log warning and return early
- No errors thrown, ordering still works without preview

**2. Empty Block Order:**
- `getCurrentBlockOrder()` returns empty array `[]`
- Preview manager's `updatePreview([])` shows empty state [Source: Story 10.1]
- User sees "No blocks selected" message

**3. Iframe Fails to Load:**
- Preview manager won't be created
- Null check prevents errors
- Ordering interface still fully functional

**4. Rapid Interactions:**
- SortableJS prevents drag during drag (built-in)
- Remove animation is 300ms, preventing rapid removes
- Reset has visual feedback preventing spam clicks
- Performance should be fine without debouncing

### WordPress Coding Standards

**JavaScript Standards** [Source: architecture.md#Tech Stack - Code Quality (JS)]:
- Use ES6+ arrow functions in event handlers
- Use template literals for logging
- Follow existing code style in block-ordering.js
- JSDoc comments for new methods
- Console logging for debugging (will be production-ready)

### Integration Testing Strategy

**Test Sequence:**
1. Load import settings page
2. Verify initial preview shows 12 default blocks
3. Drag block from position 1 to position 5
4. Verify preview updates with new order
5. Remove 3 blocks
6. Verify preview shows 9 blocks in correct order
7. Reset to default
8. Verify preview shows all 12 blocks in original order

**Performance Testing:**
1. Rapidly drag-drop blocks 10+ times
2. Measure console timestamps for updates
3. Verify no lag or flickering
4. Check for memory leaks in DevTools

---

## Testing

### Testing Standards

**Manual Testing** (Primary approach for interaction/integration work):
- Test all user interactions (drag, remove, reset)
- Visual inspection of preview updates
- Performance testing with rapid interactions
- Test in multiple browsers (Chrome, Firefox, Edge)

**No Automated Tests Required** for this story:
- Integration between two existing systems
- Visual/interaction testing best done manually
- Focus on user experience and performance

### Test Cases

**Functional Test: Initial Preview Render**
- [ ] Load import settings page
- [ ] Verify preview pane visible on right side
- [ ] Verify preview shows all 12 blocks in default order
- [ ] Verify console log: "[Block Ordering] Triggering initial preview render"
- [ ] Verify console log: "[Block Ordering] Updating preview with 12 blocks"

**Functional Test: Drag-Drop Updates Preview**
- [ ] Drag "Hero" block to last position
- [ ] Verify preview updates immediately (within 100ms)
- [ ] Verify Hero block now appears at bottom of preview
- [ ] Verify console log shows updated block order
- [ ] Repeat with different blocks, verify consistent behavior

**Functional Test: Remove Updates Preview**
- [ ] Click X button on "Materials" block
- [ ] Wait for fade animation (300ms)
- [ ] Verify "Materials" block disappears from preview
- [ ] Verify preview shows 11 remaining blocks
- [ ] Verify console log shows updated block order
- [ ] Remove 2 more blocks, verify preview updates each time

**Functional Test: Reset Updates Preview**
- [ ] Remove 3 blocks from ordering panel
- [ ] Drag remaining blocks into different order
- [ ] Click "Reset to Default Order" button
- [ ] Verify preview immediately shows all 12 blocks in default order
- [ ] Verify ordering panel also resets
- [ ] Verify synchronization between both panes

**Functional Test: Empty State**
- [ ] Remove all 12 blocks one by one
- [ ] Verify preview shows empty state message
- [ ] Message reads: "No blocks selected. Drag blocks from the left to see preview."
- [ ] Verify no console errors
- [ ] Reset to default, verify blocks reappear

**Performance Test: Rapid Reordering**
- [ ] Drag-drop blocks rapidly 10 times in succession
- [ ] Verify no visible lag or stuttering
- [ ] Verify preview updates smoothly each time
- [ ] Check browser DevTools Performance tab for issues
- [ ] Verify no memory leaks (heap size stable)

**Performance Test: Update Latency**
- [ ] Open browser DevTools Console
- [ ] Note timestamp before drag
- [ ] Complete drag-drop
- [ ] Note timestamp of "[Block Ordering] Updating preview" log
- [ ] Calculate delta - should be < 100ms
- [ ] Repeat with remove and reset operations

**Edge Case Test: Preview Manager Missing**
- [ ] Temporarily comment out BlockPreviewManager initialization
- [ ] Reload page
- [ ] Verify console warning: "[Block Ordering] Preview manager not available"
- [ ] Verify drag-drop still works (no errors)
- [ ] Verify remove still works (no errors)
- [ ] Verify reset still works (no errors)
- [ ] Restore BlockPreviewManager initialization

**Browser Compatibility Test:**
- [ ] Chrome 90+: All interactions work, preview updates
- [ ] Firefox 88+: All interactions work, preview updates
- [ ] Edge 90+: All interactions work, preview updates

**Console Test:**
- [ ] No JavaScript errors during any interaction
- [ ] Appropriate log messages appear for each action
- [ ] Block order arrays logged correctly

**Integration Test: Full Workflow**
- [ ] Load import settings page
- [ ] Verify initial preview with 12 blocks
- [ ] Remove "Comparison", "Size & Fit", "Ethics" blocks
- [ ] Verify preview shows 9 blocks
- [ ] Drag "FAQs" to position 2 (after Hero)
- [ ] Verify preview updates with FAQs in position 2
- [ ] Drag "CTA" to position 3
- [ ] Verify preview updates with CTA in position 3
- [ ] Reset to default order
- [ ] Verify preview shows all 12 blocks in original order
- [ ] No console errors throughout entire workflow

**Manual QA Checklist:**
- [ ] Initial preview renders on page load
- [ ] Preview updates immediately on drag-drop (<100ms)
- [ ] Preview updates immediately on block removal
- [ ] Preview updates immediately on reset
- [ ] Empty state shows when no blocks selected
- [ ] All 12 blocks can be previewed
- [ ] Rapid reordering handled gracefully (no lag)
- [ ] No console errors during any interaction
- [ ] Works in Chrome, Firefox, Edge
- [ ] Performance is smooth and responsive

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation for Epic 10 | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after testing*
