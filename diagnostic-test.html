<!DOCTYPE html>
<html>
<head>
    <title>Image Matching Diagnostic Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f0f0f1;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1d2327;
            border-bottom: 2px solid #2271b1;
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
            color: #1d2327;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            margin-top: 5px;
            border: 1px solid #8c8f94;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            margin-top: 20px;
            padding: 10px 24px;
            background: #2271b1;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #135e96;
        }
        button:disabled {
            background: #8c8f94;
            cursor: not-allowed;
        }
        #results {
            margin-top: 30px;
        }
        .section {
            margin-top: 20px;
            padding: 15px;
            background: #f6f7f7;
            border-left: 4px solid #2271b1;
            border-radius: 4px;
        }
        .section h3 {
            margin-top: 0;
            color: #1d2327;
        }
        .success {
            border-left-color: #00a32a;
        }
        .warning {
            border-left-color: #dba617;
        }
        .error {
            border-left-color: #d63638;
        }
        pre {
            background: #1d2327;
            color: #f0f0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
        .stat {
            display: inline-block;
            margin-right: 20px;
            padding: 8px 16px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dcdcde;
        }
        .stat strong {
            color: #2271b1;
            font-size: 18px;
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .tag {
            background: #2271b1;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        .image-sample {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border: 1px solid #dcdcde;
            border-radius: 4px;
        }
        .image-sample img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Image Matching Diagnostic Tool</h1>
        <p>This tool helps diagnose why images aren't being auto-selected.</p>

        <form id="diagnosticForm">
            <label for="focusKeyword">
                Focus Keyword *
                <input type="text" id="focusKeyword" name="focusKeyword" required
                       placeholder="e.g., platinum wedding bands" value="platinum wedding bands">
            </label>

            <label for="pageTitle">
                Page Title
                <input type="text" id="pageTitle" name="pageTitle"
                       placeholder="e.g., Platinum Wedding Rings" value="Platinum Wedding Rings">
            </label>

            <label for="topic">
                Topic
                <input type="text" id="topic" name="topic"
                       placeholder="e.g., Wedding Rings">
            </label>

            <button type="submit" id="runDiagnostic">Run Diagnostic</button>
        </form>

        <div id="results"></div>
    </div>

    <script>
        document.getElementById('diagnosticForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const button = document.getElementById('runDiagnostic');
            const resultsDiv = document.getElementById('results');

            button.disabled = true;
            button.textContent = 'Running diagnostic...';
            resultsDiv.innerHTML = '<p>Analyzing...</p>';

            try {
                const formData = {
                    focus_keyword: document.getElementById('focusKeyword').value,
                    page_title: document.getElementById('pageTitle').value,
                    topic: document.getElementById('topic').value
                };

                const response = await fetch('/wp-json/seo-generator/v1/images/diagnose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-WP-Nonce': wpApiSettings.nonce
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                } else {
                    resultsDiv.innerHTML = `<div class="section error"><h3>Error</h3><p>${data.message || 'Unknown error'}</p></div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="section error"><h3>Error</h3><p>${error.message}</p></div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Run Diagnostic';
            }
        });

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');

            let html = '<h2>Diagnostic Results</h2>';

            // Context
            html += '<div class="section">';
            html += '<h3>üìã Input Context</h3>';
            html += `<p><strong>Focus Keyword:</strong> ${data.context.focus_keyword || 'N/A'}</p>`;
            html += `<p><strong>Page Title:</strong> ${data.context.page_title || 'N/A'}</p>`;
            html += `<p><strong>Topic:</strong> ${data.context.topic || 'N/A'}</p>`;
            html += '</div>';

            // Extraction
            html += '<div class="section">';
            html += '<h3>üè∑Ô∏è Tag Extraction</h3>';
            html += `<p>The system extracted <strong>${data.extraction.tag_count}</strong> tags from your input:</p>`;
            html += '<div class="tag-list">';
            data.extraction.extracted_tags.forEach(tag => {
                html += `<span class="tag">${tag}</span>`;
            });
            html += '</div>';
            html += '</div>';

            // Library Stats
            const hasImages = data.library.total_images > 0;
            const hasTaggedImages = data.library.tagged_images > 0;
            const sectionClass = hasImages ? (hasTaggedImages ? 'success' : 'warning') : 'error';

            html += `<div class="section ${sectionClass}">`;
            html += '<h3>üìö Image Library Status</h3>';
            html += '<div>';
            html += `<div class="stat"><strong>${data.library.total_images}</strong><br>Total Images</div>`;
            html += `<div class="stat"><strong>${data.library.seo_library_images}</strong><br>SEO Library Images</div>`;
            html += `<div class="stat"><strong>${data.library.tagged_images}</strong><br>Tagged Images</div>`;
            html += '</div>';

            if (data.library.total_images === 0) {
                html += '<p style="margin-top: 15px; color: #d63638;"><strong>‚ö†Ô∏è No images found in media library!</strong> Upload some images first.</p>';
            } else if (data.library.tagged_images === 0) {
                html += '<p style="margin-top: 15px; color: #dba617;"><strong>‚ö†Ô∏è No tagged images found!</strong> You need to add tags to your images using the "image_tag" taxonomy.</p>';
            }

            html += '<p style="margin-top: 15px;"><strong>Available Tags:</strong></p>';
            if (data.library.available_tags.length > 0) {
                html += '<div class="tag-list">';
                data.library.available_tags.forEach(tag => {
                    html += `<span class="tag">${tag.name} (${tag.count})</span>`;
                });
                html += '</div>';
            } else {
                html += '<p style="color: #d63638;">No tags found! Create tags by uploading images through the SEO Generator Image Library.</p>';
            }
            html += '</div>';

            // Matching Results
            const matched = data.matching.final_match !== null;
            html += `<div class="section ${matched ? 'success' : 'error'}">`;
            html += '<h3>üéØ Matching Results</h3>';

            if (matched) {
                html += `<p style="color: #00a32a;"><strong>‚úÖ SUCCESS! Found matching image: ID ${data.matching.final_match}</strong></p>`;
                if (data.matching.final_match_url) {
                    html += `<img src="${data.matching.final_match_url}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">`;
                }
            } else {
                html += '<p style="color: #d63638;"><strong>‚ùå No matching image found</strong></p>';
            }

            // Matching attempts
            html += '<h4 style="margin-top: 20px;">Matching Attempts:</h4>';

            if (data.matching.results.all_tags) {
                const result = data.matching.results.all_tags;
                html += `<p><strong>All Tags</strong> (${result.tags.join(', ')}): Found ${result.found} images</p>`;
            }

            if (data.matching.results.first_2_tags) {
                const result = data.matching.results.first_2_tags;
                html += `<p><strong>First 2 Tags</strong> (${result.tags.join(', ')}): Found ${result.found} images</p>`;
            }

            if (data.matching.results.first_1_tag) {
                const result = data.matching.results.first_1_tag;
                html += `<p><strong>First 1 Tag</strong> (${result.tags.join(', ')}): Found ${result.found} images</p>`;
            }

            html += '</div>';

            // Sample Images
            if (data.samples && data.samples.length > 0) {
                html += '<div class="section">';
                html += '<h3>üñºÔ∏è Sample Tagged Images</h3>';
                data.samples.forEach(image => {
                    html += '<div class="image-sample">';
                    html += `<img src="${image.url}" alt="${image.title}">`;
                    html += '<div>';
                    html += `<strong>${image.title}</strong> (ID: ${image.id})<br>`;
                    html += `<small>${image.is_seo ? '‚úÖ SEO Library' : '‚ùå Not SEO Library'}</small><br>`;
                    if (image.tags.length > 0) {
                        html += '<div class="tag-list" style="margin-top: 5px;">';
                        image.tags.forEach(tag => {
                            html += `<span class="tag">${tag.name}</span>`;
                        });
                        html += '</div>';
                    } else {
                        html += '<small style="color: #d63638;">No tags</small>';
                    }
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Raw JSON
            html += '<div class="section">';
            html += '<h3>üìÑ Raw JSON Response</h3>';
            html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        // Check if wpApiSettings exists, if not create it
        if (typeof wpApiSettings === 'undefined') {
            // For testing outside WordPress admin, you'll need to manually get the nonce
            console.warn('wpApiSettings not found. Make sure you\'re logged in to WordPress admin.');
        }
    </script>
</body>
</html>
